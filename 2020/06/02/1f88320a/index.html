<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        Gacache åˆ†å¸ƒå¼ç¼“å­˜ - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TOC"><span class="toc-text">TOC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-text">æ•´ä½“æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LRU-%E9%98%9F%E5%88%97"><span class="toc-text">LRU é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-text">å¹¶å‘æ§åˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7-Hash"><span class="toc-text">ä¸€è‡´æ€§ Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%8A%82%E7%82%B9%E9%80%9A%E4%BF%A1"><span class="toc-text">åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Client-%E7%AB%AF"><span class="toc-text">Client ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-%E7%AB%AF"><span class="toc-text">Server ç«¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">ç¼“å­˜å‡»ç©¿</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-text">å¤ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">è§£å†³æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">æµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E4%BA%92%E5%A4%87"><span class="toc-text">çƒ­ç‚¹äº’å¤‡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-text">æµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">ç¼“å­˜ç©¿é€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0-1"><span class="toc-text">å¤ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="toc-text">è§£å†³æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TODO"><span class="toc-text">TODO</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Gacache åˆ†å¸ƒå¼ç¼“å­˜
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2020-06-02 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#å¼€æºé¡¹ç›®" title="å¼€æºé¡¹ç›®">å¼€æºé¡¹ç›®</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#Gacache" title="Gacache">Gacache</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="TOC"><a href="#TOC" class="headerlink" title="TOC"></a>TOC</h2><ul>
<li><a href="#toc">TOC</a></li>
<li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B">æ•´ä½“æµç¨‹</a></li>
<li><a href="#lru-%E9%98%9F%E5%88%97">LRU é˜Ÿåˆ—</a></li>
<li><a href="#%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">å¹¶å‘æ§åˆ¶</a></li>
<li><a href="#%E4%B8%80%E8%87%B4%E6%80%A7-hash">ä¸€è‡´æ€§ Hash</a><ul>
<li><a href="#%E5%AE%9E%E7%8E%B0">å®ç°</a></li>
</ul>
</li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%8A%82%E7%82%B9%E9%80%9A%E4%BF%A1">åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡</a><ul>
<li><a href="#client-%E7%AB%AF">Client ç«¯</a></li>
<li><a href="#server-%E7%AB%AF">Server ç«¯</a></li>
</ul>
</li>
<li><a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF">ç¼“å­˜å‡»ç©¿</a><ul>
<li><a href="#%E5%A4%8D%E7%8E%B0">å¤ç°</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></li>
</ul>
</li>
<li><a href="#%E7%83%AD%E7%82%B9%E4%BA%92%E5%A4%87">çƒ­ç‚¹äº’å¤‡</a><ul>
<li><a href="#%E6%80%9D%E8%B7%AF">æ€è·¯</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95-1">æµ‹è¯•</a></li>
</ul>
</li>
<li><a href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">ç¼“å­˜ç©¿é€</a><ul>
<li><a href="#%E5%A4%8D%E7%8E%B0-1">å¤ç°</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1">è§£å†³æ–¹æ¡ˆ</a></li>
</ul>
</li>
<li><a href="#todo">TODO</a></li>
</ul>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æœ¬é¡¹ç›®æ˜¯æ¨¡ä»¿ <a target="_blank" rel="noopener" href="https://github.com/golang/groupcache">groupcache</a> å®ç°çš„ä¸€ä¸ªåˆ†å¸ƒå¼ç¼“å­˜åº“ï¼Œå…¶å¯ä»¥ä½œä¸ºå•ç‹¬æœåŠ¡éƒ¨ç½²ï¼Œäº¦å¯ä»¥ä½œä¸ºä¸€ä¸ª<code>lib</code>æ¥ç”¨ï¼Œä½¿ç”¨ä¸€è‡´æ€§ Hash è¿›è¡ŒèŠ‚ç‚¹çš„é€‰å–å’Œæ•°æ®çš„åˆ†ç‰‡ï¼ŒèŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ http åè®®è¿›è¡Œé€šä¿¡ï¼Œä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">Protobuf</a> åºåˆ—åŒ–æ•°æ®è¿›è¡Œä¼ è¾“ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ï¼ŒèŠ‚ç‚¹ä¹‹é—´æ”¯æŒçƒ­ç‚¹æ•°æ®äº’å¤‡ï¼Œå‡å°‘ç½‘ç»œå¼€é”€ï¼ŒåŒæ—¶è¿˜å®ç°äº†å¹¶å‘è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Œç›¸æ¯”äºåŸé¡¹ç›®ï¼Œå¯¹çƒ­ç‚¹äº’å¤‡çš„åŠŸèƒ½è¿›è¡Œäº†å¢å¼º</p>
<blockquote>
<p>æœ¬é¡¹ç›®ä¸ºç»ƒæ‰‹é¡¹ç›®ï¼Œä¸å¯ç”¨äºç”Ÿäº§</p>
</blockquote>
<h2 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h2><p><img src="http://static.imlgw.top/blog/20200602/Glc7aMrySiqF.png?imageslim" alt="mark"></p>
<h2 id="LRU-é˜Ÿåˆ—"><a href="#LRU-é˜Ÿåˆ—" class="headerlink" title="LRU é˜Ÿåˆ—"></a>LRU é˜Ÿåˆ—</h2><p>å› ä¸ºç¼“å­˜çš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜ä¸­çš„ï¼Œå†…å­˜èµ„æºæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ç§åˆé€‚çš„ç­–ç•¥ï¼Œåœ¨å†…å­˜å¿«è¦æ»¡çš„æ—¶å€™å‰”é™¤éƒ¨åˆ†æ•°æ®ï¼Œè¿™é‡Œé€‰æ‹©äº†è¾ƒä¸ºå¹³è¡¡ä¸”å®ç°ç®€å•çš„æ–¹æ¡ˆ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡åšæ–‡ <a href="http://imlgw.top/2019/11/16/lrucache/">LRU é˜Ÿåˆ—çš„å®ç°ï¼ˆJavaï¼‰</a> è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œä»¥åŠé¿å…é‡å¤é€ è½®å­ï¼Œç›´æ¥ä½¿ç”¨<code>container</code> åŒ…ä¸­çš„<code>List</code>åŒå‘é“¾è¡¨å’Œ<code>map</code>æ¥å®ç°ï¼Œå…·ä½“ä»£ç è§ <a target="_blank" rel="noopener" href="https://github.com/imlgw/gacache/blob/master/gacache/lru/lru.go">gacache/lru/lru.go</a></p>
<h2 id="å¹¶å‘æ§åˆ¶"><a href="#å¹¶å‘æ§åˆ¶" class="headerlink" title="å¹¶å‘æ§åˆ¶"></a>å¹¶å‘æ§åˆ¶</h2><p>golang ä¸­çš„ map å¹¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„å®¹å™¨ï¼Œå¹¶å‘çš„è®¿é—®å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ é”æ¥æ§åˆ¶å¹¶å‘çš„è¯»å†™</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> cache <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu         sync.Mutex <span class="comment">//äº’æ–¥é”</span></span><br><span class="line">    lru        *lru.Cache</span><br><span class="line">    cacheBytes <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cache)</span></span> put(key <span class="type">string</span>, value ByteView) &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.lru == <span class="literal">nil</span> &#123; <span class="comment">//å°šæœªåˆå§‹åŒ–ï¼Œlazyinit</span></span><br><span class="line">        c.lru = lru.New(c.cacheBytes, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    c.lru.Put(key, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cache)</span></span> get(key <span class="type">string</span>) (value ByteView, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.lru == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> v, ok := c.lru.Get(key); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> v.(ByteView), ok</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸€è‡´æ€§-Hash"><a href="#ä¸€è‡´æ€§-Hash" class="headerlink" title="ä¸€è‡´æ€§ Hash"></a>ä¸€è‡´æ€§ Hash</h2><p>å¯¹äºä¸€ä¸ª<strong>åˆ†å¸ƒå¼ç¼“å­˜</strong>æ¥è®²ï¼Œå®¢æˆ·ç«¯åœ¨å‘æŸä¸€ä¸ªèŠ‚ç‚¹è¯·æ±‚æ•°æ®çš„æ—¶å€™ï¼Œè¯¥èŠ‚ç‚¹åº”è¯¥å¦‚ä½•å»è·å–æ•°æ®å‘¢ï¼Ÿæ˜¯è‡ªå·±æ‹¿ï¼Œè¿˜æ˜¯å»å…¶ä»–èŠ‚ç‚¹æ‹¿ï¼Ÿå¦‚æœè¿™é‡Œä¸åšå¤„ç†ï¼Œè®©å½“å‰èŠ‚ç‚¹è‡ªå·±å»æ•°æ®æºå–æ•°æ®ï¼Œé‚£ä¹ˆæœ€ç»ˆå¯èƒ½æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç¼“å­˜ä¸€ä»½æ•°æ®æºçš„æ•°æ®ï¼Œè¿™æ ·ä¸ä»…æ•ˆç‡ä½ä¸‹ï¼ˆéœ€è¦å’Œ DB äº¤äº’ï¼‰ï¼Œè€Œä¸”æµªè´¹äº†å¾ˆå¤šç©ºé—´ï¼Œä¸¥æ ¼æ¥è¯´è¿™å°±ç§°ä¸ä¸Šæ˜¯<strong>åˆ†å¸ƒå¼ç¼“å­˜</strong>äº†ï¼Œåªèƒ½ç§°ä¹‹ä¸º<strong>ç¼“å­˜é›†ç¾¤</strong></p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ¡ˆèƒ½å¤Ÿå°†<code>key</code>å’ŒèŠ‚ç‚¹å¯¹åº”èµ·æ¥ï¼Œæœ‰ä¸€ç§æ¯”è¾ƒç®€å•çš„æ–¹æ¡ˆå°±æ˜¯å°†<code>key</code>å“ˆå¸Œåå¯¹èŠ‚ç‚¹æ•°é‡å–ä½™ï¼Œè¿™æ ·æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ‰“åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™æ ·çš„æ–¹æ¡ˆæ‰©å±•æ€§å’Œå®¹é”™æ€§æ¯”è¾ƒå·®ï¼Œå¦‚æœèŠ‚ç‚¹çš„æ•°é‡å‘ç”Ÿå˜åŒ–å¯èƒ½ä¼šå¯¼è‡´å¤§é‡ç¼“å­˜çš„è¿ç§»ï¼Œä¸€ç¬é—´å¤§é‡ç¼“å­˜éƒ½å¤±æ•ˆäº†ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´ç¼“å­˜é›ªå´©ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘é‡‡ç”¨<strong>ä¸€è‡´æ€§ Hash ç®—æ³•</strong></p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><ul>
<li>æ„é€ ä¸€ä¸ª <code>0 ~ 2^32-1</code> å¤§å°çš„ç¯</li>
<li>æœåŠ¡èŠ‚ç‚¹ç»è¿‡ hash ä¹‹åå°†å®šä½åˆ°ç¯ä¸­</li>
<li>å°†<code>key</code>å“ˆå¸Œä¹‹åä¹Ÿå®šä½åˆ°è¿™ä¸ªç¯ä¸­</li>
<li>é¡ºæ—¶é’ˆæ‰¾åˆ°ç¦»<code>hash(key)</code>æœ€è¿‘çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆé€‰æ‹©çš„ç¼“å­˜èŠ‚ç‚¹</li>
<li>è€ƒè™‘åˆ°æœåŠ¡èŠ‚ç‚¹çš„ä¸ªæ•°ä»¥åŠ hash ç®—æ³•çš„é—®é¢˜å¯¼è‡´ç¯ä¸­çš„æ•°æ®åˆ†å¸ƒä¸å‡åŒ€æ—¶å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹</li>
</ul>
<p><strong>ä¸€è‡´æ€§ Hash çš„ Map</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">    hash     Hash           <span class="comment">//hash å‡½æ•°</span></span><br><span class="line">    replicas <span class="type">int</span>            <span class="comment">//è™šæ‹ŸèŠ‚ç‚¹å€æ•°</span></span><br><span class="line">    keys     []<span class="type">int</span>          <span class="comment">//èŠ‚ç‚¹çš„åœ°å€ï¼Œå®Œæ•´çš„åè®®/ip/port [eg. http://localhost:8001]</span></span><br><span class="line">    hashMap  <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span> <span class="comment">//è™šæ‹ŸèŠ‚ç‚¹å’ŒçœŸå®èŠ‚ç‚¹æ˜ å°„å…³ç³»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ æœºå™¨/èŠ‚ç‚¹çš„æ–¹æ³•</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ·»åŠ æœºå™¨/èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Add(keys ...<span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">//hashMap := make(map[string][]int, len(keys))</span></span><br><span class="line">    <span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">        <span class="comment">//æ¯å°æœºå™¨ copy æŒ‡å®šå€æ•°çš„è™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; m.replicas; i++ &#123;</span><br><span class="line">            <span class="comment">//è®¡ç®—è™šæ‹ŸèŠ‚ç‚¹çš„ hash å€¼</span></span><br><span class="line">            hash := <span class="type">int</span>(m.hash([]<span class="type">byte</span>(strconv.Itoa(i) + key)))</span><br><span class="line">            <span class="comment">//æ·»åŠ åˆ°ç¯ä¸Š</span></span><br><span class="line">            m.keys = <span class="built_in">append</span>(m.keys, hash)</span><br><span class="line">            <span class="comment">//hashMap[key] = append(hashMap[key], hash)</span></span><br><span class="line">            <span class="comment">//è®°å½•æ˜ å°„å…³ç³»</span></span><br><span class="line">            m.hashMap[hash] = key</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fmt.Println(hashMap)</span></span><br><span class="line">    <span class="comment">//ç¯ä¸Š hash å€¼è¿›è¡Œæ’åº</span></span><br><span class="line">    sort.Ints(m.keys)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Get è·å–èŠ‚ç‚¹</strong></p>
<p>å› ä¸ºæ•´ä¸ªç¯æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡äºŒåˆ†å»æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äº<code>hash(key)</code>çš„èŠ‚ç‚¹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Get(key <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(m.keys) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    hash := <span class="type">int</span>(m.hash([]<span class="type">byte</span>(key)))</span><br><span class="line">    <span class="comment">//äºŒåˆ†æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äº hash çš„èŠ‚ç‚¹ idx</span></span><br><span class="line">    idx := sort.Search(<span class="built_in">len</span>(m.keys), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> m.keys[i] &gt;= hash</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> m.hashMap[m.keys[idx%<span class="built_in">len</span>(m.keys)]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡"><a href="#åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡" class="headerlink" title="åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡"></a>åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡</h2><p>é›†ç¾¤ä¹‹é—´çš„é€šä¿¡é€šè¿‡ Http åè®®ï¼ŒåŒæ—¶é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">Protobuf</a> åºåˆ—åŒ–æ•°æ®æé«˜ä¼ è¾“æ•ˆç‡</p>
<h3 id="Client-ç«¯"><a href="#Client-ç«¯" class="headerlink" title="Client ç«¯"></a>Client ç«¯</h3><p>é€šè¿‡èŠ‚ç‚¹åœ°å€å’Œ<code>groupName</code>ä»¥åŠ<code>key</code>æ„æˆçš„åœ°å€è¯·æ±‚æ•°æ®ï¼Œé€šè¿‡<code>protobuf</code>è§£ç æ•°æ®</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpGetter)</span></span> Get(in *pb.Request, out *pb.Response) <span class="type">error</span> &#123;</span><br><span class="line">    u := fmt.Sprintf(</span><br><span class="line">        <span class="string">&quot;%v%v/%v&quot;</span>,</span><br><span class="line">        h.baseURL,</span><br><span class="line">        url.QueryEscape(in.GetGroup()),</span><br><span class="line">        url.QueryEscape(in.GetKey()),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//é€šè¿‡ http è¯·æ±‚è¿œç¨‹èŠ‚ç‚¹çš„æ•°æ®</span></span><br><span class="line">    res, err := http.Get(u)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> res.Body.Close()</span><br><span class="line">    <span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;server returned: %v&quot;</span>, res.Status)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è½¬æ¢æˆ []byte</span></span><br><span class="line">    bytes, err := ioutil.ReadAll(res.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;reading response body: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è§£ç  proto å¹¶å°†ç»“æœå­˜åˆ° out ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> err != proto.Unmarshal(bytes, out) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;decoding response body : %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Server-ç«¯"><a href="#Server-ç«¯" class="headerlink" title="Server ç«¯"></a>Server ç«¯</h3><p>å®ç°<code>http.Handler</code>æ¥å£ï¼Œå¯¹ç¼“å­˜ä¸­å…¶ä»–èŠ‚ç‚¹æš´éœ²åœ°å€ï¼Œæä¾›æœåŠ¡</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *HTTPPool)</span></span> ServeHTTP(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">    <span class="keyword">if</span> !strings.HasPrefix(req.URL.Path, p.basePath) &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;HTTPPool serving unexpect path&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    p.Log(<span class="string">&quot;%s %s&quot;</span>, req.Method, req.URL.Path)</span><br><span class="line">    <span class="comment">// basePath/groupName/key</span></span><br><span class="line">    <span class="comment">// ä»¥â€˜/â€™ä¸ºç•Œé™å°† groupName å’Œ key åˆ’åˆ†ä¸º 2 ä¸ª part</span></span><br><span class="line">    parts := strings.SplitN(req.URL.Path[<span class="built_in">len</span>(p.basePath):], <span class="string">&quot;/&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> &#123;</span><br><span class="line">        http.Error(w, <span class="string">&quot;bad request&quot;</span>, http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    groupName := parts[<span class="number">0</span>]</span><br><span class="line">    key := parts[<span class="number">1</span>]</span><br><span class="line">    group := GetGroup(groupName)</span><br><span class="line">    <span class="keyword">if</span> group == <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, <span class="string">&quot;no such group: &quot;</span>+groupName, http.StatusNotFound)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    view, err := group.Get(key)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä½¿ç”¨ proto ç¼–ç  Http å“åº”</span></span><br><span class="line">    body, err := proto.Marshal(&amp;pb.Response&#123;Value: view.ByteSlice()&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>)</span><br><span class="line">    w.Write(body)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h2><p>ä¸€ä¸ªå­˜åœ¨çš„<code>key</code>çªç„¶å¤±æ•ˆï¼Œåœ¨å¤±æ•ˆçš„åŒæ—¶æœ‰å¤§é‡çš„è¯·æ±‚æ¥è¯·æ±‚è¿™ä¸ª<code>key</code>ï¼Œè¿™ä¸ªæ—¶å€™å¤§é‡è¯·æ±‚å°±ä¼šç›´æ¥æ‰“åˆ° DBï¼Œå¯¼è‡´ DB å‹åŠ›å˜å¤§ï¼Œç”šè‡³å®•æœº</p>
<h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>è¿™é‡Œç®€å•çš„æ¼”ç¤ºç¼“å­˜å‡»ç©¿çš„æ•ˆæœï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢çš„è„šæœ¬å¯åŠ¨ 4 ä¸ª<code>cache server</code> å¹¶ä¸”åœ¨ç«¯å£å·ä¸º<code>8004</code>çš„<code>server</code>ä¸Šå¯åŠ¨ä¸€ä¸ªå‰ç«¯æœåŠ¡ï¼Œç”¨äºå’Œå®¢æˆ·ç«¯äº¤äº’</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">start go run .  -port=8001</span><br><span class="line">start go run .  -port=8002</span><br><span class="line">start go run .  -port=8003</span><br><span class="line">start go run .  -port=8004 -api=1</span><br></pre></td></tr></table></figure>

<p>(windows å¹³å°çš„ batï¼Œå…¶ä»–å¹³å°å¯ä»¥ç”¨è¿™ä¸ª <a target="_blank" rel="noopener" href="https://github.com/imlgw/gacache/blob/master/test.sh">test.sh</a>)</p>
<p>å°è¯•äº†ç”¨ window çš„æ‰¹å¤„ç†å†™å¹¶å‘è®¿é—®çš„è„šæœ¬ï¼Œä½†æ˜¯æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥ç›´æ¥ç”¨<code>go</code>å†™äº†ä¸ªå°è„šæœ¬æµ‹è¯•å¹¶å‘è¯·æ±‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> curl(<span class="string">&quot;resolmi&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;Done!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">curl</span><span class="params">(key <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    res, _ := http.Get(<span class="string">&quot;http://localhost:9999/api?key=&quot;</span> + key)</span><br><span class="line">    bytes, _ := ioutil.ReadAll(res.Body)</span><br><span class="line">    fmt.Println(<span class="type">string</span>(bytes))</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ 5 ä¸ª<code>goroutine</code>ï¼Œå¹¶å‘çš„å»è¯·æ±‚<code>resolmi</code>ï¼Œæ­¤æ—¶<code>cache</code>è‚¯å®šæ˜¯æ²¡æœ‰è¿™ä¸ª key çš„ï¼Œæ‰€ä»¥éœ€è¦åˆ° DB ä¸­å»å–</p>
<p>ç„¶åå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æƒ…å†µï¼š</p>
<p><img src="http://static.imlgw.top/blog/20200529/pU2omvLdDqyQ.png?imageslim" alt="mark"></p>
<p>å‰å°<code>Server</code>æ”¶åˆ°äº† Get â€œresolmiâ€è¯·æ±‚ï¼Œé€šè¿‡ä¸€è‡´æ€§ Hash é€‰æ‹©äº†è¿œç¨‹èŠ‚ç‚¹<code>port:8003</code></p>
<p><img src="http://static.imlgw.top/blog/20200529/uovtpKufQME4.png?imageslim" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ5 æ¬¡è¯·æ±‚å…¨éƒ¨æ‰“åˆ°äº†<code>SlowDB</code>ä¸­ï¼ï¼è¿™å°±è¯´æ˜å‘ç”Ÿäº†ç¼“å­˜ç©¿é€ï¼è¯·æ±‚ç©¿è¿‡äº†ç¼“å­˜å±‚ï¼Œæ‰“åˆ° DB</p>
<blockquote>
<p>è¿™é‡Œå¦‚æœæ•ˆæœä¸æ˜æ˜¾å¯ä»¥å°è¯•åœ¨<code>load</code>å‡½æ•°æ‰§è¡Œå‰åŠ ä¸Šä¸€ä¸ª<code>time.Sleep</code>ï¼Œè¿™æ ·å¹¶å‘ç¼“å­˜å‡»ç©¿æ•ˆæœä¼šæ›´æ˜æ˜¾</p>
</blockquote>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>å…¶å®å¸¸è§çš„æ–¹æ¡ˆå°±ä¸¤ç§ï¼š</p>
<p><strong>1. ç¼“å­˜æ°¸ä¸è¿‡æœŸ</strong></p>
<p>ç¼“å­˜å€¼ä¸è®¾ç½®<code>ttl</code>ï¼Œè€Œæ˜¯åœ¨<code>value</code>ä¸­æ·»åŠ ä¸€ä¸ªé€»è¾‘çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·è¯·æ±‚å°±ä¸ä¼šç›´æ¥ç©¿é€åˆ° DBï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å½“å‰æ—¶é—´åˆ¤æ–­è¯¥ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†å°±å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹å»æ›´æ–°ç¼“å­˜ï¼Œè¿™ç§æ–¹å¼ç”¨æˆ·å»¶è¿Ÿæ˜¯æœ€ä½çš„ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆç¼“å­˜çš„ä¸ä¸€è‡´</p>
<p><strong>2. äº’æ–¥é”</strong></p>
<p>åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚è·å–æ•°æ®çš„æ—¶å€™è®¾ç½®ä¸€ä¸ª<code>mutex</code>äº’æ–¥é”ï¼Œè®©å…¶ä»–è¯·æ±‚é˜»å¡ï¼Œå½“å‰ç¬¬ä¸€ä¸ªè¯·æ±‚è¯·æ±‚åˆ°æ•°æ®è¿”å›ä¹‹åé‡Šæ”¾<code>mutex</code>é”ï¼Œå…¶ä»–è¯·æ±‚åœæ­¢é˜»å¡ï¼Œç„¶åç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ•°æ®</p>
<p>å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®æœ¬èº«æ˜¯ä¸æ”¯æŒ<code>ttl</code>å’Œåˆ é™¤æ“ä½œçš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ç§æ–¹æ¡ˆä¸å¤ªé€‚åˆï¼Œæ‰€ä»¥é‡‡ç”¨ç¬¬äºŒç§äº’æ–¥é”çš„æ–¹æ¡ˆï¼Œå®ç°äº†ä¸€ä¸ª<code>singleflight</code>ç»“æ„æ¥å¤„ç†ç¼“å­˜å‡»ç©¿</p>
<p><strong>å°è£…è¯·æ±‚ call</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°è£…æ¯ä¸ªè¯·æ±‚/è°ƒç”¨</span></span><br><span class="line"><span class="keyword">type</span> call <span class="keyword">struct</span> &#123;</span><br><span class="line">    wg  sync.WaitGroup</span><br><span class="line">    val <span class="keyword">interface</span>&#123;&#125; <span class="comment">//è¯·æ±‚çš„å€¼</span></span><br><span class="line">    err <span class="type">error</span>       <span class="comment">//err</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//singleflight æ ¸å¿ƒç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> Group <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu sync.Mutex</span><br><span class="line">    m  <span class="keyword">map</span>[<span class="type">string</span>]*call <span class="comment">//key ä¸ call çš„æ˜ å°„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¹¶å‘æ§åˆ¶æ ¸å¿ƒä»£ç </strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å¹¶å‘è¯·æ±‚æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span></span> Do(key <span class="type">string</span>, fn <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">    g.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> g.m == <span class="literal">nil</span> &#123;</span><br><span class="line">        g.m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*call)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c, ok := g.m[key]; ok &#123;</span><br><span class="line">        g.mu.Unlock() <span class="comment">//é‡Šæ”¾é”ï¼ŒæŒ‰é¡ºåºè¿›æ¥</span></span><br><span class="line">        c.wg.Wait()   <span class="comment">//ç­‰ç€ï¼Œç­‰ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆ</span></span><br><span class="line">        <span class="keyword">return</span> c.val, c.err</span><br><span class="line">    &#125;</span><br><span class="line">    c := <span class="built_in">new</span>(call)</span><br><span class="line">    c.wg.Add(<span class="number">1</span>)</span><br><span class="line">    g.m[key] = c</span><br><span class="line">    g.mu.Unlock()       <span class="comment">//è¿™é‡Œé‡Šæ”¾é”ï¼Œè®©å…¶ä»–è¯·æ±‚è¿›å…¥ä¸Šé¢çš„åˆ†æ”¯ä¸­ waitï¼ˆå…¶å®åªæœ‰å¹¶å‘é‡å¤§çš„æ—¶å€™æ‰ä¼šè¿›å…¥ä¸Šé¢çš„åˆ†æ”¯ï¼‰</span></span><br><span class="line">    c.val, c.err = fn() <span class="comment">//è¯·æ±‚æ•°æ®</span></span><br><span class="line">    c.wg.Done()         <span class="comment">//è·å–åˆ°å€¼ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚ç»“æŸï¼Œå…¶ä»–è¯·æ±‚å¯ä»¥è·å–åˆ°å€¼äº†</span></span><br><span class="line">    <span class="comment">//åˆ é™¤ m ä¸­çš„ key, é¿å… key å‘ç”Ÿå˜åŒ–ï¼Œè€Œå–åˆ°çš„è¿˜æ˜¯æ—§å€¼</span></span><br><span class="line">    g.mu.Lock()</span><br><span class="line">    <span class="built_in">delete</span>(g.m, key)</span><br><span class="line">    g.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> c.val, c.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å¤šä¸ªå¹¶å‘çš„è¯·æ±‚æ¥è¯·æ±‚åŒä¸€ä¸ª<code>key</code>çš„æ—¶å€™ï¼Œåªæœ‰<strong>ç¬¬ä¸€ä¸ªè¯·æ±‚</strong>èƒ½æ‹¿åˆ°é”å» DB ä¸­å–æ•°æ®ï¼Œå…¶ä»–çš„è¯·æ±‚å°±åªèƒ½åœ¨æ–¹æ³•å¤–é˜»å¡ï¼Œå½“ç¬¬ä¸€ä¸ªè¯·æ±‚æ„é€ å¥½<code>call</code>å°±é‡Šæ”¾é”ï¼Œè¿™ä¸ªæ—¶å€™å…¶ä»–å¹¶å‘çš„è¯·æ±‚è·å–é”ï¼Œè¿›å…¥é˜»å¡çš„åˆ†æ”¯é‡Šæ”¾é”ï¼Œç„¶åå†æ¬¡é˜»å¡ï¼Œç­‰å¾…<strong>ç¬¬ä¸€ä¸ªè¯·æ±‚</strong>è·å–åˆ°æ•°æ®å¹¶å°è£…è¿›ä¸<code>key</code>å¯¹åº”çš„<code>call</code>ä¸­ï¼Œç„¶åç›´æ¥è¿”å›ï¼Œä¸å†å‘æ•°æ®åº“è¯·æ±‚ï¼Œä»è€Œé¿å…äº†ç¼“å­˜å‡»ç©¿</p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ç”¨<code>singleFlight</code>åŒ…è£…ä¸€ä¸‹æˆ‘ä»¬çš„<code>load</code>æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">view, err := g.loader.Do(key, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> g.peers != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">//æ ¹æ®ä¸€è‡´æ€§ Hash é€‰æ‹©èŠ‚ç‚¹ Peer</span></span><br><span class="line">        <span class="keyword">if</span> peer, ok := g.peers.PickPeer(key); ok &#123;</span><br><span class="line">            <span class="comment">//ä»ä¸Šé¢çš„ Peer ä¸­è·å–æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> value, err = g.getFromPeer(peer, key); err == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> value, <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            log.Println(<span class="string">&quot;[Gacache] Fail to get from remote peer!!!&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> g.getLocally(key)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡ä½¿ç”¨ä¸Šé¢åŒæ ·çš„è„šæœ¬è¿›è¡Œæµ‹è¯•</p>
<p><img src="http://static.imlgw.top/blog/20200530/OThgxtFJrFIG.png?imageslim" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ° 5 ä¸ªè¯·æ±‚éƒ½æˆåŠŸäº†ï¼Œæˆ‘ä»¬å†çœ‹çœ‹<code>log</code></p>
<p><img src="http://static.imlgw.top/blog/20200530/fsgxPPXNeVoo.png?imageslim" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¯·æ±‚äº† 5 æ¬¡ï¼Œä½†æ˜¯å®é™…ä¸Š<code>getFromPeer</code>ä»è¿œç¨‹èŠ‚ç‚¹å–æ•°æ®åªæ‰§è¡Œäº†ä¸€æ¬¡</p>
<p><img src="http://static.imlgw.top/blog/20200530/ChE0FxjwlYbl.png?imageslim" alt="mark"></p>
<p>ä»<code>SlowDB</code>çš„æŸ¥è¯¢ä¹Ÿåªæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¯´æ˜æˆ‘ä»¬çš„<code>singleFlight</code>å¹¶å‘æ§åˆ¶ç”Ÿæ•ˆäº†ï¼</p>
<h2 id="çƒ­ç‚¹äº’å¤‡"><a href="#çƒ­ç‚¹äº’å¤‡" class="headerlink" title="çƒ­ç‚¹äº’å¤‡"></a>çƒ­ç‚¹äº’å¤‡</h2><p>çƒ­ç‚¹äº’å¤‡ä¹Ÿæ˜¯<code>groupcache</code>çš„ç‰¹ç‚¹ä¹‹ä¸€ï¼Œåœ¨æºç æ³¨é‡Šä¸­å†™åˆ°</p>
<blockquote>
<p>hotCache contains keys/values for which this peer is not authoritative (otherwise they would be in <strong>mainCache</strong>), but are popular enough to warrant mirroring in this process to avoid going over the network to fetch from a peer.  Having a hotCache avoids network hotspotting, where a peerâ€™s network card could become the bottleneck on a popular key. This cache is used sparingly to maximize the total number of key/value pairs that can be stored globally.</p>
</blockquote>
<p>å¤§è‡´æ„æ€å°±æ˜¯ï¼Œ<code>hotCache</code>ä¸­å­˜å‚¨çš„ä¸»è¦æ˜¯è¯¥èŠ‚ç‚¹æ²¡æœ‰çš„é”®å€¼å¯¹ï¼ˆå¦åˆ™å°±åœ¨<code>mainCache</code>ä¸­äº†ï¼‰ï¼Œä½†æ˜¯è¿™äº›é”®å€¼å¯¹è¯·æ±‚çš„éå¸¸é¢‘ç¹ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯åœ¨æ­¤è¿‡ç¨‹ä¸­è¿›è¡Œçƒ­ç‚¹å¤‡ä»½ï¼Œé¿å…é€šè¿‡ç½‘ç»œä»è¿œç¨‹èŠ‚ç‚¹å»è·å–ï¼Œ<code>hotCache</code>é¿å…äº†ç½‘ç»œçƒ­ç‚¹ï¼Œä½¿èŠ‚ç‚¹çš„ç½‘å¡æˆä¸ºçƒ­ç‚¹<code>key</code>çš„ç“¶é¢ˆ</p>
<p>ä½†æ˜¯åœ¨<code>groupcache</code>ä¸­å¯¹<code>hotCache</code>çš„å¤„ç†åªæ˜¯éšæœºçš„å­˜å‚¨ï¼Œæ¯æ¬¡ä»è¿œç¨‹èŠ‚ç‚¹è·å–æ•°æ®çš„æ—¶å€™æœ‰ 1/10 çš„æ¦‚ç‡å­˜å‚¨åˆ°<code>hotCache</code>ä¸­ï¼ˆ<a target="_blank" rel="noopener" href="https://github.com/golang/groupcache/blob/master/groupcache.go#L318">code</a>ï¼‰</p>
<p><img src="http://static.imlgw.top/blog/20200601/A0oPStJGqht3.png?imageslim" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ª TODOï¼Œæ³¨é‡Šä¸­ä¹Ÿæåˆ°äº†å¯ä»¥ä½¿ç”¨ QPS æ¥åˆ¤æ–­æ˜¯å¦æ˜¯çƒ­ç‚¹<code>key</code>ï¼Œæ‰€ä»¥æˆ‘æŒ‰ç…§è¿™ä¸ªæƒ³æ³•å†™äº†ä¸€ä¸ªç®€å•çš„ç»Ÿè®¡</p>
<h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ª<code>hotCache</code>çš„ç»“æ„ï¼Œè¿™ä¸ª cache å’Œ<code>mainCache</code>ä¸€æ ·ï¼Œéƒ½æ˜¯å¹¶å‘å®‰å…¨çš„<code>lru</code>é˜Ÿåˆ—ï¼Œç„¶åæˆ‘ä»¬åœ¨å‘æŸä¸ªèŠ‚ç‚¹è¯·æ±‚æ•°æ®çš„æ—¶å€™å°±å¯ä»¥å…ˆä»<code>mainCache</code>ä¸­è¯·æ±‚å¦‚æœæ²¡æœ‰å°±ä»<code>hotCache</code>ä¸­è¯·æ±‚ ï¼Œå¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span></span> Get(key <span class="type">string</span>) (ByteView, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ByteView&#123;&#125;, fmt.Errorf(<span class="string">&quot;key nil&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> v, ok := g.mainCache.get(key); ok &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;[GaCache (mainCache)] hit&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> v, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//add: hotCache</span></span><br><span class="line">    <span class="keyword">if</span> v, ok := g.hotCache.get(key); ok &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;[GaCache (hotCache)] hit&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> v, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å½“å‰èŠ‚ç‚¹æ²¡æœ‰æ•°æ®ï¼Œå»å…¶ä»–åœ°æ–¹åŠ è½½</span></span><br><span class="line">    <span class="keyword">return</span> g.load(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°è£…äº†ä¸€ä¸ª<code>KeyStats</code>çš„ç»“æ„ï¼Œç”¨äºç»Ÿè®¡<code>key</code>çš„è¯·æ±‚ä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Key çš„ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">type</span> KeyStats <span class="keyword">struct</span> &#123;</span><br><span class="line">    firstGetTime time.Time <span class="comment">//ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line">    remoteCnt    AtomicInt <span class="comment">//è¯·æ±‚çš„æ¬¡æ•°ï¼ˆåˆ©ç”¨ atomic åŒ…å°è£…çš„åŸå­ç±»ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å°†<code>key</code>å’Œ<code>KeyStats</code>å¯¹åº”ï¼Œæ‰€ä»¥éœ€è¦åœ¨ cache çš„æ ¸å¿ƒç»“æ„<code>Group</code>ä¸­åŠ å…¥æ˜ å°„å…³ç³»</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Group <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    keys <span class="keyword">map</span>[<span class="type">string</span>]*KeyStats</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨èŠ‚ç‚¹è¯·æ±‚è¿œç¨‹èŠ‚ç‚¹çš„æ—¶å€™ç»Ÿè®¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯<code>getFromPeer</code>å‡½æ•°ä¸­</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»è¿œç¨‹èŠ‚ç‚¹è·å–æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span></span> getFromPeer(peer PeerGetter, key <span class="type">string</span>) (ByteView, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">//æ„å»º proto çš„ message</span></span><br><span class="line">    req := &amp;pb.Request&#123;</span><br><span class="line">        Group: g.name,</span><br><span class="line">        Key:   key,</span><br><span class="line">    &#125;</span><br><span class="line">    res := &amp;pb.Response&#123;&#125;</span><br><span class="line">    err := peer.Get(req, res)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;getFromPeer&quot;</span>, key)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ByteView&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿œç¨‹è·å– cnt++</span></span><br><span class="line">    <span class="keyword">if</span> stat, ok := g.keys[key]; ok &#123;</span><br><span class="line">        stat.remoteCnt.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//è®¡ç®— QPS</span></span><br><span class="line">        interval := <span class="type">float64</span>(time.Now().Unix()-stat.firstGetTime.Unix()) / <span class="number">60</span></span><br><span class="line">        qps := stat.remoteCnt.Get() / <span class="type">int64</span>(math.Max(<span class="number">1</span>, math.Round(interval)))</span><br><span class="line">        <span class="keyword">if</span> qps &gt;= maxMinuteRemoteQPS &#123;</span><br><span class="line">            <span class="comment">//å­˜å…¥ hotCache</span></span><br><span class="line">            g.populateCache(key, ByteView&#123;b: res.Value&#125;, &amp;g.hotCache)</span><br><span class="line">            <span class="comment">//åˆ é™¤æ˜ å°„å…³ç³»ï¼ŒèŠ‚çœå†…å­˜</span></span><br><span class="line">            mu.Lock()</span><br><span class="line">            <span class="built_in">delete</span>(g.keys, key)</span><br><span class="line">            mu.Unlock()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ¬¡è·å–</span></span><br><span class="line">        g.keys[key] = &amp;KeyStats&#123;</span><br><span class="line">            firstGetTime: time.Now(),</span><br><span class="line">            remoteCnt:    <span class="number">1</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ByteView&#123;b: res.Value&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>maxMinuteRemoteQPS</code>æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œæ¯ä¸ª key æ¯åˆ†é’Ÿè¿œç¨‹è¯·æ±‚æœ€å¤§çš„ QPSï¼Œæ¯æ¬¡å‘è¿œç¨‹èŠ‚ç‚¹è¯·æ±‚æ•°æ®çš„æ—¶å€™è®¡ç®—å½“å‰<code>key</code>ç¬¬ä¸€æ¬¡è·å–çš„æ—¶é—´åˆ°ç›®å‰ä¸ºæ­¢çš„ QPSï¼Œå¦‚æœå¤§äºé˜ˆå€¼<code>maxMinuteRemoteQPS</code>ï¼Œå°±ä¼šå°†å…¶å­˜å…¥<code>hotCache</code>ä¸­ï¼Œä¹‹åå°±å¯ä»¥ç›´æ¥ä»<code>hotCache</code>ä¸­è·å–æ•°æ®ï¼Œè€Œä¸ç”¨åœ¨é€šè¿‡ç½‘ç»œå»è·å–</p>
<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åŒæ ·ä½¿ç”¨å‰é¢çš„ go è„šæœ¬æ¥æµ‹è¯•</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//go curl(&quot;resolmi&quot;)</span></span><br><span class="line">        <span class="comment">//i not exist</span></span><br><span class="line">        <span class="comment">//go curl(strconv.Itoa(i))</span></span><br><span class="line">        time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">        curl(<span class="string">&quot;resolmi&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;Done!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">curl</span><span class="params">(key <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    res, _ := http.Get(<span class="string">&quot;http://localhost:9999/api?key=&quot;</span> + key)</span><br><span class="line">    bytes, _ := ioutil.ReadAll(res.Body)</span><br><span class="line">    fmt.Println(<span class="type">string</span>(bytes))</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„è¿™é‡Œè¯·æ±‚ä¸è¦è¯·æ±‚å¤ªå¿«ï¼Œå¦‚æœä¸€ä¸ª key è¯·æ±‚çš„å¤ªå¿«ä¼šè¢«<code>singleFlight</code>å¹¶å‘æ§åˆ¶ç»„ä»¶æ‹¦æˆªï¼Œå¤šæ•°è¯·æ±‚ä¸ä¼šèµ°ç½‘ç»œï¼ˆè¿™ä¸ªç»„ä»¶ä½œç”¨è¿˜æ˜¯æŒºå¤§çš„ï¼‰ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä½¿ç”¨<code>goroutine</code>ï¼Œè€Œæ˜¯æ­£å¸¸çš„è°ƒç”¨ï¼Œå¹¶ä¸”ä¸­é—´åœé¡¿ 0.5s</p>
</blockquote>
<p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¨¡æ‹Ÿï¼Œæˆ‘è®¾ç½®äº† <code>maxMinuteRemoteQPS = 10</code> ï¼Œä¸Šé¢çš„è„šæœ¬ä¸€åˆ†é’Ÿä¹‹å†…ä¼šè¯·æ±‚<code>â€œresolmiâ€</code> 20 æ¬¡ï¼Œè¿™ä¸ª<code>key</code>çš„åˆ†ç‰‡å·²çŸ¥æ˜¯è¿œç¨‹èŠ‚ç‚¹ï¼ˆ8003ï¼‰çš„ï¼Œæ‰€ä»¥ä¼šåœ¨ç¬¬ 10 æ¬¡çš„æ—¶å€™è§¦å‘<code>hotCache</code>ï¼Œå°†æ•°æ®å­˜å…¥å½“å‰èŠ‚ç‚¹ï¼ˆ8004ï¼‰çš„<code>hotCache</code>ä¸­ï¼Œåç»­çš„è¯·æ±‚å°±ä¼šç›´æ¥ä»<code>hotCache</code>ä¸­å–ï¼Œå¦‚ä¸‹å›¾æ‰€æ¼”ç¤º</p>
<p><img src="http://static.imlgw.top/blog/20200602/hKH8u6E1gpcA.gif" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ°æ•ˆæœç¡®å®è¾¾åˆ°äº†ï¼Œä½†æ˜¯è¿™æ ·åšæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç¼ºç‚¹å°±æ˜¯å†…å­˜è€—è´¹ä¼šæ¯”åŸæ¥å¤§ï¼Œéœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ª mapï¼Œä¸è¿‡è¿™éƒ¨åˆ†ä¿¡æ¯å¹¶ä¸å¤§ï¼Œä»…ä»…éœ€è¦å­˜å‚¨<code>key</code>å’Œå¯¹åº”<code>keyStats</code> ï¼Œkey çš„é•¿åº¦ä¸€èˆ¬ä¸ä¼šå¾ˆé•¿ï¼Œ<code>keyStats</code> çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä¸€ä¸ª<code>time</code>å’Œä¸€ä¸ª<code>int64</code>ï¼Œæ‰€ä»¥ä¸€å®šç¨‹åº¦ä¸Šè¿˜æ˜¯å¯è¡Œçš„ã€‚</p>
<blockquote>
<p>è¿™ç§æ–¹æ¡ˆåªæ˜¯æˆ‘èƒ½æƒ³åˆ°çš„ä¸€ç§æ¯”è¾ƒç®€å•çš„å¤„ç†æ–¹æ³•ï¼Œè‚¯å®šä¼šæœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼ã€‚ä½†æ˜¯æˆªè‡³ç›®å‰ï¼ˆ2020.6.2ï¼‰<code>groupcache</code>ä¸­æ²¡æœ‰å¯¹è¿™é‡Œè¿›è¡Œæ”¹è¿›ï¼Œå¦‚æœä»¥åæœ‰æ›´æ–°å¯ä»¥å†å­¦ä¹ ä¸‹</p>
</blockquote>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><p>æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œå› ä¸ºä¸å­˜åœ¨åˆ™ä¸ä¼šå†™åˆ°ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šå»è¯·æ±‚ DBï¼Œå¦‚æœç¬é—´æµé‡è¿‡å¤§ï¼Œç©¿é€åˆ° DB å°±ä¼šå¯¼è‡´å®•æœº</p>
<h3 id="å¤ç°-1"><a href="#å¤ç°-1" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>ä½¿ç”¨ä¸Šé¢çš„è„šæœ¬å†æ¬¡å¯åŠ¨<code>Cache Server</code>ï¼Œç„¶åç”¨ä¸‹é¢çš„ go ä»£ç æµ‹è¯•</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//go curl(&quot;resolmi&quot;)</span></span><br><span class="line">        <span class="comment">//i not exist</span></span><br><span class="line">        <span class="keyword">go</span>  curl(strconv.Itoa(i))</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;Done!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">curl</span><span class="params">(key <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    res, _ := http.Get(<span class="string">&quot;http://localhost:9999/api?key=&quot;</span> + key)</span><br><span class="line">    bytes, _ := ioutil.ReadAll(res.Body)</span><br><span class="line">    fmt.Println(<span class="type">string</span>(bytes))</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„è¿™é‡Œéœ€è¦æ„é€ ä¸åŒçš„ keyï¼Œç›¸åŒçš„ key ä¼šè¢«å‰é¢çš„<code>singleFlight</code>ç»„ä»¶æ‹¦æˆª</p>
</blockquote>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">[ <span class="string">`go run .`</span> | done: <span class="number">1.8734423</span>s ]</span><br><span class="line">  <span class="number">1</span> not exist</span><br><span class="line">  <span class="number">2</span> not exist</span><br><span class="line">  <span class="number">0</span> not exist</span><br><span class="line">  <span class="number">4</span> not exist</span><br><span class="line">  <span class="number">3</span> not exist</span><br><span class="line">  Done!</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬çœ‹çœ‹<code>Server</code>çš„æƒ…å†µ</p>
<p><img src="http://static.imlgw.top/blog/20200531/kV5ojfIeddm4.png?imageslim" alt="mark"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ5 ä¸ª<code>key</code>é€šè¿‡ä¸€è‡´æ€§ Hash åˆ†æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äº<code>DB</code>ä¸­æ ¹æœ¬å°±æ²¡æœ‰è¿™äº›æ•°æ®ï¼Œæ‰€ä»¥è¿™äº›æ•°æ®å¹¶ä¸ä¼šç¼“å­˜ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šåˆ°<code>DB</code>ä¸­å»é‡æ–°æŸ¥è¯¢ï¼Œå¦‚æœçŸ­æ—¶é—´å†…æœ‰å¤§é‡è¯·æ±‚æŸ¥è¯¢è¿™äº›æ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›è¯·æ±‚éƒ½ä¼šç›´æ¥æ‰“åˆ° DB å±‚ï¼Œå°† DB å±‚å‹å®ï¼</p>
<h3 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p><strong>1. ç¼“å­˜ç©ºå¯¹è±¡</strong></p>
<p>ä¹‹æ‰€ä»¥å‘ç”Ÿç¼“å­˜ç©¿é€ï¼Œæ˜¯å› ä¸ºç¼“å­˜ä¸­æ²¡æœ‰å­˜å‚¨è¿™äº›ç©ºæ•°æ®çš„ keyï¼Œå¯¼è‡´è¿™äº›è¯·æ±‚å…¨éƒ½æ‰“åˆ°æ•°æ®åº“ä¸Šã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä¸šåŠ¡å±‚çš„ä»£ç ï¼Œå°†æ•°æ®åº“æŸ¥è¯¢ç»“æœä¸ºç©ºçš„ key ä¹Ÿå­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚å½“åç»­åˆå‡ºç°è¯¥ key çš„æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œç¼“å­˜ç›´æ¥è¿”å› nullï¼Œè€Œæ— éœ€æŸ¥è¯¢æ•°æ®åº“ã€‚</p>
<p><strong>2. å¸ƒéš†è¿‡æ»¤å™¨</strong></p>
<p>å½“ä¸šåŠ¡å±‚æœ‰æŸ¥è¯¢è¯·æ±‚çš„æ—¶å€™ï¼Œé¦–å…ˆå»<code>BloomFilter</code>ä¸­æŸ¥è¯¢è¯¥ key æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨è¯¥æ•°æ®ï¼Œå› æ­¤ç¼“å­˜éƒ½ä¸è¦æŸ¥äº†ï¼Œç›´æ¥è¿”å› nullã€‚è‹¥å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ‰§è¡Œåç»­çš„æµç¨‹ï¼Œå…ˆå‰å¾€ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œç¼“å­˜ä¸­æ²¡æœ‰çš„è¯å†å‰å¾€æ•°æ®åº“ä¸­çš„æŸ¥è¯¢ã€‚</p>
<p>è¿™é‡Œç¬¬ä¸€ä¸ªç§æ–¹æ¡ˆå¯ä»¥ç›´æ¥æ’é™¤ï¼Œä¸€æ–¹é¢å› ä¸ºæˆ‘ä»¬è¿™ä¸ª cache æ˜¯ä¸èƒ½åˆ é™¤æ•°æ®çš„ï¼Œåªèƒ½è¢«åŠ¨çš„æ·˜æ±°æ•°æ®ï¼Œç¼“å­˜å¤§é‡çš„ç©ºå¯¹è±¡ä¸”å¾—ä¸åˆ°åŠæ—¶çš„åˆ é™¤ä¼šæµªè´¹å¤§é‡å†…å­˜ï¼Œå¦ä¸€æ–¹é¢ï¼Œç¼“å­˜ç©ºå¯¹è±¡çš„åšæ³•ï¼Œå¦‚æœæ¯æ¬¡æŸ¥è¯¢çš„ä¸å­˜åœ¨çš„<code>key</code>éƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ¡ˆä¹Ÿå°±èµ·ä¸åˆ°ä½œç”¨äº†</p>
<p>è‡³äºç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¯è¡Œï¼Œä½†æ˜¯ä¸åº”è¯¥åœ¨ç¼“å­˜å±‚æ¥åšï¼Œåº”è¯¥åœ¨ä¸šåŠ¡å±‚å¤„ç†ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸Šå±‚å¤„ç†ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç¼“å­˜ç»„ä»¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œç”¨å¸ƒéš†è¿‡æ»¤å™¨ä½ åªèƒ½åˆ¤æ–­åœ¨<strong>å½“å‰èŠ‚ç‚¹</strong>æœ‰æ²¡æœ‰ï¼Œæ— æ³•åˆ¤æ–­<strong>è¿œç¨‹èŠ‚ç‚¹</strong>æœ‰æ²¡æœ‰ï¼Œæ‰€ä»¥ä¸€å¼€å§‹å°±è¦å°†æ‰€æœ‰æ•°æ®é¢„çƒ­åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œä½†æ˜¯è¿™æ ·æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šéœ€è¦ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¿™æ ·åšæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œæ‰€ä»¥ç¼“å­˜ç©¿é€çš„é—®é¢˜åº”è¯¥æ”¾åˆ°åº”ç”¨å±‚å»å¤„ç†</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li><input checked="" disabled="" type="checkbox"> åˆ†å¸ƒå¼èŠ‚ç‚¹é€šä¿¡</li>
<li><input checked="" disabled="" type="checkbox"> ä¸€è‡´æ€§ Hash</li>
<li><input checked="" disabled="" type="checkbox"> ç¼“å­˜å‡»ç©¿</li>
<li><input checked="" disabled="" type="checkbox"> çƒ­ç‚¹äº’å¤‡</li>
<li><input disabled="" type="checkbox"> é…ç½®è§£è€¦</li>
<li><input disabled="" type="checkbox"> é›†ç¾¤ç®¡ç†</li>
</ul>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
