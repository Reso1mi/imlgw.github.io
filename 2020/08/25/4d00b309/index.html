<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        Golang è¸©å‘ï¼šexec å–æ¶ˆåä¸é€€å‡º - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">èƒŒæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E6%80%BB%E7%BB%93"><span class="toc-text">åŸå› æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">è§£å†³æ–¹æ¡ˆ</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Golang è¸©å‘ï¼šexec å–æ¶ˆåä¸é€€å‡º
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2020-08-25 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#å¼€æºé¡¹ç›®" title="å¼€æºé¡¹ç›®">å¼€æºé¡¹ç›®</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#Golang" title="Golang">Golang</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨åš <a target="_blank" rel="noopener" href="https://github.com/imlgw/scheduler">Scheduler é¡¹ç›®</a> çš„è¿‡ç¨‹ä¸­åˆ©ç”¨ os/exec åŒ…æ‰§è¡Œä¸€äº› shell è„šæœ¬ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°æˆ‘å–æ¶ˆäº† context å go è¿›ç¨‹ä»ç„¶é˜»å¡ä¸é€€å‡º</p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><blockquote>
<p>go version go1.13.6 linux/amd64</p>
</blockquote>
<p>åœ¨å®ç° kill å¼ºæ€åŠŸèƒ½æ—¶å€™å‘ç°çš„é—®é¢˜ï¼Œæ— æ³•æ€æ­»ä»»åŠ¡ï¼Œå³ä½¿ kill äº†è¿˜æ˜¯ä¼šç­‰åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ‰ä¼šè¿”å›ï¼Œåœ¨æŸ¥èµ„æ–™çš„è¿‡ç¨‹ä¸­å‘ç°è¿™åº”è¯¥ä¹Ÿç®—æ˜¯ golang æœ¬èº«çš„ä¸€ä¸ªå‘äº†ï¼Œå‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/23019">issue23019</a></p>
<p>ä¸€å¼€å§‹æ˜¯åœ¨ Windows å¹³å°ä¸Šè¿è¡Œæµ‹è¯•çš„ï¼Œä»¥ä¸ºæ˜¯å¹³å°çš„åŸå› ä½†æ˜¯åœ¨åˆ‡æ¢äº† Linux åé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œå¦‚ä¸‹ poc æ—¢å¯å¤ç°</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancelFn := context.WithTimeout(context.Background(), time.Second*<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">defer</span> cancelFn()</span><br><span class="line">    cmd := exec.CommandContext(ctx, <span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 120; echo hello&quot;</span>)</span><br><span class="line">    output, err := cmd.CombinedOutput()</span><br><span class="line">    fmt.Printf(<span class="string">&quot;outputï¼šã€%sã€‘err:ã€%sã€‘&quot;</span>, <span class="type">string</span>(output), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ linux å¹³å°ä¸Šé€šè¿‡ go run æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œç„¶å<code>pstree -p</code>æŸ¥çœ‹è¿›ç¨‹æ ‘</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”±äºè¿›ç¨‹æ ‘æ¯”è¾ƒåºå¤§ï¼Œæ‰€ä»¥çœç•¥äº†ä¸€äº›æ— å…³çš„éƒ¨åˆ†</span></span><br><span class="line">systemd(<span class="number">1</span>)â”€â”¬â”€...</span><br><span class="line">           â”œâ”€sshd(<span class="number">17395</span>)â”€â”¬â”€sshd(<span class="number">18450</span>)â”€â”€â”€sftp-server(<span class="number">18453</span>)</span><br><span class="line">           â”‚             â”œâ”€sshd(<span class="number">28684</span>)â”€â”€â”€zsh(<span class="number">28687</span>)â”€â”€â”€<span class="keyword">go</span>(<span class="number">2661</span>)â”€â”¬â”€demo3_cmdPit(<span class="number">2680</span>)â”€â”¬â”€bash(<span class="number">2683</span>)â”€â”€â”€sleep(<span class="number">2684</span>)</span><br><span class="line">           â”‚             â”‚                                     â”‚                    â”œâ”€&#123;demo3_cmdPit&#125;(<span class="number">2681</span>)</span><br><span class="line">           â”‚             â”‚                                     â”‚                    â”œâ”€&#123;demo3_cmdPit&#125;(<span class="number">2682</span>)</span><br><span class="line">           â”‚             â”‚                                     â”‚                    â””â”€&#123;demo3_cmdPit&#125;(<span class="number">2686</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2662</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2663</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2664</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2665</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2672</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2679</span>)</span><br><span class="line">           â”‚             â”‚                                     â””â”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2685</span>)</span><br><span class="line">           â”‚             â””â”€sshd(<span class="number">29042</span>)â”€â”€â”€zsh(<span class="number">29044</span>)â”€â”€â”€pstree(<span class="number">2688</span>)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çš„ go è¿›ç¨‹<code>demo3_cmdPit(2680)</code>åˆ›å»ºäº†<code>bash(2683)</code>è¿›ç¨‹å»æ‰§è¡Œå…·ä½“çš„ shell æŒ‡ä»¤ï¼Œä½†æ˜¯è¿™é‡Œç”±äºæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤æ˜¯ã€<code>sleep 50; echo hello</code>ã€‘å±äºä¸€ç»„å¤šæ¡å‘½ä»¤ï¼Œæ‰€ä»¥è¿™é‡Œ shell ä¼š fork å‡ºå­è¿›ç¨‹å»æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œæ‰€ä»¥ä¸Šé¢æ˜¾ç¤º<code>sleep(2684)</code>æ˜¯<code>bash(2683)</code>çš„å­è¿›ç¨‹</p>
<blockquote>
<p>è¡¥å……ï¼šé™¤äº†å¤šæ¡å‘½ä»¤ä¼šäº§ç”Ÿå­è¿›ç¨‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æƒ…å†µä¼šäº§ç”Ÿå­è¿›ç¨‹ï¼Œæ¯”å¦‚<code>&amp;</code>åå°è¿è¡Œï¼Œ<code>pipe</code>ç®¡é“ï¼Œå¤–éƒ¨ shell è„šæœ¬ç­‰ç­‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7446194.html">å­ shell ä»¥åŠä»€ä¹ˆæ—¶å€™è¿›å…¥å­ shell</a></p>
</blockquote>
<p>ç„¶åå† 5s å ctx åˆ°æœŸ cancel åæˆ‘ä»¬å†æ¬¡æŸ¥çœ‹è¿›ç¨‹æ ‘</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">systemd(<span class="number">1</span>)â”€â”¬â”€...</span><br><span class="line">           â”œâ”€sleep(<span class="number">2684</span>)</span><br><span class="line">           â”œâ”€sshd(<span class="number">17395</span>)â”€â”¬â”€sshd(<span class="number">18450</span>)â”€â”€â”€sftp-server(<span class="number">18453</span>)</span><br><span class="line">           â”‚             â”œâ”€sshd(<span class="number">28684</span>)â”€â”€â”€zsh(<span class="number">28687</span>)â”€â”€â”€<span class="keyword">go</span>(<span class="number">2661</span>)â”€â”¬â”€demo3_cmdPit(<span class="number">2680</span>)â”€â”¬â”€&#123;demo3_cmdPit&#125;(<span class="number">2681</span>)</span><br><span class="line">           â”‚             â”‚                                     â”‚                    â”œâ”€&#123;demo3_cmdPit&#125;(<span class="number">2682</span>)</span><br><span class="line">           â”‚             â”‚                                     â”‚                    â””â”€&#123;demo3_cmdPit&#125;(<span class="number">2686</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2662</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2663</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2664</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2665</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2672</span>)</span><br><span class="line">           â”‚             â”‚                                     â”œâ”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2679</span>)</span><br><span class="line">           â”‚             â”‚                                     â””â”€&#123;<span class="keyword">go</span>&#125;(<span class="number">2685</span>)</span><br><span class="line">           â”‚             â””â”€sshd(<span class="number">29042</span>)â”€â”€â”€zsh(<span class="number">29044</span>)â”€â”€â”€pstree(<span class="number">2708</span>)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>bash(2683)</code>è¿›ç¨‹ç¡®å®è¢« kill äº†ï¼Œä½†æ˜¯å®ƒçš„å­è¿›ç¨‹ç¡®å¹¶æ²¡æœ‰ç»“æŸï¼Œè€Œæ˜¯å˜æˆäº†<strong>å­¤å„¿è¿›ç¨‹</strong>ï¼Œè¢«<code>init 1(systemd)</code>æ”¶å…»ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°è¿™æ—¶è¿›ç¨‹<code>demo3_cmdPit(2680)</code>è¿˜æ²¡æœ‰é€€å‡ºï¼Œç¬¦åˆä¹‹å‰çš„é¢„æµ‹ï¼Œè¿™é‡Œè¯¥è¿›ç¨‹ä»ç„¶è¿˜æœ‰ 3 æ¡çº¿ç¨‹ï¼ˆåç¨‹ï¼‰æ²¡æœ‰é€€å‡ºï¼Œç›´åˆ° sleep å‘½ä»¤æ‰§è¡Œå®Œæ‰ä¼šè¿”å›ï¼Œè¿™é‡Œé€šè¿‡ pstack æ˜¯æ— æ³•æŸ¥çœ‹è¿™å‡ æ¡çº¿ç¨‹çš„å †æ ˆçš„ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿå¹¶ä¸è®¤è¯†åç¨‹ï¼Œè€Œä¸” G ä¼šåœ¨ P ä¸Šåˆ‡æ¢ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚æ—¶ä¹Ÿä¸çŸ¥é“è¿™å‡ æ¡çº¿ç¨‹åœ¨å¹²å˜›</p>
<blockquote>
<p>å­¤å„¿è¿›ç¨‹ï¼šçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹ï¼ˆè¿›ç¨‹å·ä¸º 1) æ‰€æ”¶å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚</p>
<p>åƒµå°¸è¿›ç¨‹ï¼šçˆ¶è¿›ç¨‹ä½¿ç”¨ fork åˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨<code>wait</code>æˆ–<code>waitpid</code>è·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚</p>
</blockquote>
<p>å½“ sleep æ‰§è¡Œå®Œæˆåï¼Œç¨‹åºä¼šæ­£å¸¸è¿”å›å¦‚ä¸‹ä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">outputï¼šã€ã€‘err:ã€signal: killedã€‘#</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ˜¯åœ¨ Linux ç¯å¢ƒä¸‹æ²¡æœ‰ IDE è€Œä¸”ä¸å¤ªç†Ÿæ‚‰<code>gdb</code>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç”¨<code>pprof</code>æŸ¥çœ‹äº†ä¸€ä¸‹å †æ ˆ</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    _ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        err := http.ListenAndServe(<span class="string">&quot;:6060&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;failed to start pprof monitor:%s&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    ctx, cancelFn := context.WithTimeout(context.Background(), time.Second*<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">defer</span> cancelFn()</span><br><span class="line">    cmd := exec.CommandContext(ctx, <span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 50; echo hello&quot;</span>)</span><br><span class="line">    output, err := cmd.CombinedOutput()</span><br><span class="line">    fmt.Printf(<span class="string">&quot;outputï¼šã€%sã€‘err:ã€%sã€‘&quot;</span>, <span class="type">string</span>(output), err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åé¢äº†è§£åˆ°å…¶å®ç›´æ¥å‘é€<code>SIGQUIT</code>ä¿¡å·ä¹Ÿå¯ä»¥çœ‹åˆ°å †æ ˆï¼Œå¦‚ <code>kill -SIGQUIT &lt;pid&gt;</code>ï¼Œgo çš„å·¥å…·é“¾è¿˜æ˜¯éå¸¸å®Œå–„çš„ï¼Œé™¤äº†è¿™äº›è¿˜æœ‰å¾ˆå¤šæ–¹æ³•çœ‹å †æ ˆ</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">curl http:<span class="comment">//127.0.0.1:6060/debug/pprof/goroutine\?debug\=2</span></span><br><span class="line">...</span><br><span class="line">goroutine <span class="number">1</span> [<span class="keyword">chan</span> receive]:</span><br><span class="line">os/exec.(*Cmd).Wait(<span class="number">0xc000098580</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">509</span> +<span class="number">0x125</span></span><br><span class="line">os/exec.(*Cmd).Run(<span class="number">0xc000098580</span>, <span class="number">0xc00006d710</span>, <span class="number">0xc000098580</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">341</span> +<span class="number">0x5c</span></span><br><span class="line">os/exec.(*Cmd).CombinedOutput(<span class="number">0xc000098580</span>, <span class="number">0x9</span>, <span class="number">0xc0000bff30</span>, <span class="number">0x2</span>, <span class="number">0x2</span>, <span class="number">0xc000098580</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">561</span> +<span class="number">0x91</span></span><br><span class="line">main.main()</span><br><span class="line">		/usr/local/gotest/cmd/demo3_cmdPit/main.<span class="keyword">go</span>:<span class="number">22</span> +<span class="number">0x176</span></span><br><span class="line">...</span><br><span class="line">goroutine <span class="number">9</span> [IO wait]:</span><br><span class="line">internal/poll.runtime_pollWait(<span class="number">0x7fa96a0f5f08</span>, <span class="number">0x72</span>, <span class="number">0xffffffffffffffff</span>)</span><br><span class="line">        /usr/lib/golang/src/runtime/netpoll.<span class="keyword">go</span>:<span class="number">184</span> +<span class="number">0x55</span></span><br><span class="line">internal/poll.(*pollDesc).wait(<span class="number">0xc000058678</span>, <span class="number">0x72</span>, <span class="number">0x201</span>, <span class="number">0x200</span>, <span class="number">0xffffffffffffffff</span>)</span><br><span class="line">        /usr/lib/golang/src/internal/poll/fd_poll_runtime.<span class="keyword">go</span>:<span class="number">87</span> +<span class="number">0x45</span></span><br><span class="line">internal/poll.(*pollDesc).waitRead(...)</span><br><span class="line">        /usr/lib/golang/src/internal/poll/fd_poll_runtime.<span class="keyword">go</span>:<span class="number">92</span></span><br><span class="line">internal/poll.(*FD).Read(<span class="number">0xc000058660</span>, <span class="number">0xc0000e2000</span>, <span class="number">0x200</span>, <span class="number">0x200</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line">        /usr/lib/golang/src/internal/poll/fd_unix.<span class="keyword">go</span>:<span class="number">169</span> +<span class="number">0x1cf</span></span><br><span class="line">os.(*File).read(...)</span><br><span class="line">        /usr/lib/golang/src/os/file_unix.<span class="keyword">go</span>:<span class="number">259</span></span><br><span class="line">os.(*File).Read(<span class="number">0xc000010088</span>, <span class="number">0xc0000e2000</span>, <span class="number">0x200</span>, <span class="number">0x200</span>, <span class="number">0x7fa96a0f5ff8</span>, <span class="number">0x0</span>, <span class="number">0xc000039ea0</span>)</span><br><span class="line">        /usr/lib/golang/src/os/file.<span class="keyword">go</span>:<span class="number">116</span> +<span class="number">0x71</span></span><br><span class="line">bytes.(*Buffer).ReadFrom(<span class="number">0xc00006d710</span>, <span class="number">0x8b6120</span>, <span class="number">0xc000010088</span>, <span class="number">0x7fa96a0f5ff8</span>, <span class="number">0xc00006d710</span>, <span class="number">0x1</span>)</span><br><span class="line">        /usr/lib/golang/src/bytes/buffer.<span class="keyword">go</span>:<span class="number">204</span> +<span class="number">0xb4</span></span><br><span class="line">io.copyBuffer(<span class="number">0x8b5a20</span>, <span class="number">0xc00006d710</span>, <span class="number">0x8b6120</span>, <span class="number">0xc000010088</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line">        /usr/lib/golang/src/io/io.<span class="keyword">go</span>:<span class="number">388</span> +<span class="number">0x2ed</span></span><br><span class="line">io.Copy(...)</span><br><span class="line">        /usr/lib/golang/src/io/io.<span class="keyword">go</span>:<span class="number">364</span></span><br><span class="line">os/exec.(*Cmd).writerDescriptor.func1(<span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">311</span> +<span class="number">0x63</span></span><br><span class="line">os/exec.(*Cmd).Start.func1(<span class="number">0xc000098580</span>, <span class="number">0xc00000e3a0</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">435</span> +<span class="number">0x27</span></span><br><span class="line">created by os/exec.(*Cmd).Start</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">434</span> +<span class="number">0x608</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘å¿½ç•¥äº†ä¸€äº›æ— å…³çš„åç¨‹ï¼Œç•™ä¸‹äº†è¿™ä¸¤æ¡çš„å †æ ˆä¿¡æ¯</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ç¬¬ä¸€æ¡çš„å †æ ˆä¿¡æ¯ï¼Œå¾ˆæ˜æ˜¾è¿™æ¡å°±æ˜¯æˆ‘ä»¬çš„ä¸»<code>goroutine</code>ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ­£å¤„äº<code>[chan receive]</code>çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯åœ¨ç­‰å¾…æŸä¸ª chan ä¼ é€’ä¿¡æ¯ï¼Œæ ¹æ®å †æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°é—®é¢˜å‡ºåœ¨</p>
<p> <code>/usr/lib/golang/src/os/exec/exec.go:509</code></p>
<p>æˆ‘ä»¬å»çœ‹ä¸€ä¸‹è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆ</p>
<p><img src="http://static.imlgw.top/blog/20200821/l2wEHHBXyTTh.png?imageslim" alt="mark"><br>æœç„¶è¿™é‡Œåœ¨ç­‰å¾…<code>c.errch</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª errch æ˜¯è°è´Ÿè´£æ¨é€çš„å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦ä¸€æ¡<code>goroutine</code>ï¼Œè¿™æ¡<code>goroutine</code>å¤„äº<code>ã€IO waitã€‘</code>çŠ¶æ€ï¼Œè¯´æ˜ IO å‘ç”Ÿé˜»å¡äº†ï¼Œæˆ‘ä»¬ä»ä¸‹å¾€ä¸Šçœ‹å †æ ˆï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹æ˜¯åœ¨å“ªé‡Œå¯åŠ¨äº†è¿™ä¸ªåç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">created by os/exec.(*Cmd).Start</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">434</span> +<span class="number">0x608</span></span><br></pre></td></tr></table></figure>
<p><img src="http://static.imlgw.top/blog/20200822/sh8qmlcDeD64.png?imageslim" alt="mark"><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªåç¨‹çš„ä½œç”¨å°±æ˜¯å‘æˆ‘ä»¬ä¸Šé¢çš„ä¸»<code>goroutine</code>åœ¨ç­‰å¾…çš„<code>c.errch</code>æ¨é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™é‡Œ<code>fn()</code>ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›å‘¢ï¼Ÿè¿™ä¸ª fn æ˜¯åœ¨å¹²å˜›ï¼Ÿç»§ç»­ç¿»ä¸€ç¿»æºç ï¼Œå‘ç°è¿™äº›å‡½æ•°<code>fn()</code>æ˜¯åœ¨ cmd.Start çš„æ—¶å€™åˆ›å»ºçš„ï¼Œç”¨äºå¤„ç† shell çš„æ ‡å‡†è¾“å…¥ï¼Œè¾“å‡ºå’Œé”™è¯¯è¾“å‡ºï¼Œè€Œæˆ‘ä»¬çš„ç¨‹åºå°±æ˜¯å¡åœ¨äº†è¿™é‡Œï¼Œç»§ç»­è·Ÿè¿›ä¸Šé¢çš„å †æ ˆä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">os/exec.(*Cmd).writerDescriptor.func1(<span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line">        /usr/lib/golang/src/os/exec/exec.<span class="keyword">go</span>:<span class="number">311</span> +<span class="number">0x63</span></span><br></pre></td></tr></table></figure>
<p><img src="http://static.imlgw.top/blog/20200826/Boqz6oWej6HA.png?imageslim" alt="mark"><br>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±æ˜¯å…·ä½“åç¨‹æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª IO æ“ä½œï¼Œå¯æƒ³è€ŒçŸ¥ç¨‹åºå°±æ˜¯é˜»å¡åœ¨äº†è¿™é‡Œï¼Œå†å¾€ä¸‹åˆ†æå°±æ˜¯å†…éƒ¨ epoll çš„ä»£ç äº†ï¼Œå°±ä¸å¾€ä¸‹äº†ï¼Œæˆ‘ä»¬åˆ†æä¸‹è¿™æ®µä»£ç çš„æ„ä¹‰ï¼Œé¦–å…ˆåˆ›å»ºäº†ç®¡é“<code>Pipe</code>ï¼Œç„¶ååœ¨åç¨‹ä¸­å°†è¯»ç«¯<code>pr</code>çš„æ•°æ® copy åˆ°<code>w</code>ä¸­ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œå°±æ˜¯<code>goroutine</code>é€šè¿‡ pipe è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºï¼Œä½†æ˜¯ç”±äºæŸäº›åŸå› <code>Pipe</code>é˜»å¡äº†ï¼Œæ— æ³•ä»è¯»ç«¯è·å–æ•°æ®</p>
<p>æˆ‘ä»¬ç”¨<code>lsof -p</code>çœ‹ä¸€ä¸‹è¯¥è¿›ç¨‹æ‰“å¼€çš„èµ„æº</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ lsof -p <span class="number">27301</span></span><br><span class="line">COMMAND   PID USER   FD      TYPE    DEVICE SIZE/OFF      NODE NAME</span><br><span class="line">main    <span class="number">27301</span> root  cwd       DIR     <span class="number">253</span>,<span class="number">1</span>     <span class="number">4096</span>   <span class="number">1323417</span> /usr/local/gotest/cmd/demo3_cmdPit</span><br><span class="line">main    <span class="number">27301</span> root  rtd       DIR     <span class="number">253</span>,<span class="number">1</span>     <span class="number">4096</span>         <span class="number">2</span> /</span><br><span class="line">main    <span class="number">27301</span> root  txt       REG     <span class="number">253</span>,<span class="number">1</span>  <span class="number">7647232</span>    <span class="number">401334</span> /tmp/<span class="keyword">go</span>-build043247660/b001/exe/main</span><br><span class="line">main    <span class="number">27301</span> root  mem       REG     <span class="number">253</span>,<span class="number">1</span>  <span class="number">2151672</span>   <span class="number">1050229</span> /usr/lib64/libc<span class="number">-2.17</span>.so</span><br><span class="line">main    <span class="number">27301</span> root  mem       REG     <span class="number">253</span>,<span class="number">1</span>   <span class="number">141968</span>   <span class="number">1050255</span> /usr/lib64/libpthread<span class="number">-2.17</span>.so</span><br><span class="line">main    <span class="number">27301</span> root  mem       REG     <span class="number">253</span>,<span class="number">1</span>   <span class="number">163400</span>   <span class="number">1050214</span> /usr/lib64/ld<span class="number">-2.17</span>.so</span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">0</span>u      CHR     <span class="number">136</span>,<span class="number">0</span>      <span class="number">0</span>t0         <span class="number">3</span> /dev/pts/<span class="number">0</span></span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">1</span>u      CHR     <span class="number">136</span>,<span class="number">0</span>      <span class="number">0</span>t0         <span class="number">3</span> /dev/pts/<span class="number">0</span></span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">2</span>u      CHR     <span class="number">136</span>,<span class="number">0</span>      <span class="number">0</span>t0         <span class="number">3</span> /dev/pts/<span class="number">0</span></span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">3</span>u     IPv6 <span class="number">170355813</span>      <span class="number">0</span>t0       TCP *:<span class="number">6060</span> (LISTEN)</span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">4</span>u  a_inode      <span class="number">0</span>,<span class="number">10</span>        <span class="number">0</span>      <span class="number">5074</span> [eventpoll]</span><br><span class="line">main    <span class="number">27301</span> root    <span class="number">5</span>r     FIFO       <span class="number">0</span>,<span class="number">9</span>      <span class="number">0</span>t0 <span class="number">170355794</span> pipe</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®æ‰“å¼€äº†ä¸€ä¸ª inode ä¸º 170355794 çš„ç®¡é“ï¼Œç»“åˆå‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬çš„ shell åœ¨æ‰§è¡Œçš„æ—¶å€™<code>fork()</code>åˆ›å»ºäº†å­è¿›ç¨‹ï¼Œä½†æ˜¯ kill çš„æ—¶å€™åª kill äº† shell è¿›ç¨‹ï¼Œè€Œåœ¨<code>fork()</code>çš„æ—¶å€™ä¼šåŒæ—¶å°†å½“å‰è¿›ç¨‹çš„<code>pipe</code>çš„<code>fd[2]</code>æè¿°ç¬¦ä¹Ÿå¤åˆ¶è¿‡å»ï¼Œè¿™å°±é€ æˆäº†<code>pipe</code>çš„å†™å…¥ç«¯<code>fd[1]</code>è¢«å­è¿›ç¨‹ç»§ç»­æŒæœ‰ï¼ˆæ–‡ä»¶è¡¨å¼•ç”¨è®¡æ•°ä¸ä¸º 0ï¼‰ï¼Œè€Œ<code>goroutine</code>ä¹Ÿä¼šç»§ç»­ç­‰å¾… pipe å†™å…¥ç«¯å†™å…¥æˆ–è€…å…³é—­ï¼Œç›´åˆ°<code>sleep 50</code>æ‰§è¡Œå®Œåæ‰è¿”å›</p>
<h2 id="åŸå› æ€»ç»“"><a href="#åŸå› æ€»ç»“" class="headerlink" title="åŸå› æ€»ç»“"></a>åŸå› æ€»ç»“</h2><p><code>golang</code>çš„<code>os/exec</code>åŒ…åœ¨å’Œ shell åšäº¤äº’çš„æ—¶å€™ä¼šå’Œ shell ä¹‹é—´å»ºç«‹ pipeï¼Œç”¨äºè¾“å…¥è¾“å‡ºï¼Œè·å– shell è¿”å›å€¼ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ shell ä¼š fork å‡ºå­è¿›ç¨‹å»æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚å¤šæ¡è¯­å¥ï¼Œ&amp;åå°æ‰§è¡Œï¼Œsh è„šæœ¬ç­‰ï¼Œç„¶è€Œè¿™é‡Œ ctx è¿‡æœŸåï¼Œä»…ä»… kill äº† shell è¿›ç¨‹ï¼Œå¹¶æ²¡æœ‰ kill å®ƒæ‰€åˆ›å»ºçš„å­è¿›ç¨‹ï¼Œè¿™å°±å¯¼è‡´äº† pipe çš„ fd ä»ç„¶è¢«å­è¿›ç¨‹æŒæœ‰æ— æ³•å…³é—­ï¼Œè€Œåœ¨<code>os/exec</code>çš„å®ç°ä¸­<code>goroutine</code>ä¼šä¸€ç›´ç­‰å¾… pipe å…³é—­åæ‰è¿”å›ï¼Œè¿›è€Œå¯¼è‡´äº†è¯¥é—®é¢˜çš„äº§ç”Ÿ</p>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>é—®é¢˜ææ¸…æ¥šäº†ï¼Œå°±å¥½è§£å†³äº†ã€‚åœ¨ go çš„å®ç°ä¸­åª kill äº† shell è¿›ç¨‹ï¼Œå¹¶ä¸ä¼š kill å­è¿›ç¨‹ï¼Œè¿›è€Œå¼•å‘äº†ä¸Šé¢çš„é—®é¢˜</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Kill causes the Process to exit immediately. Kill does not wait until</span></span><br><span class="line"><span class="comment">// the Process has actually exited. This only kills the Process itself,</span></span><br><span class="line"><span class="comment">// not any other processes it may have started.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Process)</span></span> Kill() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> p.kill()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ kill<code>è¿›ç¨‹ç»„</code>çš„æ–¹å¼æ¥è§£å†³ï¼Œæ‰€è°“è¿›ç¨‹ç»„ä¹Ÿå°±æ˜¯çˆ¶è¿›ç¨‹å’Œå…¶åˆ›å»ºçš„å­è¿›ç¨‹çš„é›†åˆï¼Œ<code>PGID</code>å°±æ˜¯è¿›ç¨‹ç»„çš„ IDï¼Œæ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰è¿›ç¨‹ç»„ IDï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>ps -axjf</code>å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">PPID   PID  PGID   SID TTY      TPGID STAT   UID   TIME COMMAND</span><br><span class="line"><span class="number">17395</span> <span class="number">20937</span> <span class="number">20937</span> <span class="number">20937</span> ?           <span class="number">-1</span> Ss       <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  \_ sshd: root@pts/<span class="number">0</span></span><br><span class="line"><span class="number">20937</span> <span class="number">20939</span> <span class="number">20939</span> <span class="number">20939</span> pts/<span class="number">0</span>    <span class="number">25879</span> Ss       <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  |   \_ -zsh</span><br><span class="line"><span class="number">20939</span> <span class="number">25879</span> <span class="number">25879</span> <span class="number">20939</span> pts/<span class="number">0</span>    <span class="number">25879</span> Sl+      <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  |       \_ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line"><span class="number">25879</span> <span class="number">25902</span> <span class="number">25879</span> <span class="number">20939</span> pts/<span class="number">0</span>    <span class="number">25879</span> Sl+      <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  |           \_ /tmp/<span class="keyword">go</span>-build486839449/b001/exe/main</span><br><span class="line"><span class="number">25902</span> <span class="number">25906</span> <span class="number">25879</span> <span class="number">20939</span> pts/<span class="number">0</span>    <span class="number">25879</span> S+       <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  |               \_ /bin/bash -c sleep <span class="number">50</span>; echo hello</span><br><span class="line"><span class="number">25906</span> <span class="number">25907</span> <span class="number">25879</span> <span class="number">20939</span> pts/<span class="number">0</span>    <span class="number">25879</span> S+       <span class="number">0</span>   <span class="number">0</span>:<span class="number">00</span>  |                   \_ sleep <span class="number">50</span></span><br></pre></td></tr></table></figure>
<p>åœ¨çŸ¥é“<code>PGID</code>åå¯ä»¥æ ¹æ®è¿™ä¸ª ID ç›´æ¥ Kill æ‰æ‰€æœ‰ç›¸å…³çš„è¿›ç¨‹ï¼Œä½†æ˜¯è¿™é‡Œæ³¨æ„çœ‹ä¸Šé¢ï¼Œæˆ‘ä»¬çš„<code>Shell</code>è¿›ç¨‹å’Œå®ƒçš„å­è¿›ç¨‹ï¼Œä»¥åŠæˆ‘ä»¬<code>go è¿›ç¨‹</code>éƒ½æ˜¯åœ¨ä¸€ä¸ªè¿›ç¨‹ç»„å†…çš„ï¼Œç›´æ¥ kill ä¼šæŠŠæˆ‘ä»¬çš„ go è¿›ç¨‹ä¹Ÿæ€æ­»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦è®©<code>Shell</code>è¿›ç¨‹å’Œå®ƒçš„å­è¿›ç¨‹é¢å¤–å¼€è¾Ÿä¸€ä¸ªæ–°çš„è¿›ç¨‹ç»„ï¼Œç„¶åå† kill</p>
<blockquote>
<p>ä¸‹é¢çš„ä»£ç ä¸­ä½¿ç”¨åˆ°äº†ä¸€äº›<code>syscall</code>åŒ…çš„æ–¹æ³•ï¼Œè¿™ä¸ªåŒ…çš„å®ç°å¹³å°ä¹‹é—´æ˜¯æœ‰å·®å¼‚çš„ï¼Œä¸‹é¢çš„ä»£ç åªé€‚ç”¨äº Linux ç¯å¢ƒä¸‹</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunCmd</span><span class="params">(ctx context.Context, cmd *exec.Cmd)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        b   bytes.Buffer</span><br><span class="line">        err <span class="type">error</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//å¼€è¾Ÿæ–°çš„çº¿ç¨‹ç»„ï¼ˆLinux å¹³å°ç‰¹æœ‰çš„å±æ€§ï¼‰</span></span><br><span class="line">    cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">        Setpgid: <span class="literal">true</span>, <span class="comment">//ä½¿å¾— Shell è¿›ç¨‹å¼€è¾Ÿæ–°çš„ PGID, å³ Shell è¿›ç¨‹çš„ PID, å®ƒåé¢åˆ›å»ºçš„æ‰€æœ‰å­è¿›ç¨‹éƒ½å±äºè¯¥è¿›ç¨‹ç»„</span></span><br><span class="line">    &#125;</span><br><span class="line">    cmd.Stdout = &amp;b</span><br><span class="line">    cmd.Stderr = &amp;b</span><br><span class="line">    <span class="keyword">if</span> err = cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> finish = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(finish)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//è¶…æ—¶/è¢« cancel ç»“æŸ</span></span><br><span class="line">            <span class="comment">//kill -(-PGID) æ€æ­»æ•´ä¸ªè¿›ç¨‹ç»„</span></span><br><span class="line">            syscall.Kill(-cmd.Process.Pid, syscall.SIGKILL)</span><br><span class="line">        <span class="keyword">case</span> &lt;-finish: <span class="comment">//æ­£å¸¸ç»“æŸ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">//wait ç­‰å¾… goroutine æ‰§è¡Œå®Œï¼Œç„¶åé‡Šæ”¾ FD èµ„æº</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ—¶å€™å† kill æ‰ shell è¿›ç¨‹å°±ä¸ä¼šå†ç­‰å¾…äº†ï¼Œä¼šç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> err = cmd.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b.Bytes(), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ•ˆæœæ¼”ç¤º</strong><br><img src="http://static.imlgw.top/blog/20200825/gfz2xQ7nnKKg.gif" alt="mark"></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
