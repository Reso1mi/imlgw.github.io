<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        AQS æºç è§£æï¼ˆä¸Šï¼‰ - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractQueuedSynchronized"><span class="toc-text">AbstractQueuedSynchronized</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS-%E7%BB%93%E6%9E%84"><span class="toc-text">AQS ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc-text">å±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node-%E8%8A%82%E7%82%B9"><span class="toc-text">Node èŠ‚ç‚¹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentrantLock-%E5%88%86%E6%9E%90"><span class="toc-text">ReentrantLock åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lock"><span class="toc-text">Lock()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#acquire"><span class="toc-text">acquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tryAquire"><span class="toc-text">tryAquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hasQueuedPredecessors"><span class="toc-text">hasQueuedPredecessors()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#addWaiter"><span class="toc-text">addWaiter()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#enq"><span class="toc-text">enq()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#acquireQueued"><span class="toc-text">acquireQueued()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shouldParkAfterFailedAcquire"><span class="toc-text">shouldParkAfterFailedAcquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#parkAndCheckInterrupt"><span class="toc-text">parkAndCheckInterrupt()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unLock"><span class="toc-text">unLock()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#release"><span class="toc-text">release()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tryRelease"><span class="toc-text">tryRelease()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unparkSuccessor"><span class="toc-text">unparkSuccessor()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%85%AC%E5%B9%B3%E9%94%81%E5%8C%BA%E5%88%AB"><span class="toc-text">éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lock"><span class="toc-text">lock()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nonfairTryAcquire"><span class="toc-text">nonfairTryAcquire()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">æµç¨‹å›¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        AQS æºç è§£æï¼ˆä¸Šï¼‰
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2019-09-24 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#å¤šçº¿ç¨‹" title="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#å¹¶å‘ç¼–ç¨‹" title="å¹¶å‘ç¼–ç¨‹">å¹¶å‘ç¼–ç¨‹</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="AbstractQueuedSynchronized"><a href="#AbstractQueuedSynchronized" class="headerlink" title="AbstractQueuedSynchronized"></a>AbstractQueuedSynchronized</h2><p><code>AbstractQueuedSynchronized</code> ç®€ç§° AQSï¼Œè¿™ä¸ªç±»æ˜¯æ•´ä¸ªå¹¶å‘åŒ…çš„åŸºç¡€å·¥å…·ç±»ï¼Œ ReentrantLockã€CountDownLatchã€Semaphoreã€FutureTask ç­‰å¹¶å‘å·¥å…·ç±»åº•å±‚éƒ½æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„</p>
<p>AQS å®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼š</p>
<ul>
<li>Exclusiveï¼šç‹¬å å¼ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–èµ„æºå¹¶æ‰§è¡Œï¼Œæ¯”å¦‚ ReentrantLockã€‚</li>
<li>Shareï¼šå…±äº«å¼ï¼Œå¤šä¸ªçº¿ç¨‹è·å–èµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œæ¯”å¦‚ CountDownLatchï¼ŒReentrantReadWriteLock çš„ ReadLock ç­‰</li>
</ul>
<h3 id="AQS-ç»“æ„"><a href="#AQS-ç»“æ„" class="headerlink" title="AQS ç»“æ„"></a>AQS ç»“æ„</h3><h4 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h4><p>ä¸»è¦çš„å°±æ˜¯è¿™ä¸‰ä¸ª volatile ä¿®é¥°çš„ Node å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€äº›å¯¹åº”çš„åç§»é‡ï¼ˆç”¨äº CAS çš„ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Head of the wait queue, lazily initialized.  Except for</span></span><br><span class="line"><span class="comment"> * initialization, it is modified only via method setHead.  Note:</span></span><br><span class="line"><span class="comment"> * If head exists, its waitStatus is guaranteed not to be</span></span><br><span class="line"><span class="comment"> * CANCELLED.</span></span><br><span class="line"><span class="comment"> * å¤´èŠ‚ç‚¹ï¼Œå¯ä»¥ç†è§£ä¸ºå½“å‰æŒæœ‰é”çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ä¸è¦å°†å®ƒç®—ä½œé˜Ÿåˆ—çš„ä¸€éƒ¨åˆ†ï¼å®ƒåªæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tail of the wait queue, lazily initialized.  Modified only via</span></span><br><span class="line"><span class="comment"> * method enq to add new wait node.</span></span><br><span class="line"><span class="comment"> * å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The synchronization state.</span></span><br><span class="line"><span class="comment"> * åŒæ­¥çŠ¶æ€ï¼Œ0 ä»£è¡¨æ²¡æœ‰è¢«å ç”¨ï¼Œ1 ä»£è¡¨è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œ&gt;1 ä»£è¡¨è¢«åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡å ç”¨ï¼ˆå¯é‡å…¥ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br></pre></td></tr></table></figure>

<h4 id="Node-èŠ‚ç‚¹"><a href="#Node-èŠ‚ç‚¹" class="headerlink" title="Node èŠ‚ç‚¹"></a>Node èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">    <span class="comment">//å…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">    <span class="comment">//ç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">    <span class="comment">//å–æ¶ˆæŠ¢é”</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line">    <span class="comment">//ä»£è¡¨å½“å‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹éœ€è¦è¢« unparkingï¼Œä¹Ÿå°±æ˜¯è¯´åç»§èŠ‚ç‚¹çŠ¶æ€æ˜¯ parking</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">    <span class="comment">//åœ¨ condition ä¸Šç­‰å¾…</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">     * unconditionally propagate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ä¸Šé¢çš„é‚£äº›çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‰é©±èŠ‚ç‚¹    </span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">//åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The thread that enqueued this node.  Initialized on</span></span><br><span class="line"><span class="comment">     * construction and nulled out after use.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Link to next node waiting on condition, or the special</span></span><br><span class="line"><span class="comment">     * value SHARED.  Because condition queues are accessed only</span></span><br><span class="line"><span class="comment">     * when holding in exclusive mode, we just need a simple</span></span><br><span class="line"><span class="comment">     * linked queue to hold nodes while they are waiting on</span></span><br><span class="line"><span class="comment">     * conditions. They are then transferred to the queue to</span></span><br><span class="line"><span class="comment">     * re-acquire. And because conditions can only be exclusive,</span></span><br><span class="line"><span class="comment">     * we save a field by using special value to indicate shared</span></span><br><span class="line"><span class="comment">     * mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isShared</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node <span class="title function_">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">        <span class="built_in">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="type">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">        <span class="built_in">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLock-åˆ†æ"><a href="#ReentrantLock-åˆ†æ" class="headerlink" title="ReentrantLock åˆ†æ"></a>ReentrantLock åˆ†æ</h2><p>æˆ‘ä»¬çŸ¥é“ ReentrantLock å†…éƒ¨æœ‰ä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯å…¬å¹³é” (FairSync)ğŸ”’ï¼Œä¸€ä¸ªæ˜¯éå…¬å¹³é” (NonFairSync)ğŸ”’ï¼Œè¿™ä¸¤ä¸ªé”éƒ½æ˜¯ç‹¬å é”ï¼Œä¸¤è€…å®ç°çš„å·®å¼‚å…¶å®å¹¶ä¸å¤§ï¼Œæˆ‘ä»¬å…ˆä»<code>å…¬å¹³é”</code>å¼€å§‹è¯´èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fair version of tryAcquire.  Don&#x27;t grant access unless</span></span><br><span class="line"><span class="comment">     * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock()"></a>Lock()</h3><p>ğŸ”” <strong>è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹<code>Thread0</code> å’Œ<code>Thread1</code> è¿‡æ¥æ‰§è¡Œäº†<code>Lock()</code> æ–¹æ³•ï¼Œä¸”<code>Thread0</code> æ¯”<code>Thread1</code> è¦å…ˆæ‰§è¡Œã€‚</strong></p>
<p><code>Lock()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†çˆ¶ç±»çš„<code>acquire(1)</code></p>
<h4 id="acquire"><a href="#acquire" class="headerlink" title="acquire()"></a>acquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå°è¯• tryAcquire(1)ï¼Œè¿™ä¸ª tryLock() åœ¨ AQS ä¸­æ²¡æœ‰å…·ä½“å®ç°æ˜¯äº¤ç»™å­ç±»å»å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¼šè°ƒç”¨ FairSync çš„ï¼ŒtryAquire(1)</p>
<h4 id="tryAquire"><a href="#tryAquire" class="headerlink" title="tryAquire()"></a>tryAquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">//è·å–åŒæ­¥çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; <span class="comment">//0 ä»£è¡¨è¿˜æ²¡æœ‰çº¿ç¨‹å ç”¨</span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æœ‰æ²¡æœ‰å‰é©±èŠ‚ç‚¹ï¼ˆé™¤ head èŠ‚ç‚¹å¤–ï¼‰ï¼Œæ²¡æœ‰åˆ™è¿›è¡Œ CAS è®¾ç½®åŒæ­¥çŠ¶æ€è·å–é”</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="number">0</span>, acquires)) &#123; </span><br><span class="line">            <span class="comment">//è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ°è¿™é‡Œå°±è¯´æ˜å·²ç»æœ‰çº¿ç¨‹å ç”¨äº†ï¼Œæ‰€ä»¥ä¸‹é¢æ˜¯ä¸ºäº†é‡å…¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ°è¾¾è¿™é‡Œ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="hasQueuedPredecessors"><a href="#hasQueuedPredecessors" class="headerlink" title="hasQueuedPredecessors()"></a>hasQueuedPredecessors()</h4><p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire æ–¹æ³•åŒºåˆ«å°±åœ¨è¿™é‡Œï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ¤æ–­æœ‰æ²¡æœ‰å‰é©±èŠ‚ç‚¹ï¼ˆä¸åŒ…å«å¤´èŠ‚ç‚¹ headï¼Œä¹Ÿå°±æ˜¯ï¼‰å­˜åœ¨ï¼Œæœ‰çš„è¯ä¸ºäº†ä¿è¯å…¬å¹³æ€§å°±æ˜¯éœ€è¦ç­‰å¾…ï¼Œè¿”å› trueã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// The correctness of this depends on head being initialized</span></span><br><span class="line">    <span class="comment">// before tail and on head.next being accurate if the current</span></span><br><span class="line">    <span class="comment">// thread is first in queue.</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="comment">// å¤´ä¸ç­‰äºå°¾ï¼Œå¹¶ä¸”é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ‰€æŒæœ‰çº¿ç¨‹éå½“å‰çº¿ç¨‹è¿”å› true</span></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="literal">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ åˆ°è¿™é‡Œæˆ‘ä»¬åˆ†æä¸‹<code>Thread0</code> å’Œ<code>Thread1</code> çš„æ‰§è¡Œæƒ…å†µ</p>
<p>ğŸ”¸ é¦–å…ˆ<code>Thread0</code>å…ˆæ‰§è¡Œäº†<code>tryAcquire(1)</code>  æ²¡æœ‰ä»»ä½•é˜»ç¢ï¼Œæ‰§è¡ŒæˆåŠŸç›´æ¥ retrurn</p>
<p>ğŸ”¸ <code>Thread1</code> æ­¤æ—¶æœ‰å¤šç§æƒ…å†µï¼š</p>
<ul>
<li><p>è¿˜æ²¡æœ‰è·å– state ï¼Œ<code>Thread0</code>æ‰§è¡Œå®Œåè·å– State==1 ï¼Œç”±äºæ˜¯ç‹¬å é”ç›´æ¥ return false ï¼Œè·å–é”å¤±è´¥ã€‚</p>
</li>
<li><p> å·²ç»<code>getState()==0</code>äº†ï¼Œæ‰§è¡Œ<code>hasQueuedPredecessors</code> æ–¹æ³•ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶ head å’Œ tail éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œéƒ½è¿˜æ˜¯ nullï¼ˆå®˜æ–¹çš„æ³¨é‡Šä¸­ä¹Ÿæåˆ° head å’Œ tail æ˜¯ lazily initialized ï¼‰æ‰€ä»¥è¿™é‡Œä¼šç›´æ¥ return falseï¼Œç„¶åç»§ç»­æ‰§è¡Œ CASï¼Œç”±äºå‰é¢<code>Thread0</code> å·²ç»å°† state è®¾ç½®ä¸ºäº† 1 ï¼Œæ‰€ä»¥è¿™é‡Œ CAS è‚¯å®šå¤±è´¥äº†ï¼Œæœ€ç»ˆ<code>Thread1</code>çš„ tryAcquire å¤±è´¥è¿”å› falseã€‚</p>
</li>
</ul>
<p>ğŸ”¸ æ—¢ç„¶<code>tryAcquire()</code> å¤±è´¥äº†ï¼Œé‚£<code>Thread1</code> å°±ä¼šè½¬å¤´ç»§ç»­æ‰§è¡Œåé¢çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ‰§è¡Œçš„å°±æ˜¯<code>AddWaiter()</code> </p>
<h4 id="addWaiter"><a href="#addWaiter" class="headerlink" title="addWaiter()"></a>addWaiter()</h4><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°† Thread å’Œ mode åŒ…è£…æˆ Node ç„¶åæ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ç„¶åè¿”å›è¿™ä¸ª Node</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çº¿ç¨‹å’Œæ¨¡å¼å°è£…è¿› Node</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">//å¦‚æœå°¾èŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å°† node è¿æ¥åœ¨å½“å‰ tail åé¢</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">//cas è®¾ç½®å½“å‰ tail ä¸º node</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¶å®å‰é¢çœ‹ä¼¼ä¼šæœ‰å¹¶å‘çš„é—®é¢˜å…¶å®å¹¶æ²¡æœ‰</span></span><br><span class="line">    <span class="comment">// ä¸Šé¢æŠ¢é”å¤±è´¥çš„çº¿ç¨‹ä¼šç›´æ¥è¿›å…¥ enq æ–¹æ³•è‡ªæ—‹é‡æ–°è®¾ç½®ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ æ ¹æ®å‰é¢åˆ†æ head å’Œ tail éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–éƒ½è¿˜æ˜¯ nullï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿›å…¥ <code>enq()</code>æ–¹æ³•</p>
<h4 id="enq"><a href="#enq" class="headerlink" title="enq()"></a>enq()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå› ä¸º head å’Œ tail éƒ½è¿˜æ˜¯ç©ºçš„æ‰€ä»¥è¿™é‡Œè¿›å…¥ç¬¬ä¸€ä¸ªå¾ªç¯ï¼ŒCAS è®¾ç½®ä¸€ä¸ªç©ºçš„ Node() ä¸ºå¤´èŠ‚ç‚¹ headï¼Œç„¶åå°† tail ä¹ŸæŒ‡å‘è¿™ä¸ª headï¼Œåˆ°è¿™é‡Œ head å’Œ tail æ‰ç®—æ˜¯åˆå§‹åŒ–å®Œæˆäº† (lazily initialized )ã€‚</p>
<p>ğŸ”¸ å¾ªç¯ï¼Œè¿›å…¥ elseï¼Œè¿™é‡Œå°±å°†å½“å‰ node è¿æ¥åˆ° tail åé¢å¹¶ä¸”åˆ©ç”¨ CAS è‡ªæ—‹è®¾ç½® tail ä¸ºå½“å‰ node ä¹Ÿå°±æ˜¯åŒ…å«<code>Thread1</code> çš„ nodeï¼Œç„¶å return å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼ˆè¿™é‡Œè¿”å›å€¼å¹¶æ²¡æœ‰ç”¨åˆ°ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ<code>acquireQueued()</code></p>
<p>â“ <strong>ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨æ„é€ å™¨é‡Œé¢å°±åˆå§‹åŒ–å¤´èŠ‚ç‚¹ headï¼Ÿè€Œè¦é‡‡ç”¨æ‡’åŠ è½½çš„æ–¹å¼ï¼Ÿ</strong></p>
<blockquote>
<p>CLH queues need a dummy header node to get started. Butwe donâ€™t create them on <strong>construction</strong>, because it would be wasted  effort if there is <strong>never contention</strong>. Instead, the nodeis constructed and head and tail pointers are set up <strong>on first contention</strong>.</p>
</blockquote>
<p>ä»¥ä¸Šæ‘˜è‡ª** Doug Lea** å¤§å¸ˆçš„æ³¨é‡Šè§£é‡Šï¼Œæ ¹æ®æˆ‘ä»¬çš„ä¸Šé¢çš„åˆ†æï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹<code>Thread0</code> è¿‡æ¥çš„æ—¶å€™å¹¶æ²¡æœ‰å»åˆå§‹åŒ– headï¼Œåé¢çš„çº¿ç¨‹<code>Thread1</code>è¿‡æ¥çš„æ—¶å€™ æœ‰äº†ç«äº‰æ‰åˆå§‹åŒ–äº†è¿™ä¸ªå¤´èŠ‚ç‚¹ headï¼Œå¦‚æœç›´æ¥åˆå§‹åŒ–è¿™ä¸ª headï¼Œç„¶ååˆæ²¡æœ‰é”ç«äº‰ï¼Œè¿™ä¸ª head èŠ‚ç‚¹å°±è¢«æµªè´¹äº†ã€‚ å¤§å¸ˆå°±æ˜¯å¤§å¸ˆï¼Œå¤ªå¼ºäº† ğŸ˜®</p>
<h4 id="acquireQueued"><a href="#acquireQueued" class="headerlink" title="acquireQueued()"></a>acquireQueued()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">//å¦‚æœå‰ç½®èŠ‚ç‚¹æ˜¯ head å°±å°è¯•å»è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">//è®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//å‘ç”Ÿå¼‚å¸¸å–æ¶ˆæŠ¢é”</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ å› ä¸ºå‰ç½®èŠ‚ç‚¹æ˜¯ headï¼Œæ‰€ä»¥è¿™é‡Œä½œä¸ºé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå¯ä»¥å»å°è¯•è·å–é”ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¸ªæ­»å¾ªç¯ï¼Œä¼šä¸€ç›´å°è¯•è·å–é”ï¼Œå…¶å®ç±»ä¼¼ä¸ CAS çš„è‡ªæ—‹ï¼Œä½†æ˜¯ç›¸æ¯” CAS è‡ªæ—‹åˆæœ‰å¾ˆå¤§ä¸åŒï¼Œå®ƒå¹¶ä¸ä¼šä¸€ç›´è‡ªæ—‹ï¼Œè¯¦ç»†å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>ğŸ”¸ å‰é¢ä¼ é€’è¿‡æ¥çš„ node å‰ç»§èŠ‚ç‚¹æ­£å¥½å°±æ˜¯ headï¼Œæ‰€ä»¥æ‰§è¡Œ tryAcquire() ä½†æ˜¯ç”±äº<code>Thread0</code> è¿˜æ²¡æœ‰é‡Šæ”¾é”æ‰€ä»¥è¿™é‡Œä»ç„¶å¤±è´¥ã€‚</p>
<p>ğŸ”¸ è¿›å…¥ç¬¬äºŒä¸ª if æ‰§è¡Œ <code>shouldParkAfterFailedAcquire(p,node)</code></p>
<h4 id="shouldParkAfterFailedAcquire"><a href="#shouldParkAfterFailedAcquire" class="headerlink" title="shouldParkAfterFailedAcquire()"></a>shouldParkAfterFailedAcquire()</h4><p>çœ‹åå­—å°±çŸ¥é“æ˜¯å¹²å•¥çš„äº†ï¼Œè·å–å¤±è´¥æ˜¯å¦ Parkï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="comment">//å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">//å‰ç½®èŠ‚ç‚¹çŠ¶æ€ä¸º-1ï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹éœ€è¦è¢«æŒ‚èµ·</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This node has already set status asking a release</span></span><br><span class="line"><span class="comment">         * to signal it, so it can safely park.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å‰é©±èŠ‚ç‚¹ waitStatus å¤§äº 0ï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†æ’é˜Ÿã€‚</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦çŸ¥é“è¿™ç‚¹ï¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—æ’é˜Ÿçš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œè€Œå”¤é†’çš„æ“ä½œæ˜¯ç”±å‰é©±èŠ‚ç‚¹å®Œæˆçš„ã€‚</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä¸‹é¢è¿™å—ä»£ç è¯´çš„æ˜¯å°†å½“å‰èŠ‚ç‚¹çš„ prev æŒ‡å‘ waitStatus&lt;=0 çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">        <span class="comment">// ç®€å•è¯´ï¼Œå°±æ˜¯ä¸ºäº†æ‰¾ä¸ªæ­£å¸¸çš„å‰é©±èŠ‚ç‚¹ï¼Œå› ä¸ºä½ è¿˜å¾—ä¾èµ–å®ƒæ¥å”¤é†’å‘¢ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆäº†æ’é˜Ÿï¼Œå°±æ— æ³•å”¤é†’ä½ äº†</span></span><br><span class="line">        <span class="comment">// åŒæ—¶è¿™ä¸ªæ“ä½œä¹Ÿä¼šå°†é‚£äº› ws&gt;0 çš„èŠ‚ç‚¹ç§»é™¤æ‰</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span><br><span class="line"><span class="comment">         * need a signal, but don&#x27;t park yet.  Caller will need to</span></span><br><span class="line"><span class="comment">         * retry to make sure it cannot acquire before parking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//è®¾ç½®å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º -1</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™ä¸ªé‡Œé¢å›å‰”é™¤ä¸æ­£å¸¸çš„èŠ‚ç‚¹ï¼Œä¸ºä¸‹é¢çš„å”¤é†’æ“ä½œè€ƒè™‘</p>
<p>ğŸ’¡ åˆ†æ<code>Thread1</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å½“å‰é˜Ÿåˆ—çš„çŠ¶æ€</p>
<p><img src="http://static.imlgw.top/blog/20190809/jOs2WA3R7lGR.png?imageslim" alt="mark"></p>
<p>ğŸ”¸ å› ä¸ºå‰é¢çš„æ“ä½œå¹¶æ²¡æœ‰å¯¹ state è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿›å…¥æœ€åçš„ elseï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º <code>SIGNAL</code></p>
<p>ç„¶å renturn  false å›åˆ° acquireQueued çš„å†…å¾ªç¯</p>
<p>ğŸ”¸ å†æ¬¡å°è¯•è·å–é”ï¼Œ<code>Thread0</code> ä»ç„¶æ²¡æœ‰é‡Šæ”¾é”ï¼Œå¤±è´¥ï¼Œå†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquireï¼Œè¿™ä¸€æ¬¡ç”±äºå·²ç»å°†å‰ç»§èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º<code>SIGNAL</code> æ‰€ä»¥ç›´æ¥ return trueï¼Œè¿›å…¥åé¢çš„ <code>parkAndCheckInterrupt()</code> æ–¹æ³•</p>
<p><strong>æ­¤æ—¶çŠ¶æ€å˜ä¸º</strong></p>
<p><img src="http://static.imlgw.top/blog/20190809/pQ5NOkN5mQTY.png?imageslim" alt="mark"></p>
<h4 id="parkAndCheckInterrupt"><a href="#parkAndCheckInterrupt" class="headerlink" title="parkAndCheckInterrupt()"></a>parkAndCheckInterrupt()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„çº¿ç¨‹<code>Thread1</code>å°±ä¼šè¢«é˜»å¡ä½ï¼Œä¹Ÿä¸ä¼šç»§ç»­è‡ªæ—‹è·å–é”äº†ã€‚</p>
<blockquote>
<p>LockSupport.park() å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ Unsafe æä¾›çš„æŒ‡ä»¤å±äº<code>çº¿ç¨‹é˜»å¡åŸè¯­</code>ï¼Œå¯ä»¥ç†è§£ä¸ºäºŒå…ƒä¿¡å·é‡ï¼ˆåªæœ‰ä¸€ä¸ª permitï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šå“åº” Interrupt  <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008420938">å‚è€ƒ</a></p>
</blockquote>
<p>ğŸ”” <strong>å‡è®¾æ­¤æ—¶åˆæœ‰ä¸€ä¸ªçº¿ç¨‹<code>Thread2</code>è¿‡æ¥äº†ï¼Œå¹¶ä¸”<code>Thread0</code> ä¾ç„¶æ²¡æœ‰é‡Šæ”¾é”</strong></p>
<p>ğŸ”¸ tryAcquire å¤±è´¥</p>
<p>ğŸ”¸addWaiter()ï¼Œ å°†<code>Thread2</code>å’Œæ¨¡å¼åŒ…è£…æˆ Node æ·»åŠ åˆ°é˜Ÿå°¾ï¼ˆè¿™ä¸ªæ—¶å€™å°±ä¸ä¼šè¿›å…¥ enq äº†ï¼Œå› ä¸º tail æ­¤æ—¶ä¸º<code>Thread1</code>å·²ç»ä¸ä¸ºç©ºäº†ï¼‰ç„¶åè¿”å›åŒ…å«<code>Thread2</code>çš„èŠ‚ç‚¹ï¼Œé˜Ÿåˆ—çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/yniIvx1sgpXa.png?imageslim" alt="mark"></p>
<p>ğŸ”¸acquireQueued()ï¼Œæ ¹æ®ä¸Šé¢çš„çŠ¶æ€å›¾ï¼Œè¿™é‡Œå‰ç½®èŠ‚ç‚¹å¹¶ä¸æ˜¯ headï¼Œç›´æ¥è¿›å…¥ shouldParkAfterFailedAcquire()</p>
<p>ğŸ”¸shouldParkAfterFailedAcquire()ï¼Œæ˜æ˜¾å‰é©±èŠ‚ç‚¹çŠ¶æ€å¹¶ä¸æ˜¯<code>SIGNAL</code> è€Œæ˜¯ 0ï¼Œæ‰€ä»¥ç›´æ¥åˆ©ç”¨ CAS è®¾ç½®å‰é©±èŠ‚ç‚¹ä¸º<code>SIGNAL</code>  çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/R7GmOQ4V8ESm.png?imageslim" alt="mark"></p>
<p>å›åˆ° <code>acquireQueued()</code> ç»§ç»­è‡ªæ—‹</p>
<p>ğŸ”¸ å‰ç½®èŠ‚ç‚¹ä¸æ˜¯ headï¼Œè°ƒç”¨ shouldParkAfterFailedAcquire(NodeT1ï¼Œmode)ï¼ŒæˆåŠŸï¼Œè°ƒç”¨ parkAndCheckInterrupt é˜»å¡ï¼Œè‡³æ­¤ï¼Œ<code>Thread1</code>ï¼Œ<code>Thread2</code> éƒ½åœ¨è¿™é‡Œ park ä½äº†ã€‚</p>
<h3 id="unLock"><a href="#unLock" class="headerlink" title="unLock()"></a>unLock()</h3><p>ğŸ”” ç»§ç»­ä¸Šé¢çš„æ¨¡æ‹Ÿï¼Œæ­¤æ—¶<code>Thread0</code>é‡Šæ”¾é” ï¼Œè°ƒç”¨<code>unlock()</code> æ–¹æ³•ï¼Œunlock() ä¼šè°ƒç”¨ AQS ä¸­çš„<code>release(1)</code>æ–¹æ³•</p>
<h4 id="release"><a href="#release" class="headerlink" title="release()"></a>release()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">//è·å–å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">//å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å¤´èŠ‚ç‚¹çš„ waitStatus ä¸æ˜¯ 0</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//unpark åç»§èŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ‰§è¡Œ<code>tryRelease(1)</code> ï¼Œå’Œ<code>tryAcquire()</code> ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•æœ€åæ˜¯äº¤ç»™å­ç±»å»å®ç°çš„</p>
<h4 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease()"></a>tryRelease()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">//åŒæ­¥çŠ¶æ€å‡ 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="comment">//è§£é”çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œè§£é“ƒè¿˜é¡»ç³»é“ƒäºº</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">//å’Œä¸Šé¢ä¸€æ ·è¿™é‡Œä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ°è¾¾è¿™é‡Œ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//ä¸ä¸º 0 åˆ™ä»£è¡¨è¢«é‡å…¥äº†ï¼Œéœ€è¦å¤šæ¬¡ release ç›´åˆ° 0 æ‰ä¼šé‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tryRelease() æˆåŠŸç»§ç»­æ‰§è¡Œåé¢çš„è¯­å¥ï¼Œçœ‹ä¸€ä¸‹å½“å‰ AQS é˜Ÿåˆ—çš„çŠ¶æ€</p>
<p><img src="http://static.imlgw.top/blog/20190809/R7GmOQ4V8ESm.png?imageslim" alt="mark"></p>
<p>ğŸ”¸ å¤´èŠ‚ç‚¹ head ! =null å¹¶ä¸” head.waitState ä¸æ˜¯ 0ï¼Œæ‰§è¡Œ unparkSuccessor().</p>
<h4 id="unparkSuccessor"><a href="#unparkSuccessor" class="headerlink" title="unparkSuccessor()"></a>unparkSuccessor()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹çš„ ws å°äº 0 å°±è®¾ç½®ä¸º 0ï¼Œå…è®¸å¤±è´¥</span></span><br><span class="line">        <span class="comment">//å…¶å®æ˜¯ç‹¬å é”çš„è¯è¿™é‡Œè‚¯å®šä¸ä¼šå¤±è´¥ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//release æ‰§è¡Œå®Œä¹‹åï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«ç§»é™¤æ‰ã€‚ç„¶åè¢« GC</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//è·å–åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="comment">//åç»§èŠ‚ç‚¹ä¸ºç©ºï¼Œæˆ–è€…å·²ç»æ’¤é”€äº†ï¼Œå–æ¶ˆæŠ¢é”ï¼ˆ1&gt;0ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//ä»åå¾€å‰éå†æ‰¾åˆ°æ­£æ•°ç¬¬ä¸€ä¸ª waitStatus&lt;0 çš„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">//ç„¶åé‡Šæ”¾å®ƒ</span></span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ <code>Thread1</code> è¢«<code>unpark()</code> ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›<code>Thread1</code>çš„ ä¸­æ–­æ ‡å¿—ä½ï¼Œå¹¶å¤åŸä¸º falseï¼Œç»“æŸ<code>parkAndCheckInterrupt()</code>æ–¹æ³•ï¼Œå†æ¬¡å›åˆ°<code>acquireQueued()</code> çš„å¾ªç¯ä¸­æ‰§è¡Œç¬¬ä¸€ä¸ª if</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">    <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">        setHead(node);</span><br><span class="line">        p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">        failed = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> interrupted; <span class="comment">//è¿”å›ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">        interrupted = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ ç”±äº<code>Thread0</code> å·²ç»é‡Šæ”¾é”ï¼ŒåŒæ­¥çŠ¶æ€å·²ç»å˜ä¸º 0ï¼Œ<code>Thread1</code> å¯ä»¥ç›´æ¥<code>tryAcquire</code>è·å–åˆ°é”ï¼Œç„¶åè®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œå°†ä¹‹å‰çš„ head èŠ‚ç‚¹<strong>ç§»é™¤</strong>ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€ï¼Œç”±äºä¹‹å‰ park æœŸé—´æ²¡æœ‰è¢«ä¸­æ–­ç›´æ¥<code>return false</code>ï¼Œacquire æˆåŠŸï¼ï¼ï¼ <code>Thread1</code> è·å¾—é”ï¼ï¼ï¼</p>
<p>â“ <strong>ä¸ºä»€ä¹ˆè¦ä»åå¾€å‰éå†ï¼Ÿ</strong></p>
<blockquote>
<p>è¿™é‡Œçœ‹äº†ä¸€äº›åšå®¢ä»‹ç»ï¼Œå¤§æ¦‚æœ‰ä¸¤ä¸ªè¯´æ³•ï¼Œä¸€ä¸ªæ˜¯åœ¨<code>enq()</code> æ–¹æ³•é‡Œé¢ï¼Œå…ˆè®¾ç½®çš„<code>node.prev = pred;</code>å†æ‰§è¡Œçš„ CAS æœ€åæ‰§è¡Œçš„<code>t.next = node;</code> CAS æˆåŠŸå next ä¹Ÿè®¸è¿˜æ²¡æœ‰è®¾ç½®æˆåŠŸï¼Œä»å‰å¾€åéå†æœ‰å¯èƒ½æ‰¾ä¸åˆ°è¿™ä¸ªåˆšåŠ å…¥çš„èŠ‚ç‚¹ï¼›å…¶æ¬¡ï¼Œåœ¨<code>cancelAcquire(node);</code> çš„æœ€åä¸€æ­¥æœ‰ä¸€ä¸ª<code>node.next=node</code>çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä»å‰å¾€åéå†ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚</p>
</blockquote>
<p>â“ <strong>ä»åå¾€å‰éå†æ‰¾åˆ°æœ€å‰é¢ç¬¬ä¸€ä¸ª waitStatus&lt;0 çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ“ä½œå¦‚æœè¿”å›çš„æ˜¯ä¸ªä¸­é—´èŠ‚ç‚¹æ€ä¹ˆåŠï¼Ÿ</strong></p>
<blockquote>
<p>ä¸è¦æ€•ï¼Œæˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œé¦–å…ˆå®ƒæ˜¯ä¸ªä¸­é—´èŠ‚ç‚¹è€Œä¸”æ˜¯å…¬å¹³é”ï¼Œå®ƒæœ‰å‰é©±èŠ‚ç‚¹ï¼Œunpark åè‚¯å®šè·å–ä¸åˆ°é”ï¼ˆå…¬å¹³é”éœ€è¦æ£€æµ‹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼‰ï¼Œç„¶åæ‰§è¡Œ<code>shouldParkAfterFailedAcquire()</code>ï¼Œè¿˜è®°å¾—è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„ä¸€ä¸ªæ“ä½œä¹ˆï¼Ÿï¼Ÿå¦‚æœå‰é©±èŠ‚ç‚¹çŠ¶æ€&gt;0ï¼Œä»–å°±ä¼šæ¸…é™¤è¿™äº›ä¸æ­£å¸¸çš„èŠ‚ç‚¹ï¼Œè¿”å› falseï¼Œä¸ park è‡ªæ—‹ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯è¿™ä¸ªèŠ‚ç‚¹åœ¨è·å–é”å°±å¯ä»¥è·å–åˆ°äº†ï¼Œå¦™å“‰ï¼ï¼ï¼</p>
</blockquote>
<p>æ³¨æ„** setHead **æ˜¯è¿™æ ·çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    head = node;</span><br><span class="line">    node.thread = <span class="literal">null</span>; <span class="comment">//è®¾ç½®çº¿ç¨‹ä¸º null</span></span><br><span class="line">    node.prev = <span class="literal">null</span>; <span class="comment">//è®¾ç½®å‰é©±ä¸ºç©º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/wFDlbQTu417I.png?imageslim" alt="mark"></p>
<p>å†å¾€åå°±æ˜¯é‡å¤å‰é¢çš„è¿‡ç¨‹å•¦ã€‚</p>
<h3 id="éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«"><a href="#éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«" class="headerlink" title="éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«"></a>éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«</h3><p>ä¸Šé¢æ˜¯ä»‹ç»çš„å…¬å¹³é”ï¼Œæ‰€è°“çš„å…¬å¹³å°±æ˜¯å…ˆæ¥ååˆ° FIFOã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹éå…¬å¹³é”çš„ lock å’Œ nonfairTryAcquire() çš„å®ç°ï¼Œè¿™ä¸¤ä¸ªé”çš„åŒºåˆ«å…¶å®å°±æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<h4 id="lock"><a href="#lock" class="headerlink" title="lock()"></a>lock()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°éå…¬å¹³é”<code>lock()</code>çš„æ—¶å€™ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€å…ˆ CAS è¯•ä¸€ä¸‹èƒ½ä¸èƒ½è·å–åˆ°é”ï¼Œè·å–åˆ°å°±ç›´æ¥è¿”å›</p>
<h4 id="nonfairTryAcquire"><a href="#nonfairTryAcquire" class="headerlink" title="nonfairTryAcquire()"></a>nonfairTryAcquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯”å…¬å¹³é”çš„å®ç°ï¼Œä¼šå‘ç°å°‘äº†<code>hasQueuedPredecessors()</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœå‰é¢<code>lock()</code> çš„æ—¶å€™æ²¡æœ‰ CAS æˆåŠŸï¼Œåˆ°è¿™é‡Œåå¦‚æœä¹‹å‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œå®ƒåˆä¼šå†æ¬¡å°è¯• CAS è·å–é”ï¼Œè¿™é‡Œå…¶å®å°±ä½“ç°äº†éå…¬å¹³é”çš„ç‰¹ç‚¹ï¼Œ**å…ˆç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¸€å®šèƒ½å…ˆè·å–åˆ°é”ï¼Œä¸­é—´å…è®¸æœ‰äºº<code>&quot;æ’é˜Ÿ&quot;</code>**ï¼Œå¦‚æœè¿™ä¸€æ¬¡è¿˜æ˜¯å¤±è´¥äº†ï¼Œå°±ä¼šå’Œå…¬å¹³é”ä¸€æ ·è€è€å®å®å»ç­‰å¾…é˜Ÿåˆ—ä¸­æ’é˜Ÿ</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œéå…¬å¹³é”çš„æ€§èƒ½ä¼šæ¯”å…¬å¹³é”å¥½ï¼Œè€Œéå…¬å¹³é”å¯èƒ½ä¼šå¯¼è‡´æ’åœ¨åé¢çš„çº¿ç¨‹é¥¥é¥¿</p>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><p><img src="http://static.imlgw.top/blog/20190810/6FEWGydOmVzm.png?imageslim" alt="mark"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><strong>ã€ŠJava å¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹</strong></p>
<p><a target="_blank" rel="noopener" href="https://javadoop.com/2017/06/16/AbstractQueuedSynchronizer/">ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pfnie/article/details/53191892">AbstractQueuedSynchronizer æºç å‰–æï¼ˆå…­ï¼‰- æ·±åˆ»è§£æä¸æ¨¡æ‹Ÿçº¿ç¨‹ç«äº‰èµ„æº</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008420938">[æµ…è°ˆ Java å¹¶å‘ç¼–ç¨‹ç³»åˆ—ï¼ˆå…«ï¼‰â€”â€” LockSupport åŸç†å‰–æ]</a></p>
<p><a target="_blank" rel="noopener" href="https://brightloong.github.io/2018/06/21/Java%E5%90%8C%E6%AD%A5%E5%99%A8%E2%80%94%E2%80%94AQS%E5%AD%A6%E4%B9%A0/">Java åŒæ­¥å™¨â€”â€”AQS å­¦ä¹ </a></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
