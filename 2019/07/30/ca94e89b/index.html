<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        ThreadPoolExecutor æºç è§£æ - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5-ThreadPoolExecutor-%E6%BA%90%E7%A0%81"><span class="toc-text">æ·±å…¥ ThreadPoolExecutor æºç </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%BB%93%E6%9E%84"><span class="toc-text">ç±»ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81"><span class="toc-text">çº¿ç¨‹æ± çŠ¶æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B"><span class="toc-text">çŠ¶æ€è½¬æ¢è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-text">æˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#execute"><span class="toc-text">execute()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addWorker"><span class="toc-text">addWorker()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addWorkerFailed"><span class="toc-text">addWorkerFailed()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Worker-%E7%B1%BB"><span class="toc-text">Worker ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runWorker"><span class="toc-text">runWorker()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getTask"><span class="toc-text">getTask()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#processWorkerExit"><span class="toc-text">processWorkerExit()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryTerminate"><span class="toc-text">tryTerminate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shutdown"><span class="toc-text">shutdown()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interruptIdleWorkers"><span class="toc-text">interruptIdleWorkers()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shutdownNow"><span class="toc-text">shutdownNow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interruptWorkers"><span class="toc-text">interruptWorkers()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E6%98%AF%E9%AD%94%E9%AC%BC"><span class="toc-text">ç»†èŠ‚æ˜¯é­”é¬¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutor-%E4%BD%BF%E7%94%A8"><span class="toc-text">ThreadPoolExecutor ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%85%B3%E9%97%AD"><span class="toc-text">çº¿ç¨‹æ± çš„å…³é—­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95"><span class="toc-text">å·¥å‚æ–¹æ³•</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        ThreadPoolExecutor æºç è§£æ
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2019-07-30 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#å¤šçº¿ç¨‹" title="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#å¹¶å‘ç¼–ç¨‹" title="å¹¶å‘ç¼–ç¨‹">å¹¶å‘ç¼–ç¨‹</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="æ·±å…¥-ThreadPoolExecutor-æºç "><a href="#æ·±å…¥-ThreadPoolExecutor-æºç " class="headerlink" title="æ·±å…¥ ThreadPoolExecutor æºç "></a>æ·±å…¥ ThreadPoolExecutor æºç </h2><h3 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h3><p><img src="http://static.imlgw.top/blog/20190802/wTkHh1NbyM8K.png?imageslim" alt="mark"></p>
<p>è¿™é‡Œä¸»è¦è¦è¯´çš„æ˜¯ <code>ThreadPoolExecutor</code>ç±»</p>
<h3 id="çº¿ç¨‹æ± çŠ¶æ€"><a href="#çº¿ç¨‹æ± çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çŠ¶æ€"></a>çº¿ç¨‹æ± çŠ¶æ€</h3><p>æ‰“å¼€æºç æ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯è¿™å‡ ä¸ªå­—æ®µå’Œæ–¹æ³•ï¼Œå¯¹åº”çš„å°±æ˜¯çº¿ç¨‹æ± çš„ä¸€äº›è¿è¡ŒçŠ¶æ€å’Œç›¸å…³æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ§åˆ¶çº¿ç¨‹æ± ä¸­æ•°é‡å’ŒçŠ¶æ€çš„å­—æ®µï¼Œç”¨ AtomicInteger ä¿å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//count bit é¡¾åæ€ä¹‰å°±æ˜¯ workerCount çš„ä½æ•°ï¼Œè¿™é‡Œæ˜¯ 29</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">//1&lt;&lt;29 -1 == 1111....1111(29 ä¸ª 1) çº¿ç¨‹æ•° (workerCount) ä¸Šé™ å¤§çº¦ 5 äº¿</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span>   <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line"><span class="comment">//é«˜ä¸‰ä½å­˜æ”¾çŠ¶æ€ï¼Œç›¸åº”çš„ä½ 29 ä½å°±æ˜¯ workerCount</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"><span class="comment">// æ‹†è§£ ctl è·å–çŠ¶æ€å’Œæ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="comment">// æ‹¼æ¥çŠ¶æ€å’Œæ•°é‡å¾—åˆ° ctl</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="çŠ¶æ€è½¬æ¢è¿‡ç¨‹"><a href="#çŠ¶æ€è½¬æ¢è¿‡ç¨‹" class="headerlink" title="çŠ¶æ€è½¬æ¢è¿‡ç¨‹"></a>çŠ¶æ€è½¬æ¢è¿‡ç¨‹</h4><p><img src="http://static.imlgw.top/blog/20190802/EWlphYbCMVjv.png?imageslim" alt="mark"></p>
<p>ğŸ’¡ <strong>RUNNING</strong> ï¼šèƒ½æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¹Ÿèƒ½å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›</p>
<p>ğŸ’¡ <strong>SHUTDOWN</strong>ï¼šå…³é—­çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œä½†å´å¯ä»¥ç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­å·²ä¿å­˜çš„ä»»åŠ¡ã€‚åœ¨çº¿ç¨‹æ± å¤„äº <code>RUNNING</code> çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ <code>shutdown()</code>æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€ã€‚ï¼ˆ<code>finalize()</code> æ–¹æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šè°ƒç”¨ shutdown() æ–¹æ³•è¿›å…¥è¯¥çŠ¶æ€ï¼‰</p>
<p>ğŸ’¡ <strong>STOP</strong>ï¼šä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ã€‚åœ¨çº¿ç¨‹æ± å¤„äº <code>RUNNING</code> æˆ– <code>SHUTDOWN</code> çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ <code>shutdownNow()</code> æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€</p>
<p>ğŸ’¡ <strong>TIDYING</strong>ï¼šå¦‚æœæ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ˆæ­¢äº†ï¼ŒworkerCount ï¼ˆæœ‰æ•ˆçº¿ç¨‹æ•°ï¼‰ ä¸º 0ï¼Œçº¿ç¨‹æ± è¿›å…¥è¯¥çŠ¶æ€åä¼šè°ƒç”¨ terminated() æ–¹æ³•è¿›å…¥ TERMINATED çŠ¶æ€</p>
<p>ğŸ’¡ <strong>TERMINATED</strong>ï¼šåœ¨ terminated() æ–¹æ³•æ‰§è¡Œå®Œåè¿›å…¥è¯¥çŠ¶æ€ï¼Œé»˜è®¤ terminated() æ–¹æ³•ä¸­ä»€ä¹ˆä¹Ÿæ²¡æœ‰åšã€‚</p>
<p>è¿›å…¥<code>TERMINATED</code>çš„æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± ä¸æ˜¯ RUNNING çŠ¶æ€ï¼›</li>
<li>çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ TIDYING çŠ¶æ€æˆ– TERMINATED çŠ¶æ€ï¼›</li>
<li>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯ SHUTDOWN å¹¶ä¸” workerQueue ä¸ºç©ºï¼›</li>
<li>workerCount ä¸º 0ï¼›</li>
<li>è®¾ç½® TIDYING çŠ¶æ€æˆåŠŸã€‚</li>
</ul>
<h3 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h3><p>å†å¾€ä¸‹ï¼Œå°±ä¼šçœ‹è§ä¸€äº›å¾ˆé‡è¦çš„æˆå‘˜å˜é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue; </span><br><span class="line"><span class="comment">//å¯é‡å…¥é”ï¼Œçº¿ç¨‹æ± ä¸»è¦çš„é”</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">//çº¿ç¨‹é›†åˆï¼ˆçº¿ç¨‹æ± çš„ workers é›†åˆï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br><span class="line"><span class="comment">//å¯¹åº”çš„æ¡ä»¶å˜é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition(); </span><br><span class="line"><span class="comment">//ç”¨æ¥è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»å‡ºç°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå’Œçº¿ç¨‹æ± å®¹é‡æ²¡æœ‰å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> largestPoolSize;</span><br><span class="line"><span class="comment">//ç”¨æ¥è®°å½•å·²ç»æ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> completedTaskCount; </span><br><span class="line"><span class="comment">//å·¥å‚æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory; </span><br><span class="line"><span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler; </span><br><span class="line"><span class="comment">//çº¿ç¨‹é—²ç½®æ—¶å€™çš„æœ€å¤§å­˜æ´»æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> keepAliveTime; </span><br><span class="line"><span class="comment">//æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹é—²ç½®çš„æ—¶å€™è¶…æ—¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut; </span><br><span class="line"><span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize; </span><br><span class="line"><span class="comment">//æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize; </span><br><span class="line"><span class="comment">//é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼šAbortPolicy ç›´æ¥æ‹’ç»å¹¶æŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">defaultHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbortPolicy</span>();</span><br></pre></td></tr></table></figure>

<h3 id="execute"><a href="#execute" class="headerlink" title="execute()"></a>execute()</h3><p> <strong>æºç åˆ†æ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–çº¿ç¨‹æ± çš„çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123; <span class="comment">//workerCount å°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line">        <span class="comment">//å°†ä»»åŠ¡æ·»åŠ åˆ° workers ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦æ ¹æ® corePoolSize æ¥æ·»åŠ çº¿ç¨‹ï¼Œfalse åˆ™æ ¹æ® maxPoolSize</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//æ·»åŠ å¤±è´¥ï¼Œé‡æ–°è·å– ctl</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¸Šé¢æ·»åŠ åˆ° workers ä¸­å¤±è´¥ï¼Œæœ‰å¯èƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¸å¤Ÿç”¨äº†æˆ–è€…çº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">    <span class="comment">//å¦‚æœçº¿ç¨‹æ± æ˜¯ Running çŠ¶æ€ å°è¯•æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—æˆåŠŸï¼Œé‡æ–°è·å– ctl</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">//å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯ Running çŠ¶æ€å°±ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ remove è¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command); <span class="comment">//é‡‡ç”¨æ‹’ç»ç­–ç•¥æ‹’ç»è¯¥ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//çº¿ç¨‹æ±  Running ä½†æ˜¯æ²¡æœ‰çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä½†æ˜¯ä¸ä¼ å…¥ Runnableï¼ˆå·²ç»åœ¨é˜»å¡é˜Ÿåˆ—ä¸­äº†ï¼‰</span></span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">    <span class="comment">//1. çº¿ç¨‹æ± ä¸æ˜¯ Running çŠ¶æ€å¹¶ä¸” command ä¸ä¸º nullï¼ŒaddWorker ä¼šç›´æ¥ false ç„¶åæ‹’ç»è¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="comment">//2. æ·»åŠ åˆ° workQueueï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯ queue æ»¡äº†ï¼Œå¯èƒ½æ˜¯éœ€è¦æ‰©å®¹äº†</span></span><br><span class="line">    <span class="comment">//   æ‰€ä»¥åé¢çš„å‚æ•°æ˜¯ falseï¼Œæ·»åŠ å¤±è´¥ä¹Ÿä¼šç›´æ¥æ‹’ç»</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦ç†è§£ addWorker çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œtrue åˆ™ä»£è¡¨å½“å‰çº¿ç¨‹æ± çš„<strong>ä¸Šç•Œ</strong>ä»ç„¶æ˜¯ corePoolSizeï¼Œåé¢çš„ addWorker ä¼šæ ¹æ®ä¸Šç•Œæ¥åˆ¤æ–­æ˜¯å¦å¢åŠ çº¿ç¨‹ï¼Œfalse åˆ™ä»£è¡¨<strong>ä¸Šç•Œ</strong>æ˜¯ maximumPoolSizeï¼Œè¿™ä¸€ç‚¹åœ¨åé¢çš„åˆ†æä¸­ä¼šçœ‹åˆ°ã€‚</p>
<p><strong>Executor å¤§è‡´æ‰§è¡Œæµç¨‹</strong></p>
<p><img src="http://static.imlgw.top/blog/20190803/j3xQrmOkc3Kl.png?imageslim" alt="mark"></p>
<h3 id="addWorker"><a href="#addWorker" class="headerlink" title="addWorker()"></a>addWorker()</h3><p><code>addWorker()</code> çš„ä½œç”¨å°±æ˜¯åˆ›å»ºçº¿ç¨‹ (Worker) å¹¶ä¸”æ·»åŠ åˆ° Workers é›†åˆä¸­ï¼Œç„¶åå¯åŠ¨çº¿ç¨‹</p>
<p><strong>æºç åˆ†æ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rs&gt;=SHUTDOWN è¯´æ˜ä¸æ˜¯ RUNNING çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; !(rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span> &amp;&amp;!workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">            <span class="comment">//å¦‚æœå¤§äºå¯å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæˆ–è€…å¤§äºå½“å‰çš„çº¿ç¨‹æ± çš„ä¸Šç•Œï¼Œç›´æ¥ false</span></span><br><span class="line">            <span class="comment">//ä¸Šé¢ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°çš„ä½œç”¨ä½“ç°å‡ºæ¥äº†ï¼Œä¸º true ä¸Šç•Œåˆ™æ˜¯ corePoolSize</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//åˆ©ç”¨ CAS è‡ªå¢ å¢å¤§ workCount çº¿ç¨‹æ•°ï¼ŒæˆåŠŸåå°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            <span class="comment">//CAS å¤±è´¥ï¼Œé‡æ–°è·å– ctl</span></span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¿˜æ˜¯ä¸æ˜¯ Running çŠ¶æ€ï¼ˆèƒ½åˆ°è¿™é‡Œè¯´æ˜ rs==Running çŠ¶æ€ï¼‰ï¼Œä¸æ˜¯çš„è¯å°±è·³å‡ºå»é‡æ–°æ¥è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">            <span class="comment">// CAS å¤±è´¥å¹¶ä¸”è¿˜æ˜¯ Running çŠ¶æ€ï¼Œç»§ç»­è‡ªæ—‹å°è¯•è‡ªå¢</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ˜¯å¦å¯åŠ¨ï¼Œä»¥åŠçº¿ç¨‹æ˜¯å¦æ·»åŠ </span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ª Workerï¼ˆå¯¹çº¿ç¨‹çš„å°è£…ï¼‰</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line">				<span class="comment">//æ˜¯ RUNNING çŠ¶æ€ æˆ–è€… æ˜¯ SHUTDOWN çŠ¶æ€ä¸”æ²¡æœ‰æäº¤ä»»åŠ¡ (SHUTDOWN çŠ¶æ€è¿˜å¯ä»¥æ‰§è¡Œé˜»å¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                    <span class="comment">//æ·»åŠ åˆ°å·¥ä½œé›†ä¸­</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s; <span class="comment">//è®°å½•æœ€å¤§å€¼</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>; <span class="comment">//æ·»åŠ æˆåŠŸ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">//å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ Worker çš„ run æ–¹æ³•</span></span><br><span class="line">                t.start(); </span><br><span class="line">                workerStarted = <span class="literal">true</span>; <span class="comment">//å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            <span class="comment">//å¯åŠ¨å¤±è´¥ï¼Œå›æ»š workers å¹¶å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦é€‚åˆç»§ç»­ addWorkerï¼Œåˆ†æè¿™é‡Œçš„ if æ¡ä»¶ï¼ŒRUNNING ä¸ä¼š false ï¼ŒSTOPï¼ŒTIDYINGï¼ŒTERMINATED ç›´æ¥ falseï¼ŒSHUTDOWN çŠ¶æ€å¦‚æœ firstTask ä¸ºç©º é˜»å¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡çš„æ—¶å€™ä¸ä¼š falseï¼Œå…¶ä»–æƒ…å†µéƒ½ falseã€‚</p>
<p>ğŸ”¸ è·å–å½“å‰çš„ workerCount åˆ¤æ–­æ˜¯å¦è¶…è¿‡äº†å½“å‰çš„ä¸Šç•Œï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†ç¬¬äºŒä¸ªå‚æ•°</p>
<p>ğŸ”¸ ç„¶ååˆ©ç”¨ CAS è‡ªæ—‹å¢åŠ  workerCount</p>
<p>ğŸ”¸ åˆ›å»º Worker å¯¹è±¡ï¼Œè·å– mainLock å¹¶åŠ é”ï¼Œå› ä¸º workers æ˜¯ HashSet å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>ğŸ”¸ å†æ¬¡è·å–çº¿ç¨‹æ± è½¬å°å¹¶åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œåˆæ³•å°±æ·»åŠ åˆ° workers ä¸­ï¼Œç„¶ååœ¨ finally å—ä¸­é‡Šæ”¾é”</p>
<p>ğŸ”¸ æ ¹æ®å‰é¢çš„ workerAdded åˆ¤æ–­æ˜¯å¦å¯åŠ¨çº¿ç¨‹</p>
<p>ğŸ”¸ åœ¨æœ€ç»ˆçš„ finally å—ä¸­æ ¹æ®æ˜¯å¦å¯åŠ¨æˆåŠŸæ¥å†³å®šæ˜¯å¦å›æ»š</p>
<h3 id="addWorkerFailed"><a href="#addWorkerFailed" class="headerlink" title="addWorkerFailed()"></a>addWorkerFailed()</h3><p>å¯åŠ¨å¤±è´¥ï¼Œå›æ»šä¹‹å‰çš„æ·»åŠ æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWorkerFailed</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">//è·å–é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">//ä» workers ä¸­ç§»é™¤</span></span><br><span class="line">            workers.remove(w);</span><br><span class="line">        <span class="comment">//å‡å°‘ workerCount</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        <span class="comment">//å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Worker-ç±»"><a href="#Worker-ç±»" class="headerlink" title="Worker ç±»"></a>Worker ç±»</h3><p>å°è£…äº†çº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹æ± ç»´æŠ¤çš„å°±æ˜¯è¿™äº› worker</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This class will never be serialized, but we provide a</span></span><br><span class="line"><span class="comment">     * serialVersionUID to suppress a javac warning.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line">    <span class="comment">/** Initial task to run.  Possibly null. */</span></span><br><span class="line">    Runnable firstTask; <span class="comment">//ä¼ å…¥çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">/** Per-thread task counter */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates with given first task and thread from ThreadFactory.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstTask the first task (null if none)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">        setState(-<span class="number">1</span>); <span class="comment">// è®¾ç½®çŠ¶æ€ä¸º -1</span></span><br><span class="line">        <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="comment">//æ ¹æ®å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//å°† Worker ä¼ é€’è¿›å»ï¼Œä½œä¸º Thread çš„å‚æ•°</span></span><br><span class="line">        <span class="comment">//new Thread(Worker worker);</span></span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        runWorker(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lock methods</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">    <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line">    <span class="comment">// æ˜¯å¦è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getState() != <span class="number">0</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨ CAS è®¾ç½® state</span></span><br><span class="line">        <span class="comment">//å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯ä¸ªä¸å¯é‡å…¥çš„ç‹¬å é”ï¼Œå…·ä½“å¯ä»¥å¯¹æ¯” ReentrantLock çš„å®ç°æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//ç»§æ‰¿è‡ª AbstractOwnableSynchronizer</span></span><br><span class="line">            <span class="comment">//ä¿å­˜å½“å‰çš„æŒæœ‰é”çš„çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”è®¾ç½® state=0</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®ç‹¬å é”çº¿ç¨‹ä¸ºç©º</span></span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>        &#123; acquire(<span class="number">1</span>); &#125; <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨ tryAcquire(1);</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>      &#123; release(<span class="number">1</span>); &#125; <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨ tryRelease(1);</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“æ–­å·²ç»å¯åŠ¨çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">interruptIfStarted</span><span class="params">()</span> &#123;</span><br><span class="line">        Thread t;</span><br><span class="line">        <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="literal">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ° Worker ç»§æ‰¿äº† AQS å¹¶ä¸”å®ç°äº† Runnable æ¥å£ï¼Œç„¶åå€ŸåŠ© AQS å®ç°äº†ä¸€ä¸ª<code>ç‹¬å çš„ä¸å¯é‡å…¥çš„é”</code>ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯å¾ˆå·§å¦™çš„ä¸€ç‚¹ï¼ˆè¿™é‡Œæˆ‘å’Œåšå®¢ä¸Šçš„ç†è§£æœ‰ç‚¹å‡ºå…¥ï¼‰ã€‚</p>
<p>åˆ°è¿™é‡Œå¤§å®¶è‚¯å®šä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¦å®ç° AQS ç„¶åå®ç°ä¸€ä¸ªé”ï¼Ÿæ—¢ç„¶è¦åˆä¸ºä»€ä¹ˆè¦å®ç°ä¸€ä¸ªä¸å¯é‡å…¥çš„ï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨<code>ReentrantLock</code> é‚£ä¸æ˜¯æ›´åŠ æ–¹ä¾¿ä¹ˆï¼Ÿï¼Ÿé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚å°±æ˜¯æ„é€ å™¨é‡Œé¢ä¸ºä»€ä¹ˆ<code>setState(-1)</code>  è¿™æ ·ä¸å°±è·å–ä¸åˆ°é”äº†ä¹ˆï¼Ÿï¼Ÿ</p>
<p>å…¶å®è¿™æ˜¯ä¸ºäº†åé¢<code>shutdown</code>çš„æ—¶å€™<code>interruptIdleWorkers</code>èƒ½åˆ¤æ–­å‡ºçº¿ç¨‹æ˜¯å¦åœ¨å·¥ä½œï¼Œä»è€Œæ‰“æ–­é‚£äº›ç©ºé—²çš„çº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨å¯é‡å…¥é”çš„è¯å°±æ— æ³•é€šè¿‡<code>tryLock()</code> æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨å·¥ä½œã€‚è€Œ<code>setState(-1)</code> åˆ™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ä»»åŠ¡æ²¡æœ‰å¼€å§‹å‰è¢«æ‰“æ–­</p>
<h3 id="runWorker"><a href="#runWorker" class="headerlink" title="runWorker()"></a>runWorker()</h3><p>åœ¨ä¸Šé¢<code>AddWorker()</code>æœ€åæ·»åŠ æˆåŠŸåä¼šå¯åŠ¨ Worker çº¿ç¨‹ï¼Œè€Œåœ¨ worker çº¿ç¨‹ä¸­ run æ–¹æ³•åˆä¼šè°ƒç”¨ä¸€ä¸ª<code>runWorker()</code>æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯å…·ä½“æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="comment">//å½“å‰æ‰§è¡Œçº¿ç¨‹</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask; </span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//å‰é¢æ„é€  worker çš„æ—¶å€™è®¾ç½®äº† state=-1</span></span><br><span class="line">    <span class="comment">//è®¾ç½® state ä¸º 0ï¼ŒtryRelease(1)</span></span><br><span class="line">    <span class="comment">//å…¶å®è¿™æ ·æ˜¯ä¸ºäº†åœ¨è¿™ä¹‹å‰ä¸ä¼šè¢«æ‰“æ–­ï¼ˆè¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼‰</span></span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>; <span class="comment">//æ˜¯å¦å› ä¸ºå¼‚å¸¸è€Œé€€å‡ºï¼Ÿ</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//task ä¸ºç©ºå°±ä»é˜»å¡é˜Ÿåˆ—ä¸­æ‹¿ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//åŠ é”ï¼Œä½†æ˜¯è¿™ä¸ªé”ä¸ä¼šå’Œå…¶ä»–çš„ Worker äº’æ–¥ï¼Œè¿™ä¸ªé”åªæ˜¯ç”¨æ¥åˆ¤æ–­ worker æ˜¯å¦åœ¨å·¥ä½œ</span></span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                <span class="comment">//æ‰“æ–­å½“å‰æ‰§è¡Œçº¿ç¨‹ wt</span></span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++; <span class="comment">//å®Œæˆä»»åŠ¡æ•°++</span></span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>; <span class="comment">//ä¸‹é¢çš„æ”¶å°¾å·¥ä½œä¼šæ ¹æ®è¿™ä¸ªåˆ¤æ–­æ˜¯å¦è°ƒæ•´çº¿ç¨‹æ•°</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        processWorkerExit(w, completedAbruptly); <span class="comment">//æ”¶å°¾å·¥ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ é¦–å…ˆè·å–äº†å‚æ•°ä¼ é€’è¿›æ¥çš„ worker æºå¸¦çš„ä»»åŠ¡</p>
<p>ğŸ”¸ ç„¶åæ‰§è¡Œäº† w.unlock()ï¼Œå®é™…ä¸Šè¿™é‡Œå°±å¯¹åº”äº†ä¸Šé¢ Worker ç±»æ„é€ å™¨ä¸­çš„ setState(-1)ï¼Œæ­£å› ä¸ºå‰é¢è®¾ç½®äº† state ä¸º -1 æ‰€ä»¥åœ¨ unlock() ä¹‹å‰ï¼Œè·å¾—é”çš„ CAS æ“ä½œè‚¯å®šéƒ½ä¼šå¤±è´¥ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ä¸ºäº†åœ¨ä»»åŠ¡å¯åŠ¨å‰ä¸ä¼šè¢«æ‰“æ–­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ unlock() å°±åˆå°† state è®¾ç½®ä¸ºäº† 0 ä¹Ÿå°±è¡¨ç¤ºå¯ä»¥é€šè¿‡ CAS è·å¾—é”äº†ï¼Œä¹Ÿå¯ä»¥è¢« shutdown æ‰“æ–­äº†ã€‚</p>
<p>ğŸ”¸ ç„¶åè¿™ä¸ªçº¿ç¨‹å°±ä¼šæ‰§è¡Œ worker ä¸­çš„ä»»åŠ¡ï¼Œå¦‚æœ worker ä¸­ä»»åŠ¡ä¸ºç©ºå°±ä¼šä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</p>
<p>ğŸ”¸ è·å–åˆ°ä»»åŠ¡åè¿›å…¥å¾ªç¯å…ˆè¿›è¡Œ lock() æ“ä½œï¼Œè¿™å°±ä»£è¡¨å·²ç»å¼€å§‹æ‰§è¡Œä»»åŠ¡äº†ï¼Œè¿™ä¸ªæ—¶å€™ shutdown å°±æ— æ³•å‘é€ä¸­æ–­ä¿¡å·ä¸­æ–­è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œ ï¼ˆæ³¨æ„è¿™ä¸ª lock å¹¶ä¸ä¼šå’Œå…¶ä»–çš„ worker äº’æ–¥ï¼Œå› ä¸ºæ¯ä¸ª Worker éƒ½æ˜¯æ–° new å‡ºæ¥çš„ï¼Œå®Œå…¨ä¸ç›¸å…³çš„ï¼Œä»–ä»¬çš„ state çŠ¶æ€éƒ½æ˜¯ç‹¬ç«‹çš„ï¼‰</p>
<p>ğŸ”¸ <code>runStateAtLeast(ctl.get(), STOP)</code> è¿”å›<code>ctl.get() &gt;= STOP</code>  ï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨å…³é—­å¦‚æœæ˜¯å°±æ‰“æ–­è¯¥çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯éœ€è¦ç¡®ä¿çº¿ç¨‹ä¸æ˜¯ Interrupt çŠ¶æ€</p>
<p><code>If pool is stopping, ensure thread is interrupted;  if not, ensure thread is not interrupted.</code></p>
<p>ğŸ”¸<code>beforeExecute()</code> å’Œ<code>afterExecute()</code> éƒ½æ˜¯ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°çš„ã€‚</p>
<p>ğŸ”¸ åˆ° finally å—é‡Œé¢å°±ä»£è¡¨è¿™ä¸ªå·¥ä½œçº¿ç¨‹å·²ç»å¿«è¦ç»“æŸäº†ï¼Œ<code>processWorkerExit()</code>  å°±æ˜¯å¤„ç†ä¸€äº›â€åäº‹â€çš„</p>
<h3 id="getTask"><a href="#getTask" class="headerlink" title="getTask()"></a>getTask()</h3><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„ï¼Œå¦‚æœ <code>getTask()</code> è¿”å› nullï¼Œåœ¨<code>runWorker()</code> é‡Œé¢æ¥æ”¶åˆ°<code>null</code> åå°±ä¼š<strong>è·³å‡ºå¾ªç¯</strong>è¿›è€Œæ‰§è¡Œ<code>finally</code> å—é‡Œé¢çš„<code>processWorkerExit()</code> ã€‚è€Œè¿™ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªçº¿ç¨‹<code>æ‰§è¡Œç»“æŸ</code>äº†ï¼Œä¸ä¼šåœ¨æ‰§è¡Œä»»åŠ¡äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç­‰å¾… JVM å›æ”¶è¿™ä¸ªçº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æ˜¯å¦è¶…æ—¶ï¼Ÿå’Œ keepAliveTime ç›¸å…³</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—æ²¡ä»»åŠ¡ æˆ–è€… çº¿ç¨‹çŠ¶æ€&gt;=STOP</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="comment">// æ˜¯å¦å…è®¸çº¿ç¨‹è¶…æ—¶ å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼ˆä¸»åŠ¨è¶…æ—¶ï¼‰ï¼Ÿ æˆ–è€… wc å¤§äºäº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆè¢«åŠ¨è¶…æ—¶ï¼‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">		<span class="comment">//æ­¤æ—¶éœ€è¦å›æ”¶å¤šä½™çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c)) <span class="comment">//cas å‡å°‘çº¿ç¨‹æ•°</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">//è¿”å› null</span></span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">//cas å¤±è´¥ ç»§ç»­å¾ªç¯</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ ¹æ® timed åˆ¤æ–­æ˜¯é™æ—¶è·å–è¿˜æ˜¯ç›´æ¥è·å–</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take(); <span class="comment">//é˜»å¡çš„è·å–</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            <span class="comment">//æ²¡è·å–åˆ°ï¼Œè¶…æ—¶äº†</span></span><br><span class="line">            timedOut = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—æ²¡ä»»åŠ¡ æˆ–è€… çº¿ç¨‹çŠ¶æ€&gt;=STOP å°±é€šè¿‡ CAS è‡ªæ—‹å‡å°‘çº¿ç¨‹æ•°ï¼Œç„¶åè¿”å› null</p>
<p>ğŸ”¸ åˆ¤æ–­æ˜¯å¦å…è®¸å½“å‰çº¿ç¨‹è·å–ä»»åŠ¡è¶…æ—¶ï¼Œå¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶å°±ä»£è¡¨æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¶…æ—¶é™åˆ¶ï¼Œåˆæˆ–è€…æ˜¯å½“å‰çº¿ç¨‹æ•°è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯ç»è¿‡äº†æ‰©å®¹ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¹‹å¤–çš„çº¿ç¨‹éƒ½æ˜¯æœ‰è¶…æ—¶é™åˆ¶çš„ã€‚</p>
<p>ğŸ”¸ å¦‚æœ â‘  wc è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°  â‘¡æ²¡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½†æ˜¯è¶…æ—¶äº†å¹¶ä¸”æ­¤æ—¶ wc&gt;1ï¼ˆç•™ä¸€ä¸ªå¤„ç†ä»»åŠ¡ï¼‰â‘¢æ²¡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½†æ˜¯è¶…æ—¶äº†å¹¶ä¸”é˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶éœ€è¦å›æ”¶å¤šä½™çš„çº¿ç¨‹</p>
<p>ğŸ”¸ æ ¹æ® timed é€‰å–ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„æ–¹å¼ï¼Œè¦ä¹ˆæ˜¯é™æ—¶è·å–çš„ poll æˆ–è€…ä¸€ç›´é˜»å¡çš„ takeï¼Œè·å–åˆ°äº†ä¹‹åè¿”å›</p>
<h3 id="processWorkerExit"><a href="#processWorkerExit" class="headerlink" title="processWorkerExit()"></a>processWorkerExit()</h3><p>çœ‹åå­—å°±çŸ¥é“æ˜¯ä¸€ä¸ªæ”¶å°¾çš„æ–¹æ³•ï¼Œæ‰§è¡Œçº¿ç¨‹ç»“æŸåçš„ä¸€äº›å¿…è¦æ”¶å°¾å·¥ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkerExit</span><span class="params">(Worker w, <span class="type">boolean</span> completedAbruptly)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn&#x27;t adjusted</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯å› ä¸ºå¼‚å¸¸è€Œé€€å‡ºåˆ™ getTask() æ²¡æœ‰æœºä¼šå»è°ƒæ•´çº¿ç¨‹æ•°æ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œè°ƒæ•´</span></span><br><span class="line">        decrementWorkerCount();  <span class="comment">// wc--</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å®Œæˆä»»åŠ¡æ€»æ•°+=è¯¥ worker å®Œæˆçš„ä»»åŠ¡æ•°</span></span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">        <span class="comment">//ç§»é™¤å‡ºçº¿ç¨‹é›† workers</span></span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å°è¯•ç»“æŸçº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å– ctl</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        <span class="comment">//éå¼‚å¸¸ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">            <span class="comment">//æœ€å°å€¼æ ¹æ®æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶æ¥åˆ¤æ–­</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>; <span class="comment">//å¦‚æœæœ€å°ä¸º 0 å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºåˆ™ä¿è¯çº¿ç¨‹æ± ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™äº›ä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1. å¼‚å¸¸ç»“æŸï¼Œæ–°å¢åŠ ä¸€ä¸ªçº¿ç¨‹åˆ°çº¿ç¨‹æ± ï¼Œç›¸å½“äºæ›¿æ¢äº†å¼‚å¸¸çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//2. éå¼‚å¸¸ç»“æŸï¼Œå·¥ä½œçº¿ç¨‹å°äºæ ¸å¿ƒçº¿ç¨‹ï¼Œå¢åŠ çº¿ç¨‹ï¼Œç¡®ä¿åœ¨ä¸å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶çš„æƒ…å†µä¸‹çº¿ç¨‹æ•°ä¸å°äº corePoolSize</span></span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runStateLessThan</code>  c &lt; STOP è¿”å› true å°±è¯´æ˜æ˜¯<code>SHUTDOWN</code> æˆ–è€…<code>RUNNING</code> ï¼Œåˆ°è¿™é‡Œè¯¥å·¥ä½œçº¿ç¨‹ï¼ˆWorkerï¼‰çš„ç”Ÿå‘½å‘¨æœŸå°±ç»“æŸäº†ã€‚</p>
<h3 id="å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="http://static.imlgw.top/blog/20190803/NbjiMxDqJlu4.png?imageslim" alt="mark"></p>
<h3 id="tryTerminate"><a href="#tryTerminate" class="headerlink" title="tryTerminate()"></a>tryTerminate()</h3><p>åœ¨ä¸Šé¢çš„å¤„ç†æ”¶å°¾å·¥ä½œçš„<code>processWorkerExit()</code> çš„æ—¶å€™ä¸­é—´è°ƒç”¨äº†ä¸€ä¸ª <code>tryTerminate()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryTerminate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯åœ¨ RUNNING çŠ¶æ€ ç›´æ¥ return</span></span><br><span class="line">        <span class="comment">//å¦‚æœå·²ç»æ˜¯ TIDYING æˆ–è€… TERMINATED çŠ¶æ€ ç›´æ¥ return</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯ SHUTDOWN çŠ¶æ€å¹¶ä¸”é˜»å¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ ç›´æ¥ return</span></span><br><span class="line">        <span class="comment">//return å°±è¯´æ˜çº¿ç¨‹æ± è¿˜ä¸åˆ°å…³é—­çš„æ—¶å€™</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">            runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//åˆ°è¿™é‡Œå°±è¯´æ˜è¦ä¹ˆæ˜¯ STOP çŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯ SHUTDOWN çŠ¶æ€é˜»å¡é˜Ÿåˆ—ä¹Ÿæ²¡ä»»åŠ¡äº†</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></span><br><span class="line">            <span class="comment">//ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„ worker çº¿ç¨‹</span></span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//wc==0 æ²¡æœ‰çº¿ç¨‹å­˜æ´»äº†</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//CAS è‡ªæ—‹ ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€ä¸º TIDYING</span></span><br><span class="line">            <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    terminated(); <span class="comment">//ç©ºæ–¹æ³•ï¼Œäº¤ç»™å­ç±»å»å®ç°çš„</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//è®¾ç½®çŠ¶æ€ä¸º TERMINATED</span></span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                    <span class="comment">//å”¤é†’ termination ä¸Š awiat çš„çº¿ç¨‹</span></span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// else retry on failed CAS</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ€åçš„<code>termination.signalAll()</code> å®é™…ä¸Šæ˜¯å”¤é†’çš„<code>awaitTermination()</code> æ–¹æ³•é˜»å¡çš„çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">awaitTermination</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//é™æ—¶ç­‰å¾…</span></span><br><span class="line">            nanos = termination.awaitNanos(nanos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown()"></a>shutdown()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">//CAS è‡ªæ—‹è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">//æ‰“æ–­ idleï¼ˆç©ºé—²ï¼‰çš„ worker</span></span><br><span class="line">        interruptIdleWorkers(); </span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…³é”®çš„å°±æ˜¯è¿™ä¸ªæ‰“æ–­ç©ºé—²çº¿ç¨‹çš„æ“ä½œã€‚</p>
<h3 id="interruptIdleWorkers"><a href="#interruptIdleWorkers" class="headerlink" title="interruptIdleWorkers()"></a>interruptIdleWorkers()</h3><p>æ‰“æ–­ç©ºé—²çš„ workerï¼Œè¿™é‡Œçš„ç©ºé—²çº¿ç¨‹å…¶å®æŒ‡çš„å°±æ˜¯åœ¨é˜»å¡é˜Ÿåˆ—ä¸Šè·å–ä¸åˆ°ä»»åŠ¡è€Œé˜»å¡çš„çº¿ç¨‹</p>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ Worker ä¼šä¸æ–­çš„ä»é˜»å¡é˜Ÿåˆ—ä¸­å»æ‹¿ä»»åŠ¡ä¹Ÿå°±æ˜¯ <code>getTask()</code> æ–¹æ³•ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºå°±ä¼šé˜»å¡ä½ ç›´åˆ°æœ‰ä»»åŠ¡æäº¤åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæˆ–è€…æ‰§è¡Œçº¿ç¨‹è¢«ä¸­æ–­ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ˜¯è¦ SHUTDOWN é‚£é˜»å¡é˜Ÿåˆ—ä¸­è‚¯å®šæ˜¯ä¸ä¼šå†æœ‰ä»»åŠ¡æäº¤ï¼Œæ‰€ä»¥<code>take()</code> ä¼šé˜»å¡ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åªèƒ½é€šè¿‡æ‰“æ–­æ‰§è¡Œçº¿ç¨‹çš„æ–¹å¼æ¥æ‰“æ–­<code>take()</code> æ“ä½œï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ï¼Œçº¿ç¨‹æ± æ— æ³•å…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptIdleWorkers</span><span class="params">(<span class="type">boolean</span> onlyOne)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock(); <span class="comment">//åŠ é”ï¼Œå› ä¸º Wokers æ˜¯ HashSet æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰è¢«æ‰“æ–­å¹¶ä¸”æ²¡æœ‰åœ¨å·¥ä½œï¼ˆç©ºé—²ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//æ‰“æ–­ Worker é‡Œé¢çš„çº¿ç¨‹</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åªæ‰“æ–­ä¸€ä¸ªå°±ç›´æ¥ break</span></span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸é¦–å…ˆè·å–äº† mainLock ä¿è¯äº† workers çš„çº¿ç¨‹å®‰å…¨é¿å…äº§ç”Ÿå¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚</p>
<p>ğŸ”¸ç„¶åéå† workersï¼Œæ‰“æ–­é‚£äº›æ²¡æœ‰è¢«æ‰“æ–­å¹¶ä¸”æ²¡æœ‰å·¥ä½œçš„çº¿ç¨‹ï¼Œé‚£è¿™é‡Œæ€ä¹ˆçŸ¥é“çº¿ç¨‹æ˜¯ä¸æ˜¯åœ¨å·¥ä½œå‘¢ï¼Ÿ</p>
<p>åˆ«å¿˜äº†å‰é¢æåˆ°çš„ Worker ç±»å€ŸåŠ© AQS å®ç°äº†ä¸€ä¸ª<code>ä¸å¯é‡å…¥</code>çš„<code>lock</code> æ–¹æ³•ï¼Œè€Œåœ¨ worker æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ä¼šæ‰§è¡Œ <code>lock</code> åŠ é”ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ<code>tryLock()</code> å¦‚æœè¿”å›<code>true</code>åˆ™è¯´æ˜ å¹¶æ²¡æœ‰åœ¨å·¥ä½œå¯ä»¥æ‰“æ–­ï¼Œåä¹‹å¦‚æœæ­£åœ¨å·¥ä½œ<code>tryLock()</code> ä¸å¯é‡å…¥ï¼Œæ— æ³•è·å–åˆ°è‡ªå·±æŒæœ‰çš„é”è¿”å› falseï¼Œæ‰€ä»¥çº¿ç¨‹è‚¯å®šæ˜¯åœ¨å·¥ä½œçŠ¶æ€æ‰€ä»¥ä¸åº”è¯¥æ‰“æ–­ï¼Œè¿™äº›çº¿ç¨‹ä¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡åè‡ªè¡Œäº†æ–­ï¼Œå› ä¸ºçº¿ç¨‹æ± çŠ¶æ€å·²ç»è®¾ç½®ä¸º<code>SHUTDOWN</code> å½“ç„¶å‰ææ˜¯è¿™äº›ä»»åŠ¡æ˜¯<strong>å¯ç»ˆæ­¢çš„</strong></p>
<p>ğŸ”¸æ‰“æ–­åé‡Šæ”¾<code>tryLock()</code>è·å–åˆ°çš„é”</p>
<p>ğŸ”¸å¦‚æœåªæ‰“æ–­ä¸€ä¸ªå°±ç›´æ¥ breakï¼Œå¦åˆ™å°±ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯</p>
<p>ğŸ”¸é‡Šæ”¾ mianLock</p>
<blockquote>
<p>ççŒœï¼šè¿™é‡Œå¯ä»¥é€šè¿‡ getState åˆ¤æ–­çº¿ç¨‹çŠ¶æ€ä½†æ˜¯æœ‰å¯èƒ½åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ä¸­é˜»å¡</p>
</blockquote>
<h3 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow()"></a>shutdownNow()</h3><p>å’Œä¸Šé¢çš„ shutdown() ä¸€æ ·éƒ½æ˜¯ç”¨æ¥å…³é—­çº¿ç¨‹æ± çš„ä½†æ˜¯çœ‹æ–¹æ³•åå°±çŸ¥é“è¿™ä¸ªæ¯”è¾ƒç²—æš´ï¼ŒshutdownNow ç«‹åˆ»é©¬ä¸Šå…³é—­ï¼Œä¸€ç‚¹æƒ…é¢éƒ½ä¸ç»™ğŸ˜‚ï¼Œè™½ç„¶è¯´æ˜¯æ‰“æ–­æ‰€æœ‰çš„çº¿ç¨‹ä½†æ˜¯æ¯•ç«Ÿä½¿ç”¨çš„æ˜¯<code>Interrupt</code> ï¼Œä¹Ÿè®¸åˆ«äººæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ ¹æœ¬å°±ä¸ä¼šç†ä½ ğŸ˜‚ï¼Œæ‰€ä»¥åœ¨æäº¤ä»»åŠ¡çš„æ—¶å€™è¦å¯¹ä»»åŠ¡è¿›è¡Œæ­£ç¡®çš„ interrupt å“åº”ï¼Œæˆ–è€…ç¡®ä¿çº¿ç¨‹ä¸ä¼šä¸€ç›´é˜»å¡å¦åˆ™çº¿ç¨‹æ± å°±æ— æ³•æ­£å¸¸å…³é—­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">//CAS è‡ªæ—‹è®¾ç½®çŠ¶æ€ä¸º STOP</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">//æ‰“æ–­æ‰€æœ‰çš„çº¿ç¨‹åŒ…æ‹¬æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">//æ’å¹²é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºå·²ç» STOP äº†ä¸ä¼šå†æ‰§è¡Œé˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡äº†</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="interruptWorkers"><a href="#interruptWorkers" class="headerlink" title="interruptWorkers()"></a>interruptWorkers()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptWorkers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">            <span class="comment">//æ‰“æ–­æ‰€æœ‰å¯åŠ¨çš„çº¿ç¨‹</span></span><br><span class="line">            w.interruptIfStarted();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“æ–­äº†æ‰€æœ‰çš„å¯åŠ¨çš„çº¿ç¨‹ï¼Œå³ä½¿ä»–ä»¬å¯èƒ½ä¸ä¼šå“åº”è¿™ä¸ª Interrupted ä¿¡å·ï¼Œä½†æ˜¯ç”±äºçº¿ç¨‹æ± çŠ¶æ€å·²ç»å˜ä¸ºäº† STOPï¼Œæ‰€ä»¥ä»–ä»¬ä¹Ÿæ´»ä¸é•¿äº†ï¼ˆå½“ç„¶å‰ææ˜¯æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¯ä»¥ç»“æŸçš„ï¼‰ï¼Œåœ¨ä¸‹ä¸€æ¬¡è·å–ä»»åŠ¡çš„æ—¶å€™å°±ä¼šç›´æ¥ return ã€‚</p>
<h2 id="ç»†èŠ‚æ˜¯é­”é¬¼"><a href="#ç»†èŠ‚æ˜¯é­”é¬¼" class="headerlink" title="ç»†èŠ‚æ˜¯é­”é¬¼"></a>ç»†èŠ‚æ˜¯é­”é¬¼</h2><p>åœ¨ç¾¤é‡Œé¢çœ‹è§çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆçº¿ç¨‹æ± è¦ç”¨ çº¿ç¨‹ä¸å®‰å…¨çš„ <code>HashSet</code> ç„¶åè®¾ç½®äº†ä¸€ä¸ª <code>mainLock</code> æ§åˆ¶å¹¶å‘ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å¹¶å‘é›†åˆï¼Ÿ</p>
<p>è¿™ä¸€ç‚¹å…¶å®åœ¨æºç çš„æ³¨é‡Šä¸­å·²ç»è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œä¹‹å‰ä¸€ç›´æ²¡æœ‰æ³¨æ„åˆ°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lock held on access to workers set and related bookkeeping.</span></span><br><span class="line"><span class="comment"> * While we could use a concurrent set of some sort, it turns out</span></span><br><span class="line"><span class="comment"> * to be generally preferable to use a lock. Among the reasons is</span></span><br><span class="line"><span class="comment"> * that this serializes interruptIdleWorkers, which avoids</span></span><br><span class="line"><span class="comment"> * unnecessary interrupt storms, especially during shutdown.</span></span><br><span class="line"><span class="comment"> * Otherwise exiting threads would concurrently interrupt those</span></span><br><span class="line"><span class="comment"> * that have not yet interrupted. It also simplifies some of the</span></span><br><span class="line"><span class="comment"> * associated statistics bookkeeping of largestPoolSize etc. We</span></span><br><span class="line"><span class="comment"> * also hold mainLock on shutdown and shutdownNow, for the sake of</span></span><br><span class="line"><span class="comment"> * ensuring workers set is stable while separately checking</span></span><br><span class="line"><span class="comment"> * permission to interrupt and actually interrupting.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€å¼€å§‹è¿˜æŒºæŠ—æ‹’çš„ï¼Œæ„Ÿè§‰æœ‰çš„åœ°æ–¹æœ‰çš„çœ‹ä¸æ‡‚ï¼ˆè‹±è¯­æ¸£æ¸£ç•™ä¸‹çœ¼æ³ªï¼‰ç„¶åå» stackoverflower ä¸Šçœ‹äº†ä¸€ä¸‹æ‰¾åˆ°äº†ä¸€ä¸ªç­”æ¡ˆ  <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31942117/using-reentrantlock-in-threadpoolexecutor-to-ensure-thread-safe-workers">Using ReentrantLock in ThreadPoolExecutor to ensure thread-safe workers</a> </p>
<p>å¤§æ¦‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ä¸¤ç‚¹</p>
<ol>
<li><p>é¿å… â€œä¸­æ–­é£æš´â€ ï¼Œå¦‚æœæ˜¯ç”¨çš„æ˜¾å¼é”é‚£ä¹ˆå¦‚æœæœ‰ 10 ä¸ªçº¿ç¨‹åŒæ—¶å»æ‰§è¡Œ shutdown æ–¹æ³•ï¼Œé‚£ä¹ˆ 10 ä¸ªçº¿ç¨‹ä¼šæ’é˜Ÿå»æ‰§è¡Œ<code>interruptIdleWorkers</code> ï¼Œå¦‚æœä½¿ç”¨å¹¶å‘å®‰å…¨çš„é˜Ÿåˆ—çš„è¯ï¼Œåœ¨ 10 ä¸ªçº¿ç¨‹åŒæ—¶å»æ‰§è¡Œ shutdown æ–¹æ³•ï¼Œé‚£ä¹ˆè‚¯å®šä¼šåŒæ—¶å» <code>interruptIdleWorkers</code> ä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸­æ–­é£æš´</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Interrupt_storm">ä¸­æ–­é£æš´ï¼ˆç»´åŸºç™¾ç§‘ï¼‰</a> ä¸­æ–‡å‡ ä¹æœä¸åˆ°ç›¸å…³èµ„æ–™ï¼Œå…¶å®å°±æ˜¯å­—é¢æ„æ€ï¼Œè€Œå¤ªå¤šçš„ä¸­æ–­è¯·æ±‚ä¼šçš„å½±å“ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼Œä¸å¾—ä¸è¯´å¤§å¸ˆå°±æ˜¯å¤§å¸ˆï¼Œç»†èŠ‚ä¹‹å¤„åˆ™æ›´èƒ½ä½“ç°æ°´å¹³ï¼Œæˆ‘ç­‰ä¹Ÿåªèƒ½è†œæ‹œäº†</p>
</blockquote>
</li>
<li><p>å¦ä¸€ç‚¹å°±æ˜¯ä¸ºäº†æ–¹ä¾¿ç»Ÿè®¡çº¿ç¨‹æ± çš„ä¸€äº›ä¿¡æ¯æ¯”å¦‚ <code>largestPoolSize</code> ç­‰ï¼Œè¿™ç‚¹ä¹Ÿå¥½ç†è§£ï¼Œä½¿ç”¨å¹¶å‘çš„ Set åªèƒ½ä¿è¿™ä¸ª set çš„å¹¶å‘å®‰å…¨ï¼Œè€Œå¯¹äºå…¶ä»–çš„ä¸€äº›çº¿ç¨‹æ± çš„ç›¸å…³çš„ä¿¡æ¯ç»Ÿè®¡èµ·æ¥å°±æ¯”è¾ƒéº»çƒ¦ï¼Œå¯èƒ½åˆéœ€è¦å¦å¤–çš„åŠ é”ï¼Œæ‰€ä»¥ç´¢æ€§å°±ç›´æ¥æä¸€ä¸ªå…¨å±€çš„é”ï¼Œä¸€ä¸¾ä¸¤å¾—</p>
</li>
</ol>
<h2 id="ThreadPoolExecutor-ä½¿ç”¨"><a href="#ThreadPoolExecutor-ä½¿ç”¨" class="headerlink" title="ThreadPoolExecutor ä½¿ç”¨"></a>ThreadPoolExecutor ä½¿ç”¨</h2><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.acc = System.getSecurityManager() == <span class="literal">null</span> ?</span><br><span class="line">            <span class="literal">null</span> :</span><br><span class="line">            AccessController.getContext();</span><br><span class="line">    <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="built_in">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®ä»ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºå¯¹å„ä¸ªå‚æ•°çš„ä¸€äº›é™åˆ¶ã€‚</p>
<p><strong>corePoolSizeï¼š</strong>æ ¸å¿ƒæ± çš„å¤§å°ï¼Œè¿™ä¸ªå‚æ•°ä¸åé¢è®²è¿°çš„çº¿ç¨‹æ± çš„å®ç°åŸç†æœ‰éå¸¸å¤§çš„å…³ç³»ã€‚åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä¸­å¹¶æ²¡æœ‰ä»»ä½•çº¿ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰ä»»åŠ¡åˆ°æ¥æ‰åˆ›å»ºçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œé™¤éè°ƒç”¨äº†<code>prestartAllCoreThreads()</code>æˆ–è€…<code>prestartCoreThread()</code>æ–¹æ³•ï¼Œä»è¿™ 2 ä¸ªæ–¹æ³•çš„åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œæ˜¯é¢„åˆ›å»ºçº¿ç¨‹çš„æ„æ€ï¼Œå³åœ¨æ²¡æœ‰ä»»åŠ¡åˆ°æ¥ä¹‹å‰å°±åˆ›å»º corePoolSize ä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ã€‚<code>é»˜è®¤æƒ…å†µä¸‹</code>ï¼Œåœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º 0ï¼Œå½“æœ‰ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ° corePoolSize åï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­</p>
<p><strong>maximumPoolSizeï¼š</strong>çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®ƒè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­æœ€å¤šå…è®¸åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹</p>
<p><strong>keepAliveTime</strong>ï¼šè¡¨ç¤ºçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶æœ€å¤šä¿æŒå¤šä¹…æ—¶é—´ä¼šç»ˆæ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“<code>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº corePoolSize æ—¶</code>ï¼ŒkeepAliveTime æ‰ä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº corePoolSizeï¼šå³å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº<code>corePoolSize</code>æ—¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç©ºé—²çš„æ—¶é—´è¾¾åˆ° keepAliveTimeï¼Œåˆ™ä¼šç»ˆæ­¢ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸è¶…è¿‡ corePoolSizeï¼Œä½†æ˜¯å¦‚æœè°ƒç”¨äº†<code>allowCoreThreadTimeOut(boolean)</code>æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº corePoolSize æ—¶ï¼ŒkeepAliveTime å‚æ•°ä¹Ÿä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º 0ï¼Œè¿™äº›å†…å®¹å…¶å®åœ¨ä¸Šé¢çš„æ·±å…¥æºç ä¸­éƒ½æœ‰è¿‡åˆ†æã€‚</p>
<p><strong>unitï¼š</strong>å‚æ•° keepAliveTime çš„æ—¶é—´å•ä½</p>
<p><strong>workQueue</strong>ï¼šä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™ä¸ªå‚æ•°çš„é€‰æ‹©ä¼šå¯¹çº¿ç¨‹æ± çš„è¿è¡Œè¿‡ç¨‹äº§ç”Ÿé‡å¤§å½±å“</p>
<p><strong>threadFactory</strong>ï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼ˆæ ¹æ®ä¼ è¿›æ¥çš„ Runnable/Callable)</p>
<p><strong>handler</strong>ï¼šè¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å››ç§å–å€¼</p>
<ul>
<li><strong>ThreadPoolExecutor.AbortPolicy</strong> ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡º RejectedExecutionException å¼‚å¸¸ã€‚ </li>
<li><strong>ThreadPoolExecutor.DiscardPolicy</strong> ä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ </li>
<li><strong>ThreadPoolExecutor.DiscardOldestPolicy</strong> ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰</li>
<li><strong>ThreadPoolExecutor.CallerRunsPolicy</strong>  ç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ </li>
</ul>
<h3 id="çº¿ç¨‹æ± çš„å…³é—­"><a href="#çº¿ç¨‹æ± çš„å…³é—­" class="headerlink" title="çº¿ç¨‹æ± çš„å…³é—­"></a>çº¿ç¨‹æ± çš„å…³é—­</h3><p><code>shutdown()</code>  <code>shutdownNow()</code> ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å†è¿‡å¤šä»‹ç»äº†ã€‚</p>
<h3 id="å·¥å‚æ–¹æ³•"><a href="#å·¥å‚æ–¹æ³•" class="headerlink" title="å·¥å‚æ–¹æ³•"></a>å·¥å‚æ–¹æ³•</h3><p>ä¸Šé¢çš„æ„é€ å™¨ä¸­ä¸€å…±æœ‰ 7 ä¸ªå‚æ•°ï¼Œå¯è§è¦æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± å¹¶éé‚£ä¹ˆå®¹æ˜“ï¼Œæ‰€ä»¥ jdk åœ¨<code>Executors</code> ç±»ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥æ„é€ ä¸€äº›ç‰¹å®šçš„çº¿ç¨‹æ± ã€‚</p>
<p><strong>newCachedThreadPool()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>core</code>ä¸º 0ï¼Œæœ€å¤§å€¼ä¸º<code>Integer.MAX_VALUE</code>ï¼Œä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨çš„<code>SynchronousQueue</code> ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ˆå¥‡è‘©çš„é˜»å¡é˜Ÿåˆ—ï¼Œå®é™…ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ªåˆ é™¤æ“ä½œéƒ½è¦ç­‰å¾…æ’å…¥æ“ä½œï¼Œåä¹‹æ¯ä¸ªæ’å…¥æ“ä½œä¹Ÿéƒ½è¦ç­‰å¾…åˆ é™¤åŠ¨ä½œï¼Œåªæœ‰ä¸¤ä¸ªéƒ½å‡†å¤‡å¥½çš„æ—¶å€™æ‰ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨ä¸ä¼šä¸ºé˜Ÿåˆ—å…ƒç´ ç»´æŠ¤ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶ä¸ä¼šç¼“å­˜ä»»åŠ¡ï¼Œä¸€æ—¦æäº¤äº† (put) ä»»åŠ¡ï¼Œè¦ä¹ˆå°±ç”±ç©ºé—²çº¿ç¨‹å»æ‰§è¡Œ (take)ï¼Œè¦ä¹ˆåˆ›å»ºä¸€æ¡æ–°çº¿ç¨‹å»æ‰§è¡Œ (take)ã€‚</p>
<p><strong>newFixedThreadPool()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤§å€¼å’Œ core éƒ½æ˜¯ <code>nThread</code> ï¼Œä¹Ÿå°±æ˜¯æœ€å¤š<code>nThread</code>ä¸ªçº¿ç¨‹ï¼Œé˜»å¡é˜Ÿåˆ—é‡‡ç”¨ <code>LinkedBlockQueue</code> </p>
<p><strong>newSingleThreadExecutor()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äº<code>newFixedThreadPool(1)</code> ï¼Œä½†æ˜¯è¿™é‡Œçš„è¿”å›å€¼ç»è¿‡äº†ä¸€å±‚åŒ…è£… è¿”å›çš„ä¸å†æ˜¯<code>ThreadPoolExecutor</code> ä¹Ÿå°±æ˜¯ä¸ä¼šå†æœ‰é‚£äº›æ‰©å±•çš„ monitor æ–¹æ³•</p>
<blockquote>
<p>A wrapper class that exposes only the ExecutorService methods  of an ExecutorService implementation.</p>
</blockquote>
<p>ç±»ä¼¼çš„æ–¹æ³•å…¶å®è¿˜æœ‰ä¸€äº›ï¼Œåƒ<code>newWorkStealingPool</code> ç­‰ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»æŸ¥ä¸€æŸ¥ã€‚</p>
<p>å…¶å®è¿™é‡Œé˜¿é‡Œå·´å·´ Java å¼€å‘è§„èŒƒå¹¶ä¸å»ºè®®ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹</p>
<p><img src="http://static.imlgw.top/blog/20190806/lMVPdlPqEPNO.png?imageslim" alt="mark"></p>
<p>æ‰€ä»¥å»ºè®®è¿˜æ˜¯é€šè¿‡æ„é€ å™¨çš„æ–¹å¼å»åˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ ·ä¹Ÿæ›´åŠ çµæ´»æ›´åŠ å¯æ§ã€‚</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
