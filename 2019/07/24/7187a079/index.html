<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        JUC å¹¶å‘å·¥å…·åŒ… - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CountDownLatch"><span class="toc-text">CountDownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CyclicBarrier"><span class="toc-text">CyclicBarrier</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-1"><span class="toc-text">API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BA%E5%88%AB"><span class="toc-text">åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exchanger"><span class="toc-text">Exchanger</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-text">çº¿ç¨‹å®‰å…¨é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Semaphore"><span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%98%BE%E7%A4%BA%E9%94%81"><span class="toc-text">Semaphore å®ç°ä¸€ä¸ªæ˜¾ç¤ºé”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="toc-text">å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-2"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lock"><span class="toc-text">Lock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ReentrantLock"><span class="toc-text">ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API-3"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReadWriteLock"><span class="toc-text">ReadWriteLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E5%BC%8F%E9%94%81%E5%AF%B9%E6%AF%94%E5%86%85%E9%83%A8%E9%94%81"><span class="toc-text">æ˜¾å¼é”å¯¹æ¯”å†…éƒ¨é”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Condition"><span class="toc-text">Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E6%97%A9%E5%94%A4%E9%86%92"><span class="toc-text">è§£å†³è¿‡æ—©å”¤é†’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3-Object-wait-%E6%97%A0%E6%B3%95%E5%8C%BA%E5%88%86%E5%85%B6%E8%BF%94%E5%9B%9E%E5%8E%9F%E5%9B%A0"><span class="toc-text">è§£å†³ Object.wait() æ— æ³•åŒºåˆ†å…¶è¿”å›åŸå› </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-4"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StampedLock"><span class="toc-text">StampedLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81%E7%AD%96%E7%95%A5"><span class="toc-text">æ‚²è§‚é”ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E8%AF%BB%E7%AD%96%E7%95%A5"><span class="toc-text">ä¹è§‚è¯»ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-text">éœ€è¦æ³¨æ„çš„åœ°æ–¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ForkJoin"><span class="toc-text">ForkJoin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RecursiveTask"><span class="toc-text">RecursiveTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RecursiveAction"><span class="toc-text">RecursiveAction</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phaser"><span class="toc-text">Phaser</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-5"><span class="toc-text">API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        JUC å¹¶å‘å·¥å…·åŒ…
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2019-07-24 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#å¤šçº¿ç¨‹" title="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#å¹¶å‘ç¼–ç¨‹" title="å¹¶å‘ç¼–ç¨‹">å¹¶å‘ç¼–ç¨‹</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><p>ç»“åˆå‰é¢çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“<code>Thread.join()</code>å¯ä»¥å®ç°ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹<code>ç»“æŸ</code>å†æ‰§è¡Œï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¹¶ä¸éœ€è¦ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ç»“æŸï¼Œåªéœ€è¦ç­‰å¾…ç‰¹å®šçš„æ“ä½œç»“æŸåå°±å¯ä»¥ï¼Œå¯èƒ½æœ‰äººä¼šè¯´å¯ä»¥é€šè¿‡<code>wait/notify</code>æ¨¡å‹æ¥å®ç°ï¼Œä½†æ˜¯å…¶å®æˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ›´åŠ æ–¹ä¾¿çš„å·¥å…·ç±»ä¹Ÿå°±æ˜¯ <code>java.util.concurrent.CountDownLatch</code>ã€‚</p>
<table>
<thead>
<tr>
<th>Constructor and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>CountDownLatch(int count)</code>   æ„é€ ä¸€ä¸ªä»¥ç»™å®šè®¡æ•° <code>CountDownLatch</code> CountDownLatchã€‚</td>
</tr>
</tbody></table>
<p><strong>æ¡ˆä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountDownLatchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random=<span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executor=Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span>  []data=query();</span><br><span class="line">        <span class="comment">//æ„é€ å™¨çš„å‚æ•°ä»£è¡¨éœ€è¦æ‰§è¡Œçš„å…ˆå†³æ¡ä»¶çš„æ•°é‡</span></span><br><span class="line">        latch=<span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(data.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;data.length ; i++) &#123;</span><br><span class="line">            executor.execute(<span class="keyword">new</span> <span class="title class_">SimpleRunnable</span>(data,i,latch));</span><br><span class="line">        &#125;</span><br><span class="line">        latch.await();</span><br><span class="line">        <span class="comment">//å¼‚æ­¥å…³é—­</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">        System.out.println(<span class="string">&quot;all of works done &quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SimpleRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> []data;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> index;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SimpleRunnable</span><span class="params">(<span class="type">int</span>[] data, <span class="type">int</span> index, CountDownLatch latch)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.data = data;</span><br><span class="line">            <span class="built_in">this</span>.index = index;</span><br><span class="line">            <span class="built_in">this</span>.latch=latch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(random.nextInt(<span class="number">2000</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> value=data[index];</span><br><span class="line">            <span class="keyword">if</span> (value%<span class="number">2</span>==<span class="number">0</span>) &#123;</span><br><span class="line">                data[index]=<span class="number">2</span>*value;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                data[index]=<span class="number">10</span>*value;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; finished&quot;</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] query()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CountDownLatch</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæœªæ‰§è¡Œæ“ä½œçš„è®¡æ•°å™¨ <code>count</code>è¿™ä¸ª count éœ€è¦é€šè¿‡æ„é€ å™¨ä¼ å…¥ï¼ŒCountDownLatch å®ä¾‹çš„ countdown æ–¹æ³•æ¯æ‰§è¡Œä¸€æ¬¡<code>count</code> å°±ä¼šå‡ä¸€ ï¼Œåœ¨<code>count</code> å‡ä¸º 0 ä¹‹å‰<code>await</code> æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹ä¼šè¢«æš‚åœï¼Œ</p>
<p>ç›´åˆ°<code>count</code>å‡ä¸º 0 çš„æ—¶å€™æ‰ä¼šè¢«å”¤é†’ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/24 15:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountDownLatchTest2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch latch=<span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">                data=i;</span><br><span class="line">                latch.countDown();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;data:&quot;</span>+data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CountDownLatch ä¼ å…¥çš„ count ä¸º 4ï¼Œå¾ªç¯æ‰§è¡Œäº† 10 æ¬¡ï¼Œç»“æœæ˜¯å¤šå°‘ï¼Ÿå½“ç„¶æ˜¯ 4 äº†ï¼Œå½“å‡ä¸º 0 çš„æ—¶å€™ await è°ƒç”¨å°±ä¼šè¿”å›ä¸ä¼šå†ç­‰å¾…ï¼Œåé¢å³ä½¿ count å·²ç»å‡ä¸º 0 å†å‡ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>void</code></td>
<td><code>await()</code>   å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰åˆ°é”å­˜å™¨è®¡æ•°åˆ°é›¶ï¼Œé™¤éçº¿ç¨‹æ˜¯ interrupted ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>await(long timeout,  TimeUnit unit)</code>  ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°é”å­˜å™¨è®¡æ•°åˆ°é›¶ä¸ºæ­¢ï¼Œé™¤éçº¿ç¨‹ä¸º interrupted æˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡å»ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>countDown()</code>   å‡å°‘é”å­˜å™¨çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°è¾¾åˆ°é›¶ï¼Œé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚</td>
</tr>
<tr>
<td><code>long</code></td>
<td><code>getCount()</code>   è¿”å›å½“å‰è®¡æ•°ã€‚</td>
</tr>
<tr>
<td><code>String</code></td>
<td><code>toString()</code>   è¿”å›ä¸€ä¸ªæ ‡è¯†æ­¤é”å­˜å™¨çš„å­—ç¬¦ä¸²åŠå…¶çŠ¶æ€ã€‚</td>
</tr>
</tbody></table>
<h2 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h2><p>æœ‰æ—¶å€™å¤šä¸ªçº¿ç¨‹å¯èƒ½éœ€è¦ç›¸äº’ç­‰å¾…å¯¹æ–¹æ‰§è¡Œåˆ°æŸä¸€æ­¥ç„¶åå†æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚ç”Ÿæ´»ä¸­å°±æœ‰å¾ˆå¤šè¿™æ ·çš„æƒ…å½¢ï¼Ÿæ¯”å¦‚ç›¸çº¦çˆ¬å±±ï¼šå¤§å®¶çº¦å®šå¥½é›†åˆçš„åœ°ç‚¹ç„¶åç­‰æ‰€æœ‰äººåˆ°è¾¾æŒ‡å®šçš„é›†åˆåœ°ç‚¹åå†ä¸€èµ·å»ï¼Œå…ˆåˆ°è¾¾çš„äººéœ€è¦ç­‰å¾…ååˆ°è¾¾çš„äººï¼Œåªæœ‰æ‰€æœ‰äººåˆ°é½åæ‰ä¼šå‡ºå‘å»çˆ¬å±±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/24 15:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CyclicbarrierTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        CyclicBarrier cyclicBarrier=<span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//do something</span></span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;t1 finished&quot;</span>);</span><br><span class="line">                cyclicBarrier.await();</span><br><span class="line">                System.out.println(<span class="string">&quot;other thread is done too&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//do something</span></span><br><span class="line">                Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;t2 finished&quot;</span>);</span><br><span class="line">                cyclicBarrier.await();</span><br><span class="line">                System.out.println(<span class="string">&quot;other thread is done too&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å°±ä½“ç°äº†è¿™ç§æƒ…å†µï¼Œä¸¤ä¸ªçº¿ç¨‹å¼€å§‹å…ˆåˆ†åˆ«åšå„è‡ªçš„äº‹æƒ…ï¼Œç„¶ååˆ°è¾¾ä¸€ä¸ªç‚¹ä¹‹åï¼Œéœ€è¦ç›¸äº’ç­‰å¾…ï¼Œå…ˆåˆ°è¾¾çš„ç­‰å¾…ååˆ°è¾¾çš„ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­å¾ˆæ˜¾ç„¶ <code>t1</code> å…ˆåˆ°è¾¾å®ƒéœ€è¦ç­‰å¾…<code>t2</code> åˆ°è¾¾åæ‰èƒ½ç»§ç»­è¿è¡Œã€‚</p>
<p>åŒæ—¶ï¼Œå¦‚æœå¤–ç•Œæ˜¯æƒ³è¦çŸ¥é“è¿™ä¸ª CyclicBarrier çš„ä»»åŠ¡æ‰§è¡Œæƒ…å†µå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­åŠ å…¥ä¸€ä¸ªå›è°ƒçš„<code>Runnable</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CyclicBarrier cyclicBarrier=<span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>,()-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;t1,t2 both arrived&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„æ–¹å¼è¿˜æ˜¯å¾ˆä¼˜é›…çš„ã€‚</p>
<p>å¦‚æœç»†å¿ƒçš„è¯å…¶å®ä½ è¿˜ä¼šå‘ç°ç›¸æ¯”ä¸Šé¢çš„ CountDown å¤šäº†ä¸€ä¸ª BrokenBarrierExceptionï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ doc</p>
<p>å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ waiting è€Œ Barrier å·²ç»è¢« reset äº†</p>
<blockquote>
<p>If the barrier is {@link #reset} while any thread is waiting</p>
<p>or if the barrier {@linkplain #isBroken is broken} when</p>
<p>{@code await} is invoked, or while any thread is waiting, then</p>
<p>{@link BrokenBarrierException} is thrown.</p>
</blockquote>
<p>å¦‚æœæŸä¸€ä¸ªçº¿ç¨‹åœ¨ waiting çš„æ—¶å€™è¢«æ‰“æ–­äº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„ waiting çº¿ç¨‹å°†ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸</p>
<blockquote>
<p>If any thread is {@linkplain Thread#interrupt interrupted} while waiting</p>
<p>then all other waiting threads will throw</p>
<p>{@link BrokenBarrierException} and the barrier is placed in the broken</p>
<p>state.</p>
</blockquote>
<p><strong>æºç è§£æ</strong></p>
<p><code>CyclicBarrier</code>å¹¶æ²¡æœ‰å€ŸåŠ© AQS è€Œæ˜¯åˆ©ç”¨<code>Condition</code>æ¡ä»¶å˜é‡æ¥å®ç°çš„ï¼Œå…³äº<code>Condition</code>åé¢ä¼šä»‹ç»ã€‚</p>
<p><strong>doAwait()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">dowait</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException, BrokenBarrierException,</span><br><span class="line">           TimeoutException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock(); <span class="comment">//åŠ é”</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Generation</span> <span class="variable">g</span> <span class="operator">=</span> generation;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> --count; <span class="comment">//å’Œ countDownLatch ç±»ä¼¼</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped æ‰€æœ‰çº¿ç¨‹éƒ½æŠµè¾¾äº†</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">ranAction</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">command</span> <span class="operator">=</span> barrierCommand; </span><br><span class="line">                <span class="keyword">if</span> (command != <span class="literal">null</span>)</span><br><span class="line">                    command.run(); <span class="comment">//æ‰§è¡Œæ„é€ å™¨ä¸­ä¼ å…¥çš„ CallBack</span></span><br><span class="line">                ranAction = <span class="literal">true</span>;</span><br><span class="line">                nextGeneration(); <span class="comment">//ä¸‹ä¸€ä¸ªè½®å›</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// loop until tripped, broken, interrupted, or timed out</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; ! g.broken) &#123;</span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// We&#x27;re about to finish waiting even if we had not</span></span><br><span class="line">                    <span class="comment">// been interrupted, so this interrupt is deemed to</span></span><br><span class="line">                    <span class="comment">// &quot;belong&quot; to subsequent execution.</span></span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <strong>nextGeneration()</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">nextGeneration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// signal completion of last generation</span></span><br><span class="line">    trip.signalAll(); <span class="comment">//å”¤é†’è¿™ä¸ª barrier ä¸Šæ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹ï¼Œtrip æ˜¯ä¸€ä¸ª condition</span></span><br><span class="line">    <span class="comment">// set up next generation</span></span><br><span class="line">    count = parties; <span class="comment">//count å¤ä½</span></span><br><span class="line">    generation = <span class="keyword">new</span> <span class="title class_">Generation</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®ä¹Ÿå¯ä»¥ç”¨ CountDownLatch å®ç°å’Œ CyclicBarrier ç±»ä¼¼çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±ä¸å†æ¼”ç¤ºã€‚</p>
<h3 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h3><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>await()</code>   ç­‰å¾…æ‰€æœ‰ parties åˆ°è¾¾å±éšœï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªéšœç¢ä¸Šè°ƒç”¨<code>await</code> ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>await(long timeout,  TimeUnit unit)</code>  ç­‰å¾…æ‰€æœ‰ parties å·²ç»åœ¨æ­¤å±éšœä¸Šè°ƒç”¨  <code>await</code> ï¼Œæˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡å»ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getNumberWaiting()</code>   è¿”å›ç›®å‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹çš„æ•°é‡ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getParties()</code>   è¿”å› parties</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isBroken()</code>   æŸ¥è¯¢è¿™ä¸ªéšœç¢æ˜¯å¦å¤„äº Broken</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>reset()</code>   å°†å±éšœé‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚</td>
</tr>
</tbody></table>
<h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><ul>
<li><p><code>CountDownLatch</code>ä¸èƒ½<code>reset</code>ï¼ˆé€’å‡åˆ° 0 åä¸èƒ½å¤åŸï¼‰ï¼Œ<code>CyclicBarrier</code>æ­£å¦‚å…¶åæ˜¯å¯ä»¥å¾ªç¯ä½¿ç”¨çš„ã€‚</p>
</li>
<li><p><code>CountDownLatch</code>å·¥ä½œçº¿ç¨‹ä¹‹é—´äº’ä¸å…³å¿ƒï¼Œ<code>CyclicBarrier</code>æ‰€æœ‰çº¿ç¨‹å¿…é¡»åˆ°è¾¾ä¸€ä¸ªå…±åŒçš„ç‚¹æ‰ä¼šç»§ç»­æ‰§è¡Œ</p>
</li>
</ul>
<h2 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h2><p>JDK1.5 å¼•å…¥çš„ï¼Œçœ‹åå­—å°±çŒœå¾—åˆ°å¤§æ¦‚æ˜¯å¹²å˜›çš„ï¼Œä¸»è¦å°±æ˜¯ç”¨äº<code>ä¸¤ä¸ªçº¿ç¨‹</code> ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼Œå…¶å®ä¹Ÿå°±ç›¸å½“äºåªæœ‰ä¸¤ä¸ªå‚ä¸æ–¹çš„<code>CyclicBarrier</code> å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½è¾¾åˆ°<code>exchanger point</code> ï¼ˆé›†åˆç‚¹ï¼‰ å°±ä¼šè¿›è¡Œæ•°æ®çš„äº¤æ¢ï¼Œ<code>ä¸€æ‰‹äº¤é’±ï¼Œä¸€æ‰‹äº¤è´§</code> æ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿè¦æ³¨æ„ä¸¤ä¸ªçº¿ç¨‹èƒ½å¦æ­£ç¡®çš„åˆ°è¾¾<code>exchanger point</code> å¦‚æœæœ‰ä¸€æ–¹æ— æ³•åˆ°è¾¾åˆ™å¦ä¸€æ–¹å°±ä¼šé™·å…¥ç­‰å¾…ï¼Œå½“ç„¶ä½ å¯ä»¥åŠ ä¸Š timeoutã€‚å¦å¤–è¿™ä¸ªåªé€‚ç”¨ä¸ä¸¤ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæœ‰ 2 ä¸ªä»¥ä¸Šçš„çº¿ç¨‹å‚ä¸å°†ä¼šé€ æˆæ•°æ®ä¼ è¾“æ··ä¹±ï¼Œæ— æ³•æ§åˆ¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/25 13:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExchangerTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger=<span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; start&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> exchanger.exchange(<span class="string">&quot;i am  A&quot;</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(<span class="string">&quot;back msg=&quot;</span> +res);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;done&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; start&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> exchanger.exchange(<span class="string">&quot;i am  B&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;back msg=&quot;</span> +res);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;done&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>çº¿ç¨‹å®‰å…¨é—®é¢˜</h3><p>ç¡®å® Exchanger å¦‚æœä½¿ç”¨ä¸å½“ä¼šé€ æˆå¾ˆå¤šé—®é¢˜ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦è°¨æ…ï¼Œé¦–å…ˆå®ƒåªé€‚ç”¨ä¸ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå…¶æ¬¡è¿™é‡Œä¼ è¾“çš„å¯¹è±¡æ˜¯<code>åŒä¸€ä¸ª</code> ï¼Œä¹Ÿå°±æ˜¯è¯´å‘é€ç«¯å’Œæ¥æ”¶ç«¯çš„å¯¹è±¡å†…å­˜åœ°å€æ˜¯ä¸€æ ·çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/25 15:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExchangerTest2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;Simple&gt; exchanger=<span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="type">Simple</span> <span class="variable">simple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Simple</span>(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; start. send to B&quot;</span>+simple);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Simple</span> <span class="variable">res</span> <span class="operator">=</span> exchanger.exchange(simple);</span><br><span class="line">                <span class="comment">//ä¼‘çœ  10s</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;A receive from B obj:&quot;</span>+res +<span class="string">&quot; data:&quot;</span>+res.a);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; done&quot;</span>);</span><br><span class="line">        &#125;,<span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="type">Simple</span> <span class="variable">simple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Simple</span>(<span class="number">2</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; start. send to A:&quot;</span>+simple);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Simple</span> <span class="variable">res</span> <span class="operator">=</span> exchanger.exchange(simple);</span><br><span class="line">                <span class="comment">//ä¿®æ”¹å‘é€å‡ºå»çš„ obj</span></span><br><span class="line">                simple.setA(<span class="number">100000</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;B receive from A obj:&quot;</span>+res +<span class="string">&quot; data:&quot;</span>+res.a);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; done&quot;</span>);</span><br><span class="line">        &#125;,<span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Simple</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Simple</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.a = a;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getA</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setA</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.a = a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç»“æœ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">A start. send to Bjuc_study.tools.Exchanger.ExchangerTest2$Simple@72d6db17</span><br><span class="line">B start. send to A:juc_study.tools.Exchanger.ExchangerTest2$Simple@4295c176</span><br><span class="line">B receive from A obj:juc_study.tools.Exchanger.ExchangerTest2$Simple@72d6db17 data:<span class="number">1</span></span><br><span class="line">B done</span><br><span class="line">A receive from B obj:juc_study.tools.Exchanger.ExchangerTest2$Simple@4295c176 data:<span class="number">100000</span></span><br><span class="line">A done</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¹¶ä¸æ˜¯æ‹·è´ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶çš„å»æ“ä½œè¿™ä¸ªå¯¹è±¡è¿™å…¶å®æ˜¯å¾ˆå±é™©çš„å¾ˆæœ‰å¯èƒ½å°±ä¼šäº§ç”Ÿä¸€äº›çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„</p>
<h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p>ä¿¡å·é‡ï¼Œç›¸ä¿¡å­¦è¿‡æ“ä½œç³»ç»Ÿçš„åŒå­¦è‚¯å®šå¯¹è¿™ä¸ªå¾ˆç†Ÿæ‚‰äº†ï¼Œç†Ÿæ‚‰ PV æ“ä½œçš„è¯è¿™ä¸ªä¸€çœ‹å°±æ‡‚äº†ã€‚</p>
<table>
<thead>
<tr>
<th>Constructor and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>Semaphore(int permits)</code>   åˆ›å»ºä¸€ä¸ª <code>Semaphore</code>ä¸ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œé»˜è®¤éå…¬å¹³é”</td>
</tr>
<tr>
<td><code>Semaphore(int permits,  boolean fair)</code>  åˆ›å»ºä¸€ä¸ª <code>Semaphore</code>ä¸ç»™å®šæ•°é‡çš„è®¸å¯è¯å’Œæ˜¯å¦å…¬å¹³</td>
</tr>
</tbody></table>
<h3 id="Semaphore-å®ç°ä¸€ä¸ªæ˜¾ç¤ºé”"><a href="#Semaphore-å®ç°ä¸€ä¸ªæ˜¾ç¤ºé”" class="headerlink" title="Semaphore å®ç°ä¸€ä¸ªæ˜¾ç¤ºé”"></a>Semaphore å®ç°ä¸€ä¸ªæ˜¾ç¤ºé”</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/25 15:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> SemaphoreLock semaphoreLock=<span class="keyword">new</span> <span class="title class_">SemaphoreLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphoreLock.lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot; get the lock&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">4</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                semaphoreLock.unlock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;release the lock&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphoreLock.lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot; get the lock&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                semaphoreLock.unlock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;release the lock&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SemaphoreLock</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span>  <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>&#123;</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h3><p>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹å…¶å®ä¹ŸæŒºé‡è¦çš„ï¼Œæœ‰æ—¶å€™é¢è¯•ä¼šè®©ä½ æ‰‹å†™ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å…¶å®æœ‰å®ç°è¿‡ä¸€ä¸ªä½†æ˜¯é‚£ä¸ªå…¶å®è¿˜æ˜¯å¾ˆç®€å•çš„ä¸€ä¸ªï¼Œé‚£ä¸ªæ˜¯æ²¡æœ‰ Buffer çš„ï¼Œä¸‹é¢è¿™ä¸ªç”¨ä¿¡å·é‡å®ç°çš„å°±æ˜¯æœ‰ Buffer çš„ï¼Œåé¢ä¼šå•ç‹¬æ•´ç†å‡ºæ‰€æœ‰çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çš„å®ç°æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/25 16:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProduceConsumerV4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ProduceConsumerV4</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProduceConsumerV4</span>();</span><br><span class="line">        Stream.of(<span class="string">&quot;Produce1&quot;</span>, <span class="string">&quot;Produce2&quot;</span>, <span class="string">&quot;Produce3&quot;</span>, <span class="string">&quot;Produce4&quot;</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    pc.produce();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">        Stream.of(<span class="string">&quot;Consumer1&quot;</span>, <span class="string">&quot;Consumer2&quot;</span>, <span class="string">&quot;Consumer3&quot;</span>, <span class="string">&quot;Consumer4&quot;</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    pc.consumer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//buffer è½½ä½“</span></span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Object&gt; buffer=<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Semaphore</span> <span class="variable">full</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//buffer æœ€å¤§å€¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Semaphore</span> <span class="variable">empty</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº’æ–¥é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Semaphore mutex= <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//å·²ç»ç”Ÿäº§äº†</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            empty.acquire();</span><br><span class="line">            <span class="comment">//ä¸èƒ½å’Œä¸Šé¢çš„ä¿¡å·é‡äº¤æ¢</span></span><br><span class="line">            mutex.acquire();</span><br><span class="line">            buffer.add(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; produce a obj , current list size:&quot;</span> +buffer.size());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mutex.release();</span><br><span class="line">            full.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            full.acquire();</span><br><span class="line">            mutex.acquire();</span><br><span class="line">            <span class="comment">//ç§»é™¤æœ€åä¸€ä¸ª</span></span><br><span class="line">            buffer.removeLast();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; consumer a obj, current size: &quot;</span> + buffer.size());<span class="comment">//consumer</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mutex.release();</span><br><span class="line">            empty.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-2"><a href="#API-2" class="headerlink" title="API"></a>API</h3><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>void</code></td>
<td><code>acquire()</code>   ä»è¯¥ä¿¡å·é‡è·å–è®¸å¯è¯ï¼Œé˜»å¡ç›´åˆ°è·å–åˆ°ï¼Œå¯ä»¥è¢« interrupt</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>acquire(int permits)</code>   ä»è¯¥ä¿¡å·é‡è·å–ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œé˜»å¡ç›´åˆ°è·å–åˆ°å¯ä»¥è¢« interrupt</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>acquireUninterruptibly()</code>  ä»è¯¥ä¿¡å·é‡è·å–è®¸å¯è¯ï¼Œé˜»å¡ç›´åˆ°è·å–åˆ°ï¼Œæ— è§† interruptï¼Œä¸ä¼šè¢« interrupt</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>acquireUninterruptibly(int permits)</code>   ä»è¯¥ä¿¡å·é‡è·å–ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œé˜»æ­¢ç›´åˆ°è·å–åˆ°ï¼Œä¸å¯è¢« interruptã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>availablePermits()</code>   è¿”å›æ­¤ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>drainPermits()</code>   è·å–å¹¶è¿”å›æ‰€æœ‰å¯ç«‹å³è·å¾—çš„è®¸å¯è¯ã€‚</td>
</tr>
<tr>
<td><code>protected Collection&lt;Thread&gt;</code></td>
<td><code>getQueuedThreads()</code>   è¿”å›ä¸€ä¸ªåŒ…å«<code>å¯èƒ½</code>æ­£åœ¨ç­‰å¾…è·å–çš„çº¿ç¨‹çš„é›†åˆã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getQueueLength()</code>   è¿”å›ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°çš„ä¼°è®¡å€¼ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>hasQueuedThreads()</code>   æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…è·å–ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isFair()</code>   æ˜¯ä¸æ˜¯å…¬å¹³é”</td>
</tr>
<tr>
<td><code>protected void</code></td>
<td><code>reducePermits(int reduction)</code>   ç¼©å°å¯ç”¨è®¸å¯è¯çš„æ•°é‡ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>release()</code>   é‡Šæ”¾è®¸å¯è¯ï¼Œå°†å…¶è¿”å›åˆ°ä¿¡å·é‡ã€‚(0 çš„æ—¶å€™ä¹Ÿå¯ä»¥ release)</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>release(int permits)</code>   é‡Šæ”¾ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œå°†å…¶è¿”å›åˆ°ä¿¡å·é‡ã€‚</td>
</tr>
<tr>
<td><code>String</code></td>
<td><code>toString()</code>   è¿”å›ä¸€ä¸ªæ ‡è¯†æ­¤ä¿¡å·é‡çš„å­—ç¬¦ä¸²åŠå…¶çŠ¶æ€ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryAcquire()</code>   ä»è¿™ä¸ªä¿¡å·é‡è·å¾—è®¸å¯è¯ï¼Œç«‹å³è¿”å›ï¼Œä¸ä¼šé˜»å¡ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryAcquire(int permits)</code>   ä»è¿™ä¸ªä¿¡å·é‡è·å–ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œä¸ä¼šé˜»å¡</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryAcquire(int permits,  long timeout, TimeUnit unit)</code>  ä»è¯¥ä¿¡å·é‡è·å–ç»™å®šæ•°é‡çš„è®¸å¯è¯ï¼Œå¦‚æœåœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´è·å–åˆ°ï¼Œå°±è¿”å› trueï¼Œå¯ä»¥è¢«æ‰“æ–­</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryAcquire(long timeout,  TimeUnit unit)</code>  ä»è¯¥ä¿¡å·é‡è·å–è®¸å¯è¯ï¼Œå¦‚æœåœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´è·å–åˆ°ï¼Œå°±è¿”å› trueï¼Œå¯ä»¥è¢«æ‰“æ–­</td>
</tr>
</tbody></table>
<h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p>é€šå¸¸è¢«ç§°ä¸ºæ˜¾å¼é”ï¼Œä¸ä¹‹å¯¹åº”çš„<code>synchroized</code> åˆ™è¢«ç§°ä¸ºå†…éƒ¨é”ï¼Œæ˜¾å¼é”æ˜¯ jdk1.5 å¼•å…¥çš„é”ï¼Œä»–çš„ä½œç”¨ä¸å†…éƒ¨é”ç›¸åŒï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯”å†…éƒ¨é”æ›´åŠ å¼ºå¤§ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å†…éƒ¨é”çš„æ›¿ä»£å“ï¼Œå…¶å®åœ¨ä¹‹å‰çš„ <a href="http://imlgw.top/2019/04/07/java-duo-xian-cheng-xue-xi-bi-ji/#LOCK%E6%8E%A5%E5%8F%A3">Java å¤šçº¿ç¨‹åŸºç¡€</a>  ä¸€æ–‡ä¸­å°±æ‰‹å†™è¿‡ä¸€ä¸ªå¸¦æœ‰<code>é™æ—¶ç­‰å¾…</code>çš„é” ï¼Œé‚£ä¸ªå…¶å®å°±æ˜¯æ¨¡ä»¿çš„<code>Lock</code> æ¥å£</p>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>ReentrantLock æ˜¯ Lock æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ä¹Ÿæ˜¯ç”¨çš„æœ€å¤šçš„ä¸€ä¸ªå®ç°ç±»ï¼Œ<code>Reentrant</code> æœ¬æ„å°±æ˜¯ å¯é‡å…¥çš„ï¼Œå¯å†å…¥çš„ï¼Œ è¡¨ç¤ºå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå®ƒå·²ç»è·å–çš„é”æ—¶ï¼Œè¿™ä¸ªè·å–åŠ¨ä½œå°±è‡ªåŠ¨æˆåŠŸï¼Œ<code>synchnorized</code>ä¹Ÿæ˜¯å¯é‡å…¥çš„ã€‚</p>
<table>
<thead>
<tr>
<th>Constructor and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ReentrantLock()</code>   åˆ›å»ºä¸€ä¸ª <code>ReentrantLock</code>çš„å®ä¾‹ã€‚</td>
</tr>
<tr>
<td><code>ReentrantLock(boolean fair)</code>   æ ¹æ®ç»™å®šçš„å…¬å¹³ç­–ç•¥åˆ›å»ºä¸€ä¸ª <code>ReentrantLock</code>çš„å®ä¾‹ã€‚</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/25 20:07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLockTest1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; needLock() );</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; needLock() );</span><br><span class="line">        thread0.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        thread1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">needLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¯æ‰“æ–­çš„è·å–é”</span></span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; is get the lock&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">				<span class="comment">//ç©ºè½¬</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">//ç¡®ä¿é”çš„é‡Šæ”¾</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•ç»“æœ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread-<span class="number">0</span> is get the lock</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">898</span>)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">1222</span>)</span><br><span class="line">	at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:<span class="number">335</span>)</span><br><span class="line">	at juc_study.tools.Lock.ReentrantLockTest1.needLock(ReentrantLockTest1.java:<span class="number">26</span>)</span><br><span class="line">	at juc_study.tools.Lock.ReentrantLockTest1.lambda$main$<span class="number">1</span>(ReentrantLockTest1.java:<span class="number">16</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Exception in thread <span class="string">&quot;Thread-1&quot;</span> java.lang.IllegalMonitorStateException</span><br><span class="line">	at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:<span class="number">151</span>)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:<span class="number">1261</span>)</span><br><span class="line">	at java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:<span class="number">457</span>)</span><br><span class="line">	at juc_study.tools.Lock.ReentrantLockTest1.needLock(ReentrantLockTest1.java:<span class="number">34</span>)</span><br><span class="line">	at juc_study.tools.Lock.ReentrantLockTest1.lambda$main$<span class="number">1</span>(ReentrantLockTest1.java:<span class="number">16</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>

<h4 id="API-3"><a href="#API-3" class="headerlink" title="API"></a>API</h4><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>getHoldCount()</code>  å½“å‰çº¿ç¨‹è°ƒç”¨ lock() çš„æ¬¡æ•° ï¼ˆé‡å…¥çš„æ¬¡æ•°ï¼‰</td>
</tr>
<tr>
<td><code>protected Thread</code></td>
<td><code>getOwner()</code>   è¿”å›å½“å‰æ‹¥æœ‰æ­¤é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¿”å› <code>null</code> ã€‚</td>
</tr>
<tr>
<td><code>protected Collection&lt;Thread&gt;</code></td>
<td><code>getQueuedThreads()</code>   è¿”å›åŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…è·å–æ­¤é”çš„çº¿ç¨‹çš„é›†åˆã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getQueueLength()</code>   è¿”å›ç­‰å¾…è·å–æ­¤é”çš„çº¿ç¨‹æ•°çš„ä¼°è®¡å€¼ã€‚</td>
</tr>
<tr>
<td><code>protected Collection&lt;Thread&gt;</code></td>
<td><code>getWaitingThreads(Condition condition)</code>   è¿”å›åŒ…å«å¯èƒ½åœ¨ä¸æ­¤é”ç›¸å…³è”çš„ç»™å®šæ¡ä»¶ä¸‹ç­‰å¾…çš„çº¿ç¨‹çš„é›†åˆã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getWaitQueueLength(Condition condition)</code>   è¿”å›ä¸æ­¤é”ç›¸å…³è”çš„ç»™å®šæ¡ä»¶ç­‰å¾…çš„çº¿ç¨‹æ•°çš„ä¼°è®¡ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>hasQueuedThread(Thread thread)</code>  æŸ¥è¯¢ç»™å®šçº¿ç¨‹æ˜¯å¦ç­‰å¾…è·å–æ­¤é”ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>hasQueuedThreads()</code>   æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–æ­¤é”ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>hasWaiters(Condition condition)</code>   æŸ¥è¯¢ä»»ä½•çº¿ç¨‹æ˜¯å¦ç­‰å¾…ä¸æ­¤é”ç›¸å…³è”çš„ç»™å®šæ¡ä»¶ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isFair()</code>   å¦‚æœæ­¤é”çš„å…¬å¹³è®¾ç½®ä¸º trueï¼Œåˆ™è¿”å› <code>true</code> ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isHeldByCurrentThread()</code>   æŸ¥è¯¢æ­¤é”æ˜¯å¦ç”±å½“å‰çº¿ç¨‹æŒæœ‰ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isLocked()</code>   æŸ¥è¯¢æ­¤é”æ˜¯å¦ç”±ä»»ä½•çº¿ç¨‹æŒæœ‰ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>lock()</code>   è·å¾—é”ï¼Œä¸èƒ½è¢«æ‰“æ–­</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>lockInterruptibly()</code>   è·å¾—é”ï¼Œå¯ä»¥è¢«æ‰“æ–­</td>
</tr>
<tr>
<td><code>Condition</code></td>
<td><code>newCondition()</code>   è¿”å›<code>Condition</code>ç”¨äºè¿™ç§ç”¨é€”å®ä¾‹<code>Lock</code>å®ä¾‹ã€‚</td>
</tr>
<tr>
<td><code>String</code></td>
<td><code>toString()</code>   è¿”å›ä¸€ä¸ªæ ‡è¯†æ­¤é”çš„å­—ç¬¦ä¸²ä»¥åŠå…¶é”å®šçŠ¶æ€ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryLock()</code>   å°è¯•è·å–è¯¥é”ï¼Œä¸ä¼šé˜»å¡ï¼Œç›´æ¥è¿”å›ï¼Œ</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>tryLock(long timeout,  TimeUnit unit)</code>  å°è¯•åœ¨ç»™å®šæ—¶é—´å†…è·å–é”ï¼Œå¯ä»¥è¢«æ‰“æ–­</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>unlock()</code>   é‡Šæ”¾é”ã€‚</td>
</tr>
</tbody></table>
<h3 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h3><p>çœ‹åå­—å°±çŸ¥é“æ˜¯å¹²å•¥çš„äº†ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨ <a href="http://imlgw.top/2019/04/09/java-duo-xian-cheng-li-mian-de-she-ji-mo-shi/#%E8%AF%BB%E5%86%99%E9%94%81%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F">å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼</a> ä¸­ä¹Ÿæåˆ°äº†è¯»å†™é”ï¼Œå¹¶ä¸”å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„è¯»å†™é”ã€‚</p>
<p><strong>è¯»å†™é”æ¡ˆä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/26 12:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteLockTest1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ReentrantReadWriteLock readWriteLock=<span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Lock readLock=readWriteLock.readLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Lock writeLock=readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Long&gt; data=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; write());</span><br><span class="line">        thread0.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; read());</span><br><span class="line">        thread1.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; read());</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            writeLock.lock();</span><br><span class="line">            data.add(System.currentTimeMillis());</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            readLock.lock();</span><br><span class="line">            data.forEach(System.out::println);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot; ====&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¾å¼é”å¯¹æ¯”å†…éƒ¨é”"><a href="#æ˜¾å¼é”å¯¹æ¯”å†…éƒ¨é”" class="headerlink" title="æ˜¾å¼é”å¯¹æ¯”å†…éƒ¨é”"></a>æ˜¾å¼é”å¯¹æ¯”å†…éƒ¨é”</h3><p>æ˜¾å¼é”å’Œå†…éƒ¨é”éƒ½å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œè°ä¹Ÿä¸èƒ½æ›¿ä»£è°ï¼ˆè¿™é‡Œçš„æ˜¾å¼é”ä¸»è¦æŒ‡<code>ReentrantLock</code>ï¼‰ã€‚</p>
<p><strong>ç‰¹æ€§ä¸Š</strong></p>
<ul>
<li><p>æ˜¾å¼é”æ”¯æŒå…¬å¹³é”ï¼ˆæ˜¾å¼é”ï¼Œå†…éƒ¨é”é»˜è®¤éƒ½æ˜¯éå…¬å¹³çš„ï¼‰</p>
</li>
<li><p>æ˜¾å¼é”å¯ä»¥<code>tryLock()</code>æ— éœ€ç­‰å¾…ï¼Œå†…éƒ¨é”åªèƒ½ä¸€ç›´ç­‰å¾…é”é‡Šæ”¾</p>
</li>
<li><p>æ˜¾å¼é”æœ‰å¸¦è¶…æ—¶çš„<code>tryLock(long timeout,  TimeUnit unit)</code>ã€‚</p>
</li>
<li><p>æ˜¾å¼é”å¯ä»¥å“åº”ä¸­æ–­è¯·æ±‚ <code>lockInterruptibly()</code></p>
</li>
<li><p>æ˜¾å¼é”æä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•å¯¹é”çš„ç›¸å…³ä¿¡æ¯ç›‘æ§ï¼Œå†…éƒ¨é”åˆ™æ²¡æœ‰</p>
</li>
<li><p>â€¦â€¦â€¦</p>
</li>
</ul>
<p><strong>æ€§èƒ½ä¸Š</strong></p>
<p>å…¶å®å¾ˆå¤šäººä¼šè®¤ä¸º<code>synchronized</code>æ€§èƒ½å¾ˆå·®ï¼Œä¸å¦‚æ˜¾å¼é”</p>
<ul>
<li>jdk1.5 ä¸­ï¼Œåœ¨é«˜äº‰ç”¨çš„æƒ…å†µä¸‹ï¼Œç¡®å®æ˜¾å¼é”è¦ä¼˜äºå†…éƒ¨é”</li>
<li>jdk1.5 ä¹‹åï¼Œ å¯¹å†…éƒ¨é”è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ <strong>é”æ¶ˆé™¤</strong>ï¼Œ<strong>é”ç²—åŒ–</strong>ï¼Œ<strong>åå‘é”</strong>ï¼Œå’Œ<strong>é€‚åº”æ€§é”</strong> ï¼ˆè¿™äº›ä¼˜åŒ–åé¢çš„æ–‡ç« ä¼šå†åšè§£é‡Šï¼‰ ã€‚è¿™äº›ä¼˜åŒ–ä½¿å¾—å†…éƒ¨é”çš„æ€§èƒ½æå‡äº†å¾ˆå¤šï¼Œç”šè‡³åœ¨ä½äº‰ç”¨æƒ…å†µä¸‹æ€§èƒ½è¿˜è¦ä¼˜äº æ˜¾å¼é”ã€‚</li>
</ul>
<p><strong>ä½¿ç”¨ä¸Š</strong></p>
<ul>
<li><p>Lock ä¸æ˜¯ Java è¯­è¨€å†…ç½®çš„ï¼Œsynchronized æ˜¯ Java è¯­è¨€çš„å…³é”®å­—ï¼Œå› æ­¤æ˜¯å†…ç½®ç‰¹æ€§ã€‚Lock æ˜¯ä¸€ä¸ªç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»å¯ä»¥å®ç°åŒæ­¥è®¿é—®ã€‚</p>
</li>
<li><p>Lock å’Œ synchronized æœ‰ä¸€ç‚¹éå¸¸å¤§çš„ä¸åŒï¼Œé‡‡ç”¨ synchronized ä¸éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå½“ synchronized æ–¹æ³•æˆ–è€… synchronized ä»£ç å—æ‰§è¡Œå®Œä¹‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®©çº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å ç”¨ï¼Œè€Œ Lock åˆ™å¿…é¡»è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå¦‚æœæ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°æ­»é”ç°è±¡ã€‚</p>
</li>
</ul>
<p>å…¶å®å¾ˆæ˜æ˜¾å†…éƒ¨é”ç›¸æ¯”æ˜¾å¼é”ä½¿ç”¨èµ·æ¥è¦ç®€å•æ˜“ç”¨ï¼Œæ‰€ä»¥ä¿å®ˆä¸€ç‚¹é»˜è®¤ä¼˜å…ˆä½¿ç”¨å†…éƒ¨é”ï¼Œåœ¨éœ€è¦æ˜¾å¼é”çš„ç‰¹æ€§çš„æ—¶å€™å†é€‰ç”¨æ˜¾å¼é”ã€‚</p>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>Condition å¯¹åº”çš„å…¶å®å°±æ˜¯æ˜¾å¼é”çš„é€šä¿¡æ–¹æ³•ï¼Œ<code>Lock.newCondition()</code> è¿”å›çš„å°±æ˜¯ä¸€ä¸ª Condition å®ä¾‹ </p>
<p><code>Condition</code>æ¥å£çš„<code>await()/signal()</code>  å…¶å®å°±å¯¹åº”äº† <code>synchronize</code> çš„ <code>wait()/notify()</code> ï¼Œä½†æ˜¯ç›¸å¯¹äº <code>wait()/notify()</code>  Condition æ¥å£è§£å†³äº† <strong>è¿‡æ—©å”¤é†’</strong>  é—®é¢˜ä»¥åŠ <code>Object.wait(time)</code> æ— æ³•åŒºåˆ†æ˜¯å¦æ˜¯ç”±äºç­‰å¾…è¶…æ—¶è¿˜æ˜¯è¢«å”¤é†’çš„é—®é¢˜ã€‚</p>
<p><code>Object.wait()/notify()</code>è¦æ±‚æ‰§è¡Œçº¿ç¨‹æŒæœ‰æ‰€å±å¯¹è±¡çš„å†…éƒ¨é”ï¼ŒåŒæ ·<code>Condition.await()/notify()</code>ä¹Ÿéœ€è¦çº¿ç¨‹æŒæœ‰<strong>åˆ›å»º</strong>è¯¥ Condition çš„æ˜¾å¼é”ï¼Œ<code>æ¯ä¸ª Condition</code>å®ä¾‹å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œä¸åŒçš„ Condition ä¹‹é—´ä¸ä¼šç›¸äº’å½±å“ï¼Œè¿™æ ·ä¸€æ¥å°±è§£å†³äº†è¿‡æ—©å”¤é†’çš„é—®é¢˜ï¼Œå¯¹äºç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç»™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…åˆ›å»ºä¸€ä¸ª Conditionï¼Œç”Ÿäº§è€…é€šçŸ¥æ¶ˆè´¹è€…æ—¶å€™åªä¼šå”¤é†’æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…é€šçŸ¥ç”Ÿäº§è€…çš„æ—¶å€™ä¹Ÿåªä¼šé€šçŸ¥ç”Ÿäº§è€…ã€‚</p>
<h3 id="è§£å†³è¿‡æ—©å”¤é†’"><a href="#è§£å†³è¿‡æ—©å”¤é†’" class="headerlink" title="è§£å†³è¿‡æ—©å”¤é†’"></a>è§£å†³è¿‡æ—©å”¤é†’</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/26 15:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionTest1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">pCondition</span> <span class="operator">=</span> LOCK.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">cCondition</span> <span class="operator">=</span> LOCK.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LinkedList&lt;Long&gt; buffer = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">MAX_BUFFER</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConditionTest1</span> <span class="variable">conditionTest1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConditionTest1</span>();</span><br><span class="line">        Stream.of(<span class="string">&quot;p1&quot;</span>, <span class="string">&quot;p2&quot;</span>, <span class="string">&quot;p3&quot;</span>, <span class="string">&quot;p4&quot;</span>, <span class="string">&quot;p5&quot;</span>, <span class="string">&quot;p6&quot;</span>, <span class="string">&quot;p7&quot;</span>, <span class="string">&quot;p8&quot;</span>, <span class="string">&quot;p9&quot;</span>, <span class="string">&quot;p10&quot;</span>, <span class="string">&quot;p11&quot;</span>).forEach(name -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; conditionTest1.produce(), name).start();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Stream.of(<span class="string">&quot;c1&quot;</span>, <span class="string">&quot;c2&quot;</span>, <span class="string">&quot;c3&quot;</span>, <span class="string">&quot;c4&quot;</span>, <span class="string">&quot;c5&quot;</span>, <span class="string">&quot;c6&quot;</span>, <span class="string">&quot;c7&quot;</span>, <span class="string">&quot;c8&quot;</span>, <span class="string">&quot;c9&quot;</span>, <span class="string">&quot;c10&quot;</span>, <span class="string">&quot;c11&quot;</span>).forEach(name -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; conditionTest1.consumer(), name).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOCK.lock();</span><br><span class="line">            <span class="keyword">while</span> (buffer.size() &gt;= MAX_BUFFER) &#123;</span><br><span class="line">                pCondition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            buffer.add(l);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; produced &quot;</span> + l + <span class="string">&quot; ,current buffer size &quot;</span> + buffer.size());</span><br><span class="line">            <span class="comment">//é€šçŸ¥æ¶ˆè´¹è€…</span></span><br><span class="line">            cCondition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            LOCK.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOCK.lock();</span><br><span class="line">            <span class="keyword">while</span> (buffer.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                cCondition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">aLong</span> <span class="operator">=</span> buffer.removeLast();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; consumer &quot;</span> + aLong + <span class="string">&quot; ,current buffer size &quot;</span> + buffer.size());</span><br><span class="line">            <span class="comment">//é€šçŸ¥ç”Ÿäº§è€…</span></span><br><span class="line">            pCondition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            LOCK.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³-Object-wait-æ— æ³•åŒºåˆ†å…¶è¿”å›åŸå› "><a href="#è§£å†³-Object-wait-æ— æ³•åŒºåˆ†å…¶è¿”å›åŸå› " class="headerlink" title="è§£å†³ Object.wait() æ— æ³•åŒºåˆ†å…¶è¿”å›åŸå› "></a>è§£å†³ Object.wait() æ— æ³•åŒºåˆ†å…¶è¿”å›åŸå› </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/26 17:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionTest2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> LOCK.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isReady</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//3s+</span></span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + <span class="number">3000</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                LOCK.lock();</span><br><span class="line">                <span class="keyword">while</span> (!isReady) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> condition.awaitUntil(date);</span><br><span class="line">                    <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Fucking t0!!!!!, i am timeout&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;oh i get the lock!!!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                LOCK.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                LOCK.lock();</span><br><span class="line">                isReady = <span class="literal">true</span>;</span><br><span class="line">                condition.signal();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                LOCK.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t0&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯è§** awaitUntil()** æ˜¯æœ‰ä¸€ä¸ªè¿”å›å€¼çš„ï¼Œè¿”å› true åˆ™è¡¨ç¤ºåœ¨ç­‰å¾…æ—¶é—´å†…è·å–åˆ°äº†é”ï¼Œåä¹‹åˆ™æ˜¯å› ä¸ºè¶…æ—¶ã€‚</p>
<blockquote>
<p>å†™è¿™ä¸ª Demo çš„æ—¶å€™æ˜¯æ‹¿ä¹‹å‰çš„æ”¹çš„ï¼Œç„¶åæœ‰ä¸€ä¸ªåœ°æ–¹çš„ notify å¿˜äº†æ”¹æˆ signalï¼Œç„¶åä¸€ç›´æŠ›å¼‚å¸¸ã€‚å› ä¸º condition é‡Œé¢ä¹Ÿæœ‰ wait/notify æ–¹æ³•æ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ä¸è¦è°ƒé”™äº†ã€‚</p>
</blockquote>
<h3 id="API-4"><a href="#API-4" class="headerlink" title="API"></a>API</h3><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>void</code></td>
<td><code>await()</code>   ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°å‘å‡ºä¿¡å·æˆ–ä¸­æ–­</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>await(long time,  TimeUnit unit)</code>  ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°å‘å‡ºä¿¡å·æˆ–ä¸­æ–­ï¼Œæˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡å»ã€‚</td>
</tr>
<tr>
<td><code>long</code></td>
<td><code>awaitNanos(long nanosTimeout)</code>   ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°å‘å‡ºä¿¡å·æˆ–ä¸­æ–­ï¼Œæˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡å»ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>awaitUninterruptibly()</code>   ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°å‘å‡ºä¿¡å·ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>awaitUntil(Date deadline)</code>  ä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ç›´åˆ°å‘å‡ºä¿¡å·æˆ–ä¸­æ–­ï¼Œæˆ–è€…æŒ‡å®šçš„æœ€åæœŸé™åˆ°è¾¾ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>signal()</code>   å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>signalAll()</code>   å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚</td>
</tr>
</tbody></table>
<h2 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h2><p><code>StampedLock</code>æ˜¯<code>Java8</code>å¼•å…¥çš„ä¸€ç§æ–°çš„é”æœºåˆ¶ï¼Œæ˜¯å¯¹è¯»å†™é”<code>ReentrantReadWriteLock</code>çš„å¢å¼ºï¼Œè¯»å†™é”è™½ç„¶åˆ†ç¦»äº†è¯»å’Œå†™çš„åŠŸèƒ½ï¼Œä½¿å¾—è¯»ä¸è¯»ä¹‹é—´ä¸äº’æ–¥ï¼Œä½†æ˜¯è¯»å’Œå†™ä¹‹é—´ä¾ç„¶æ˜¯äº’æ–¥çš„ï¼Œæœ¬è´¨ä¸Šä»ç„¶æ˜¯æ‚²è§‚é”ï¼Œå¦‚æœæœ‰å¤§é‡çš„è¯»çº¿ç¨‹å°±ä¼šå¼•èµ·å†™çº¿ç¨‹çš„é¥¥é¥¿ï¼Œè€Œ<code>StampedLock</code>åˆ™æä¾›äº†ä¸€ç§ä¹è§‚çš„è¯»ç­–ç•¥ï¼Œè¿™ç§ä¹è§‚ç­–ç•¥çš„é”éå¸¸ç±»ä¼¼äºæ— é”çš„æ“ä½œï¼Œä½¿å¾—ä¹è§‚é”å®Œå…¨ä¸ä¼šå†™çº¿ç¨‹</p>
<h3 id="æ‚²è§‚é”ç­–ç•¥"><a href="#æ‚²è§‚é”ç­–ç•¥" class="headerlink" title="æ‚²è§‚é”ç­–ç•¥"></a>æ‚²è§‚é”ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/28 13:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StampedLockTest1</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">stampedLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Long&gt; shareData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">readRunnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">writeRunnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                write();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        executorService.submit(readRunnable);</span><br><span class="line"></span><br><span class="line">        executorService.submit(writeRunnable);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamped</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = stampedLock.readLock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; read &quot;</span> + shareData);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = stampedLock.writeLock();</span><br><span class="line">            shareData.add(System.currentTimeMillis());</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; Write &quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®è¿™ç§æ–¹å¼å°±å’Œ<code>ReadWriteLock</code> æ˜¯ç­‰ä»·çš„äº†ã€‚</p>
<h3 id="ä¹è§‚è¯»ç­–ç•¥"><a href="#ä¹è§‚è¯»ç­–ç•¥" class="headerlink" title="ä¹è§‚è¯»ç­–ç•¥"></a>ä¹è§‚è¯»ç­–ç•¥</h3><p>ç›¸å¯¹ä¸Šé¢çš„æ–¹å¼ï¼Œå…¶å®å°±æ˜¯æ”¹å˜äº†è¯»çš„ç­–ç•¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> stampedLock.tryOptimisticRead(); <span class="comment">//éé˜»å¡</span></span><br><span class="line">    <span class="comment">//æš‚å­˜ res</span></span><br><span class="line">    String res=Thread.currentThread().getName() + <span class="string">&quot; read &quot;</span> + shareData;</span><br><span class="line">    <span class="keyword">if</span> (!stampedLock.validate(stamp)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//éªŒè¯å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹è¿›è¡Œäº†å†™æ“ä½œï¼Œå¯èƒ½é€ æˆæ•°æ®ä¸ä¸€è‡´</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œé”å‡çº§ï¼Œè·å–å…±äº«è¯»é”</span></span><br><span class="line">            stamp = stampedLock.readLock();</span><br><span class="line">            <span class="comment">//è¦†ç›– res</span></span><br><span class="line">            res=Thread.currentThread().getName() + <span class="string">&quot; read &quot;</span> + shareData;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆå°è¯•è·å–ä¹è§‚è¯»é”ï¼ˆéé˜»å¡ï¼‰è¿”å›ä¸€ä¸ªæˆ³ï¼Œç„¶åè¿›è¡Œè¯»æ“ä½œï¼Œç¼“å­˜è¯»çš„ç»“æœï¼Œç„¶åæ ¹æ®å‰é¢è¿”å›çš„æˆ³éªŒè¯åœ¨æ­¤è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å†™çº¿ç¨‹è¢«å ç”¨è¿‡ï¼Œå¦‚æœè¢«å ç”¨è¿‡å°±è¡¨ç¤ºæ•°æ®å¯èƒ½ä¸ä¸€è‡´äº†ï¼Œå°±éœ€è¦è½¬æ¢æˆæ™®é€šçš„<code>å…±äº«è¯»é”</code> ï¼Œå†æ¬¡è¯»å–æ•°æ®åˆ·æ–°ç»“æœï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ€åé‡Šæ”¾é”ã€‚</p>
<p>è¿™é‡Œä¸€å¼€å§‹è¢«è§†é¢‘é‡Œé¢è®²çš„ææ‡µäº†ä»–å†™çš„æ˜¯è¿™æ ·çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> stampedLock.tryOptimisticRead(); <span class="comment">//éé˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (stampedLock.validate(stamp)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = stampedLock.readLock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; read &quot;</span> + shareData);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±è¯´è¿™æ ·æ¯” ReadWriteLock æ•ˆç‡é«˜å¾ˆå¤šï¼Œæˆ‘è¶Šçœ‹è¶Šè§‰å¾—ä¸å¯¹åŠ²ï¼Œç„¶åè‡ªå·±æŸ¥äº†ä¸‹ï¼Œçœ‹äº†ä¸‹å®˜æ–¹çš„ Demo å‘ç°ä»–å†™çš„ç¡®å®æ˜¯é”™çš„ã€‚</p>
<p>API ä»€ä¹ˆçš„å°±ä¸å¤šè¯´äº†ï¼Œè¿™é‡Œå¦‚æœæƒ³äº†è§£æ›´å¤šå¯ä»¥çœ‹çœ‹ <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015808032#articleHeader20">è¿™ç¯‡æ–‡ç« </a></p>
<p>å¦å¤–å¦‚æœæƒ³çœ‹çœ‹æ€§èƒ½å¯¹æ¯”çš„å¯ä»¥çœ‹çœ‹ <a target="_blank" rel="noopener" href="http://ifeve.com/java-8-stampedlocks-vs-readwritelocks-and-synchronized/">è¿™ç¯‡æ–‡ç« </a></p>
<blockquote>
<p>è¿™é‡Œè¿˜è¦å­˜ä¸ªç–‘ï¼Œæœ€åçš„é‡Šæ”¾è¯»é”ä¹‹ååˆ°æœ€åä¸€æ­¥çš„æ—¶å€™ä¸æ˜¯ä¹Ÿæœ‰å¯èƒ½æœ‰å†™çº¿ç¨‹è¿›å…¥ä¹ˆï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µä¹ˆï¼Ÿ å› ä¸ºæºç ä¸Šæ³¨é‡Šçš„ Demo ä¹Ÿæ˜¯è¿™æ ·å†™çš„æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æœ‰ç‚¹ç–‘é—®çš„ã€‚</p>
</blockquote>
<h3 id="éœ€è¦æ³¨æ„çš„åœ°æ–¹"><a href="#éœ€è¦æ³¨æ„çš„åœ°æ–¹" class="headerlink" title="éœ€è¦æ³¨æ„çš„åœ°æ–¹"></a>éœ€è¦æ³¨æ„çš„åœ°æ–¹</h3><ul>
<li><p>æ‰€æœ‰è·å–é”çš„æ–¹æ³•ï¼Œéƒ½è¿”å›ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼ŒStamp ä¸º 0 è¡¨ç¤ºè·å–å¤±è´¥ï¼Œå…¶ä½™éƒ½è¡¨ç¤ºæˆåŠŸï¼›</p>
</li>
<li><p>æ‰€æœ‰é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œéƒ½éœ€è¦ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼Œè¿™ä¸ª Stamp å¿…é¡»æ˜¯å’ŒæˆåŠŸè·å–é”æ—¶å¾—åˆ°çš„ Stamp ä¸€è‡´ï¼›</p>
</li>
<li><p> StampedLock æ˜¯ä¸å¯é‡å…¥çš„ ï¼ˆå¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†å†™é”ï¼Œå†å»è·å–å†™é”çš„è¯å°±ä¼šé€ æˆæ­»é”ï¼‰ï¼Œæ‰€ä»¥è¿™å°±è¦æˆ‘ä»¬å¼€å‘äººå‘˜ä¸è¦å»ä¿®æ”¹è¿”å›çš„æˆ³æˆ–è€…è®©å®ƒé€ƒé€¸å‡ºå»</p>
</li>
<li><p> StampedLock ä¸æ”¯æŒ Condition</p>
</li>
</ul>
<h2 id="ForkJoin"><a href="#ForkJoin" class="headerlink" title="ForkJoin"></a>ForkJoin</h2><p>ForkJoin æ˜¯ Java7 æä¾›çš„åŸç”Ÿå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†æ¡†æ¶ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯å°†å¤§ä»»åŠ¡åˆ†å‰²æˆå°ä»»åŠ¡ï¼Œæœ€åå°†å°ä»»åŠ¡èšåˆèµ·æ¥å¾—åˆ°ç»“æœã€‚fork æ˜¯åˆ†è§£çš„æ„æ€ï¼Œjoin æ˜¯æ”¶é›†çš„æ„æ€ã€‚å®ƒéå¸¸ç±»ä¼¼äº HADOOP æä¾›çš„ MapReduce æ¡†æ¶ï¼Œåªæ˜¯ MapReduce çš„ä»»åŠ¡å¯ä»¥é’ˆå¯¹é›†ç¾¤å†…çš„æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨é›†ç¾¤çš„èƒ½åŠ›å®Œæˆè®¡ç®—ä»»åŠ¡ã€‚ForkJoin æ›´åŠ ç±»ä¼¼äºå•æœºç‰ˆçš„ MapReduceã€‚</p>
<h3 id="RecursiveTask"><a href="#RecursiveTask" class="headerlink" title="RecursiveTask"></a>RecursiveTask</h3><p><strong>è®¡ç®— sum å’Œ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/30 11:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecursiveTest1</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//è¿™ä¸ªå€¼ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†çš„æœ€å¤§æ•°æ®ï¼Œä¸èƒ½å¤ªå°ä¹Ÿä¸èƒ½å¤ªå¤§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> MAX_THRESHOLD=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool forkJoinPool=<span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        ForkJoinTask&lt;Integer&gt; submit = forkJoinPool.submit(<span class="keyword">new</span> <span class="title class_">CaculateRecursiveTask</span>(<span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> submit.get();</span><br><span class="line">            System.out.println(integer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CaculateRecursiveTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CaculateRecursiveTask</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.start = start;</span><br><span class="line">            <span class="built_in">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(end-start&lt;=MAX_THRESHOLD)&#123;</span><br><span class="line">                <span class="keyword">return</span> IntStream.rangeClosed(start,end).sum();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="type">int</span> mid=(start+end)/<span class="number">2</span>;</span><br><span class="line">                CaculateRecursiveTask leftTask=<span class="keyword">new</span> <span class="title class_">CaculateRecursiveTask</span>(start,mid);</span><br><span class="line">                CaculateRecursiveTask rightTask=<span class="keyword">new</span> <span class="title class_">CaculateRecursiveTask</span>(mid+<span class="number">1</span>,end);</span><br><span class="line">                <span class="comment">//é˜»å¡</span></span><br><span class="line">                leftTask.fork();</span><br><span class="line">                rightTask.fork();</span><br><span class="line">                <span class="comment">//è¿”å›ç»“æœ</span></span><br><span class="line">                <span class="keyword">return</span> leftTask.join()+rightTask.join();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RecursiveAction"><a href="#RecursiveAction" class="headerlink" title="RecursiveAction"></a>RecursiveAction</h3><p><strong>è®¡ç®— sum å’Œ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/30 13:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecursiveActionTest1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> MAX_THRESHOLD=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger SUM=<span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool forkJoinPool=<span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        forkJoinPool.submit(<span class="keyword">new</span> <span class="title class_">CalculateRecursiveAction</span>(<span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(SUM.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CalculateRecursiveAction</span> <span class="keyword">extends</span> <span class="title class_">RecursiveAction</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CalculateRecursiveAction</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.start = start;</span><br><span class="line">            <span class="built_in">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(end-start&lt;=MAX_THRESHOLD)&#123;</span><br><span class="line">                SUM.addAndGet(IntStream.rangeClosed(start,end).sum());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="type">int</span> mid=(start+end)/<span class="number">2</span>;</span><br><span class="line">                CalculateRecursiveAction leftTask=<span class="keyword">new</span> <span class="title class_">CalculateRecursiveAction</span>(start,mid);</span><br><span class="line">                CalculateRecursiveAction rightTask=<span class="keyword">new</span> <span class="title class_">CalculateRecursiveAction</span>(mid+<span class="number">1</span>,end);</span><br><span class="line">                <span class="comment">//é˜»å¡</span></span><br><span class="line">                leftTask.fork();</span><br><span class="line">                rightTask.fork();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Phaser"><a href="#Phaser" class="headerlink" title="Phaser"></a>Phaser</h2><p>CountDownLatch å’Œ CyclicBarrier éƒ½æ˜¯ JDK 1.5 å¼•å…¥çš„ï¼Œè€Œ Phaser æ˜¯ JDK 1.7 å¼•å…¥çš„ã€‚Phaser çš„åŠŸèƒ½ä¸ CountDownLatch å’Œ CyclicBarrier æœ‰éƒ¨åˆ†é‡å ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†æ›´ä¸°å¯Œçš„è¯­ä¹‰å’Œæ›´çµæ´»çš„ç”¨æ³•ã€‚</p>
<p>Phaser é¡¾åæ€ä¹‰ï¼Œä¸é˜¶æ®µç›¸å…³ã€‚Phaser æ¯”è¾ƒé€‚åˆè¿™æ ·ä¸€ç§åœºæ™¯ï¼Œä¸€ç§ä»»åŠ¡å¯ä»¥åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œç°å¸Œæœ›å¤šä¸ªçº¿ç¨‹å»å¤„ç†è¯¥æ‰¹ä»»åŠ¡ï¼Œå¯¹äºæ¯ä¸ªé˜¶æ®µï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘è¿›è¡Œï¼Œä½†æ˜¯å¸Œæœ›ä¿è¯åªæœ‰å‰é¢ä¸€ä¸ªé˜¶æ®µçš„ä»»åŠ¡å®Œæˆä¹‹åæ‰èƒ½å¼€å§‹åé¢çš„ä»»åŠ¡ã€‚è¿™ç§åœºæ™¯å¯ä»¥ä½¿ç”¨å¤šä¸ª CyclicBarrier æ¥å®ç°ï¼Œæ¯ä¸ª CyclicBarrier è´Ÿè´£ç­‰å¾…ä¸€ä¸ªé˜¶æ®µçš„ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚ä½†æ˜¯ä½¿ç”¨ CyclicBarrier çš„ç¼ºç‚¹åœ¨äºï¼Œéœ€è¦æ˜ç¡®çŸ¥é“æ€»å…±æœ‰å¤šå°‘ä¸ªé˜¶æ®µï¼ŒåŒæ—¶å¹¶è¡Œçš„ä»»åŠ¡æ•°éœ€è¦æå‰é¢„å®šä¹‰å¥½ï¼Œä¸”æ— æ³•åŠ¨æ€ä¿®æ”¹ã€‚è€Œ Phaser å¯åŒæ—¶è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> imlgw.top</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/30 13:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>();</span><br><span class="line"></span><br><span class="line">        Stream.of(<span class="string">&quot;t1&quot;</span>, <span class="string">&quot;t2&quot;</span>, <span class="string">&quot;t3&quot;</span>, <span class="string">&quot;t4&quot;</span>, <span class="string">&quot;t5&quot;</span>).forEach(name -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Task</span>(phaser), name).start());</span><br><span class="line">        <span class="comment">//æ³¨å†Œ main çº¿ç¨‹</span></span><br><span class="line">        phaser.register();</span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">        System.out.println(<span class="string">&quot;all of work finished&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        Task(Phaser phaser) &#123;</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="comment">//åŠ¨æ€å¢åŠ </span></span><br><span class="line">            <span class="built_in">this</span>.phaser.register();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; is working&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-5"><a href="#API-5" class="headerlink" title="API"></a>API</h3><table>
<thead>
<tr>
<th>Modifier and Type</th>
<th>Method and Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>arrive()</code>   æŠµè¾¾è¿™ä¸ªç§»ç›¸å™¨ï¼Œè€Œä¸ç”¨ç­‰å¾…åˆ«äººåˆ°è¾¾ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>arriveAndAwaitAdvance()</code>   åˆ°è¾¾è¿™ä¸ªç§»ç›¸å™¨ï¼Œç­‰å¾…å…¶ä»–äººã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>arriveAndDeregister()</code>   åˆ°è¾¾è¿™ä¸ªç§»ç›¸å™¨å¹¶ä»å…¶ä¸­æ³¨é”€ï¼Œè€Œæ— éœ€ç­‰å¾…åˆ«äººåˆ°è¾¾ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>awaitAdvance(int phase)</code>   ç­‰å¾…è¯¥ç›¸ä½å™¨çš„ç›¸ä½ä»ç»™å®šç›¸ä½å€¼å‰è¿›ï¼Œå¦‚æœå½“å‰ç›¸ä½ä¸ç­‰äºç»™å®šç›¸ä½å€¼ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œæˆ–è€…è¯¥ç›¸ä½å™¨è¢«ç»ˆæ­¢ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>awaitAdvanceInterruptibly(int phase)</code>   ç­‰å¾…è¯¥ç§»ç›¸å™¨çš„é˜¶æ®µä»ç»™å®šçš„ç›¸ä½å€¼æ¨è¿›ï¼Œå¦‚æœåœ¨ç­‰å¾…æ—¶ <code>InterruptedException</code>åˆ™æŠ›å‡º  <code>InterruptedException</code> ï¼Œæˆ–è€…å¦‚æœå½“å‰ç›¸ä½ä¸ç­‰äºç»™å®šçš„ç›¸ä½å€¼æˆ–è€…è¯¥ç›¸ä½å™¨è¢«ç»ˆæ­¢ï¼Œåˆ™ç«‹å³è¿”å›ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>awaitAdvanceInterruptibly(int phase,  long timeout, TimeUnit unit)</code>  ç­‰å¾…è¯¥ç§»ç›¸å™¨çš„é˜¶æ®µä»ç»™å®šçš„ç›¸ä½å€¼æˆ–ç»™å®šçš„è¶…æ—¶æ—¶é—´  <code>InterruptedException</code>åˆ°ç­‰å¾…æ—¶æŠ›å‡º <code>InterruptedException</code>  ï¼Œå¦‚æœå½“å‰ç›¸ä½ä¸ç­‰äºç»™å®šçš„ç›¸ä½å€¼ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œæˆ–è€…è¯¥ç›¸ä½å™¨è¢«ç»ˆæ­¢ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>bulkRegister(int parties)</code>   å¢åŠ ç»™å®šæ•°é‡çš„æ–°çš„æœ‰äº‰è®®çš„æ´¾å¯¹åˆ°è¿™ä¸ªç§»ç›¸å™¨ã€‚</td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>forceTermination()</code>   å¼ºåˆ¶æ­¤ç§»ç›¸å™¨è¿›å…¥ç»ˆæ­¢çŠ¶æ€ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getArrivedParties()</code>   è¿”å›åœ¨æ­¤ç§»ç›¸å™¨çš„å½“å‰é˜¶æ®µåˆ°è¾¾çš„å·²æ³¨å†Œæ–¹çš„æ•°é‡ã€‚</td>
</tr>
<tr>
<td><code>Phaser</code></td>
<td><code>getParent()</code>   è¿”å›æ­¤ç§»ç›¸å™¨çš„çˆ¶çº§ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å› <code>null</code> ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getPhase()</code>   è¿”å›å½“å‰ç›¸ä½æ•°ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getRegisteredParties()</code>   è¿”å›åœ¨æ­¤ç§»åŠ¨è®¾å¤‡ä¸Šæ³¨å†Œçš„å„æ–¹æ•°é‡ã€‚</td>
</tr>
<tr>
<td><code>Phaser</code></td>
<td><code>getRoot()</code>   è¿”å›æ­¤ç§»ç›¸å™¨çš„æ ¹ç¥–å…ˆï¼Œå¦‚æœå®ƒæ²¡æœ‰çˆ¶ä»£ï¼Œåˆ™ä¸è¯¥ç§»ç›¸å™¨ç›¸åŒã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>getUnarrivedParties()</code>   è¿”å›å°šæœªåˆ°è¾¾æ­¤ç§»ç›¸å™¨å½“å‰é˜¶æ®µçš„å·²æ³¨å†Œæ–¹çš„æ•°é‡ã€‚</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>isTerminated()</code>   è¿”å› <code>true</code>å¦‚æœç§»ç›¸å™¨å·²è¢«ç»ˆæ­¢ã€‚</td>
</tr>
<tr>
<td><code>protected boolean</code></td>
<td><code>onAdvance(int phase,  int registeredParties)</code>  åœ¨å³å°†è¿›è¡Œçš„ç›¸ä½æå‰æ‰§è¡ŒåŠ¨ä½œçš„å¯è¦†ç›–æ–¹æ³•ï¼Œå¹¶æ§åˆ¶ç»ˆæ­¢ã€‚</td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>register()</code>   æ·»åŠ ä¸€ä¸ªæ–°çš„ unririved party åˆ°è¿™ä¸ªç§»ç›¸å™¨ã€‚</td>
</tr>
<tr>
<td><code>String</code></td>
<td><code>toString()</code>   è¿”å›ä¸€ä¸ªæ ‡è¯†æ­¤ç§»ç›¸å™¨çš„å­—ç¬¦ä¸²åŠå…¶çŠ¶æ€ã€‚</td>
</tr>
</tbody></table>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¤§è‡´å½’çº³äº†ä¸€äº›å¸¸è§çš„å¹¶å‘å·¥å…·ï¼Œå½“ç„¶åªæ˜¯æµ…æ˜¾çš„è®°å½•äº†ä¸€ä¸‹æ€æ ·ä½¿ç”¨ï¼ŒåŸç†éƒ¨åˆ†è¿˜æ²¡æœ‰æ·±å…¥çš„äº†è§£ï¼Œåç»­è‚¯å®šä¼šå»ç ”ç©¶åº•å±‚å®ç°æºç åŒ…æ‹¬<code>AQS</code>å’Œ<code>LockSupport</code>ç­‰ç­‰ï¼Œå…¶å®è¶Šå¾€åå­¦å°±è¶Šæƒ³çŸ¥é“åˆ°åº•å±‚æ˜¯æ€æ ·ä¸ªè¿‡ç¨‹ï¼Œåˆ°åº•æ˜¯å¦‚ä½•åŠ é”å¦‚ä½•è§£é”ï¼ŸCAS åˆèµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ï¼ŸSynchnorized åº•å±‚åˆæ˜¯å¦‚ä½•å®ç°ï¼Ÿâ€¦ å­¦æ— æ­¢å¢ƒå•Šã€‚JUC é™¤äº†è¿™äº›å¹¶å‘å·¥å…·å¤–è¿˜æœ‰<strong>çº¿ç¨‹æ± </strong> ï¼Œ<strong>é˜»å¡é˜Ÿåˆ—</strong> è¿˜æ²¡ä»‹ç»ï¼Œåé¢ä¼šç»§ç»­ä»‹ç»ã€‚</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
