<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Tadow çš„åšå®¢">
    <meta property="og:type" content="website">
    <meta name="description" content="Tadow çš„åšå®¢">
    <meta name="keyword"  content="Tadow, Resolmi, imlgw, åŠå²›é“ç›’, ç®—æ³•, Java, Golang">
    <link rel="shortcut icon" href="https://fav.farm/ğŸ’­">

    <title>
        
        Raft ç®—æ³• - Tadow ç¢ç¢å¿µ
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Tadow ç¢ç¢å¿µ" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Keep It Simple, Stupid </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="https://static.imlgw.top/blog/20220821160037.png" />
        </div>
        <div class="name">
            <i>Tadow</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <!-- <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li> -->
            <li >
                <a href="/categories">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            
            <li >
                <a href="/selfhosted">
                    <i class="iconfont icon-guidang1"></i>
                    <span>è‡ªå»º</span>
                </a>
            </li>

            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>æ”¶è—</span>
                </a>
            </li>

            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%EF%BC%88Replication%EF%BC%89"><span class="toc-text">å¤åˆ¶ï¼ˆReplicationï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%91%E8%A3%82%EF%BC%88Split-Brain%EF%BC%89"><span class="toc-text">è„‘è£‚ï¼ˆSplit Brainï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E5%8D%8A%E7%A5%A8%E5%86%B3%EF%BC%88Majority-Vote%EF%BC%89"><span class="toc-text">è¿‡åŠç¥¨å†³ï¼ˆMajority Voteï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E5%9F%BA%E7%A1%80"><span class="toc-text">Raft åŸºç¡€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E8%A7%84%E8%8C%83"><span class="toc-text">Raft è§„èŒƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E9%80%89%E4%B8%BB"><span class="toc-text">Raft é€‰ä¸»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6"><span class="toc-text">Raft æ—¥å¿—å¤åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%EF%BC%88Fast-Backup%EF%BC%89"><span class="toc-text">å¿«é€Ÿæ¢å¤ï¼ˆFast Backupï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E5%93%8D%E5%BA%94"><span class="toc-text">Raft å“åº”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">Raft æŒä¹…åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E6%97%A5%E5%BF%97%E5%BF%AB%E7%85%A7"><span class="toc-text">Raft æ—¥å¿—å¿«ç…§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-%E6%88%90%E5%91%98%E5%8F%98%E6%9B%B4"><span class="toc-text">Raft æˆå‘˜å˜æ›´</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Keep It Simple, Stupid </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Raft ç®—æ³•
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2022-06-05 00:00:00</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#Raft" title="Raft">Raft</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#å…±è¯†ç®—æ³•" title="å…±è¯†ç®—æ³•">å…±è¯†ç®—æ³•</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h2 id="å¤åˆ¶ï¼ˆReplicationï¼‰"><a href="#å¤åˆ¶ï¼ˆReplicationï¼‰" class="headerlink" title="å¤åˆ¶ï¼ˆReplicationï¼‰"></a>å¤åˆ¶ï¼ˆReplicationï¼‰</h2><p>ä¸€è‡´æ€§ç®—æ³•çš„ç›®çš„æ˜¯è®©å¤šå°æœåŠ¡å™¨/çŠ¶æ€æœºèƒ½å¤Ÿè®¡ç®—å¾—åˆ°ç›¸åŒçš„çŠ¶æ€ï¼ŒåŒæ—¶ï¼Œå¦‚æœæœ‰éƒ¨åˆ†æœºå™¨å®•æœºï¼Œé›†ç¾¤ä½œä¸ºä¸€ä¸ªæ•´ä½“ä¾ç„¶èƒ½ç»§ç»­å·¥ä½œã€‚</p>
<p><strong>çŠ¶æ€è½¬ç§»</strong>ï¼ˆState Transferï¼‰ï¼šPrimary å°†è‡ªå·±å®Œæ•´çŠ¶æ€ï¼Œæ¯”å¦‚è¯´å†…å­˜ä¸­çš„å†…å®¹ï¼Œæ‹·è´å¹¶å‘é€ç»™ Backupã€‚Backup ä¼šä¿å­˜æ”¶åˆ°çš„æœ€è¿‘ä¸€æ¬¡çŠ¶æ€ï¼Œæ‰€ä»¥ Backup ä¼šæœ‰æ‰€æœ‰çš„æ•°æ®ã€‚å½“ Primary æ•…éšœäº†ï¼ŒBackup å°±å¯ä»¥ä»å®ƒæ‰€ä¿å­˜çš„æœ€æ–°çŠ¶æ€å¼€å§‹è¿è¡Œã€‚æ‰€ä»¥ï¼ŒçŠ¶æ€è½¬ç§»å°±æ˜¯å‘é€ Primary çš„çŠ¶æ€ã€‚è¿™ç§æœºåˆ¶ä¸‹ï¼Œæ¯è¿‡ä¸€ä¼šï¼ŒPrimary å°±éœ€è¦å¯¹è‡ªèº«çš„å†…å­˜åšæ‹·è´ï¼ˆè¿™é‡Œå¯ä»¥åªå‘ diffï¼‰ï¼Œå¹¶é€šè¿‡ç½‘ç»œå°†å…¶å‘é€åˆ° Backupã€‚</p>
<p><strong>å¤åˆ¶çŠ¶æ€æœº</strong>ï¼ˆReplicated State Machineï¼‰ï¼šå¤åˆ¶çŠ¶æ€æœºå°†æ¥è‡ªå®¢æˆ·ç«¯çš„æ“ä½œæ—¥å¿—ä» Primary é¡ºåºä¼ è¾“åˆ° Backupï¼Œè¿™æ ·å¤šå°è®¡ç®—æœºä»ç›¸åŒçš„çŠ¶æ€å¼€å§‹ï¼Œä»¥ç›¸åŒçš„é¡ºåºï¼Œæ‰§è¡Œäº†<strong>ç¡®å®š</strong>çš„ç›¸åŒæŒ‡ä»¤ï¼Œè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™é‡Œä¹Ÿæœ‰ä¸€äº›ä¾‹å¤–ï¼Œæœ‰ä¸€äº›æŒ‡ä»¤å¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œæ¯”å¦‚éšæœºæ•°ç”Ÿæˆå™¨ï¼Œå½“å‰æ—¶é—´ï¼ŒUUID ç­‰ï¼Œè¿™äº›æŒ‡ä»¤ä¼šå°†æŒ‡ä»¤ç»“æœä¸€èµ·åŒæ­¥è¿‡å»ã€‚</p>
<h2 id="è„‘è£‚ï¼ˆSplit-Brainï¼‰"><a href="#è„‘è£‚ï¼ˆSplit-Brainï¼‰" class="headerlink" title="è„‘è£‚ï¼ˆSplit Brainï¼‰"></a>è„‘è£‚ï¼ˆSplit Brainï¼‰</h2><p>åœ¨ä¸€äº›ä¸­é—´ä»¶é›†ç¾¤ç¯å¢ƒä¸­ï¼Œæ™®ééƒ½ä¼šæœ‰ä¸€ä¸ªã€Œå¤§è„‘ã€å»åšå†³ç­–ã€‚è¿™ä¸ªå¤§è„‘ä¸€èˆ¬é€šè¿‡é€‰ä¸¾äº§ç”Ÿï¼Œä½†æ˜¯å½“å‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™å°±æœ‰å¯èƒ½å‡ºç°å¤šä¸ªå¤§è„‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ã€Œè„‘è£‚ã€</p>
<h3 id="è¿‡åŠç¥¨å†³ï¼ˆMajority-Voteï¼‰"><a href="#è¿‡åŠç¥¨å†³ï¼ˆMajority-Voteï¼‰" class="headerlink" title="è¿‡åŠç¥¨å†³ï¼ˆMajority Voteï¼‰"></a>è¿‡åŠç¥¨å†³ï¼ˆMajority Voteï¼‰</h3><p>è¿‡åŠç¥¨å†³é¦–å…ˆå¾—ä¿è¯é›†ç¾¤æ•°é‡ä¸ºå¥‡æ•°ï¼Œè¿™æ ·å½“å‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä¿è¯æœ€å¤šåªæœ‰ä¸€ä¸ªåˆ†åŒºçš„æ•°é‡ä¼šè¿‡åŠã€‚</p>
<p>å…¶æ¬¡å°±æ˜¯ä»»ä½•æ—¶å€™æ‰§è¡Œä»»ä½•æ“ä½œï¼Œéƒ½éœ€è¦è¶…è¿‡åŠæ•°æœåŠ¡å™¨æ‰¹å‡†åæ‰èƒ½æ‰§è¡Œï¼ˆæ³¨æ„è¿™é‡ŒæœåŠ¡å™¨æ•°é‡æŒ‡çš„æ˜¯æ‰€æœ‰æœåŠ¡å™¨æ•°é‡ï¼Œæ•…éšœæœºå™¨ä¹ŸåŒ…æ‹¬åœ¨å†…ï¼‰ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œ2*F+1 çš„èŠ‚ç‚¹æ€»æ•°ï¼Œå¯æ¥å—çš„æœ€å¤šæ•…éšœèŠ‚ç‚¹æ•°å°±æ˜¯ Fã€‚</p>
<blockquote>
<p>è¿‡åŠç¥¨å†³è¿˜æœ‰ä¸€ä¸ªå¾ˆå¾®å¦™çš„ç‰¹æ€§ï¼Œå½“ Leader æ˜“ä¸»çš„æ—¶å€™ï¼Œæ–° Leader ä¸€å®šæ˜¯æ‹¿åˆ°äº†è¿‡åŠçš„æœåŠ¡å™¨é€‰ç¥¨ï¼Œé‚£ä¹ˆå’Œä¸Šä¸€ä»»çš„ Leader é€‰ä¸¾äº§ç”Ÿçš„è¿‡åŠæœåŠ¡å™¨ä¹‹é—´å¿…ç„¶ä¼šæœ‰é‡å ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ–° Leader çš„è¿‡åŠæœåŠ¡å™¨ä¸­ä¸€å®šæœ‰åŒ…å«äº†æ—§ Leader çš„æ‰€æœ‰æ“ä½œçš„èŠ‚ç‚¹</p>
</blockquote>
<h2 id="Raft-åŸºç¡€"><a href="#Raft-åŸºç¡€" class="headerlink" title="Raft åŸºç¡€"></a>Raft åŸºç¡€</h2><p>Raft èŠ‚ç‚¹çŠ¶æ€è½¬æ¢ï¼š<br><img src="https://static.imlgw.top/blog/20220601202043.png" alt="Raft è®ºæ–‡"></p>
<p><strong>Follower</strong>ï¼šä»èŠ‚ç‚¹ï¼Œåˆå§‹éƒ½æ˜¯ Followerã€‚æ¯”è¾ƒè¢«åŠ¨ï¼Œåªå¯¹å…¶ä»– Server çš„è¯·æ±‚åšå“åº”ï¼Œä¸ä¼šä¸»åŠ¨å‘èµ·è¯·æ±‚ã€‚å¦‚æœé€‰ä¸¾å®šæ—¶å™¨ï¼ˆelection timeoutï¼‰è¶…æ—¶å¹¶ä¸”æ²¡æœ‰æ”¶åˆ° Leader ä»»ä½•æ¶ˆæ¯ï¼Œå°±ä¼šè½¬å˜ä¸º Candidatesï¼Œå‘èµ·é€‰ä¸¾è¯·æ±‚ã€‚</p>
<p><strong>Candidate</strong>ï¼šå€™é€‰èŠ‚ç‚¹ï¼Œåªå­˜åœ¨äºé€‰ä¸¾é˜¶æ®µã€‚é€‰ä¸¾è·å¾—å¤šæ•°ç¥¨å°±ä¼šè½¬æ¢ä¸º Leaderã€‚å¦‚æœå‘ç°å·²ç»æœ‰äº† Leader æˆ–è€…è‡ªå·±çš„ Term è¿‡æ—¶å°±ä¼šé‡æ–°è½¬æ¢ä¸º Followerã€‚</p>
<p><strong>Leader</strong>ï¼šä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£å“åº”å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚ã€‚å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚åˆ°äº† Followerï¼Œä¹Ÿä¼šå°†è¯·æ±‚è½¬åˆ° Leader ä¸Šã€‚Leader å¦‚æœå‘ç°è‡ªå·±çš„ Term è¿‡æ—¶å°±ä¼šé‡æ–°è½¬æ¢ä¸º Followerã€‚</p>
<p><img src="https://static.imlgw.top/blog/20220601221351.png" alt="Raft è®ºæ–‡"></p>
<p>Raft ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ª Leaderï¼Œä½¿ç”¨ Term æ¥åŒºåˆ†å¤šä¸ª Leaderï¼ŒRaft ä¿è¯æ¯ä¸ª Term <strong>æœ€å¤š</strong>åªæœ‰ä¸€ä¸ª Leaderï¼Œå¦‚æœé€‰ç¥¨æ¯”è¾ƒåˆ†æ•£ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ Leaderï¼ˆt3ï¼‰ï¼Œåˆ™ç›´æ¥è¿›å…¥ä¸‹ä¸€è½®é€‰ä¸¾ã€‚</p>
<p>Term å¯ä»¥çœ‹ä½œ Raft ä¸­çš„é€»è¾‘æ—¶é—´ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜æœ‰å½“å‰ Term ç¼–å·ã€‚èŠ‚ç‚¹å¯ä»¥é€šè¿‡ Term æ¥æ£€æŸ¥è¿‡æœŸçš„æ¶ˆæ¯ï¼Œå¯¹é½å„ä¸ªèŠ‚ç‚¹è¿›åº¦ã€‚å½“èŠ‚ç‚¹è¿›è¡Œé€šä¿¡çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶ä»–èŠ‚ç‚¹çš„ Term æ¯”è‡ªå·±å¤§ï¼Œå°±ä¼šå°†å½“å‰èŠ‚ç‚¹ Term æ›´æ–°ä¸ºè¾ƒå¤§çš„ Termï¼Œå¦‚æœèŠ‚ç‚¹æ˜¯ Leader æˆ–è€… Candidates åˆ™ä¼šè¿›å…¥ Follower çŠ¶æ€ã€‚å¦‚æœèŠ‚ç‚¹ Term æ¯”è‡ªå·±å°ï¼Œåˆ™ä¼šç›´æ¥å¿½ç•¥æ‰ã€‚</p>
<p><img src="https://static.imlgw.top/blog/20220605205548.png"></p>
<h2 id="Raft-è§„èŒƒ"><a href="#Raft-è§„èŒƒ" class="headerlink" title="Raft è§„èŒƒ"></a>Raft è§„èŒƒ</h2><ol>
<li><strong>Election Safety</strong>ï¼šåœ¨ä¸€ä¸ªä»»æœŸå†…ï¼Œæœ€å¤šå¯ä»¥é€‰å‡ºä¸€ä¸ª Leader</li>
<li><strong>Leader Append-Only</strong>ï¼šLeader ä¸ä¼šè¦†ç›–æˆ–è€…åˆ é™¤è‡ªå·±çš„ logï¼Œåªä¼šè¿½åŠ </li>
<li><strong>Log Matching</strong>ï¼šå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç›¸åŒçš„ log index å’Œ termï¼Œåˆ™å®ƒä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—ä¹Ÿä¸€å®šç›¸åŒã€‚</li>
<li><strong>Leader Completeness</strong>ï¼šå¦‚æœæŸæ¡æ—¥å¿—åœ¨æŸä¸€ä»»æœŸè¢«æäº¤äº†ï¼Œé‚£ä¹ˆè¯¥æ—¥å¿—ä¸€å®šä¼šå‡ºç°åœ¨æ‰€æœ‰æ›´é«˜ä»»æœŸçš„ Leader æ—¥å¿—ä¸­ã€‚</li>
<li><strong>State Machine Safety</strong>ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡å™¨åœ¨å…¶çŠ¶æ€æœºä¸Šåº”ç”¨äº†ä¸€ä¸ªç»™å®šç´¢å¼•çš„æ—¥å¿—æ¡ç›®ï¼Œé‚£ä¹ˆæ²¡æœ‰å…¶ä»–æœåŠ¡å™¨ä¼šåœ¨åŒä¸€ç´¢å¼•ä¸Šåº”ç”¨ä¸€ä¸ªä¸åŒçš„æ—¥å¿—æ¡ç›®</li>
</ol>
<h2 id="Raft-é€‰ä¸»"><a href="#Raft-é€‰ä¸»" class="headerlink" title="Raft é€‰ä¸»"></a>Raft é€‰ä¸»</h2><p>Raft ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘é¢†å¯¼é€‰ä¸¾ã€‚ä¸€å¼€å§‹æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ Followerï¼Œåªè¦èƒ½æ”¶åˆ° Leader çš„å¿ƒè·³ä¿¡æ¯æˆ–è€… Candidate çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œå°±ä¼šä¸€ç›´å¤„äº Follower çŠ¶æ€ã€‚</p>
<p>å¦‚æœé€‰ä¸¾å®šæ—¶å™¨è¶…æ—¶äº† Follower è¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°ä»»ä½•ä¿¡æ¯ï¼Œå°±è®¤ä¸º Leader å·²ç»æŒ‚äº†ï¼Œéšå³è¿›å…¥é€‰ä¸¾é˜¶æ®µï¼Œå¢åŠ è‡ªå·±çš„ Termï¼Œè¿›å…¥ Candidate çŠ¶æ€ï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘é€ RequestVoteã€‚</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> leaderElection() &#123;</span><br><span class="line">    <span class="comment">// å¢åŠ  Term</span></span><br><span class="line">    rf.currentTerm++</span><br><span class="line">    <span class="comment">// å˜ä¸º Candidate çŠ¶æ€</span></span><br><span class="line">    rf.state = Candidate</span><br><span class="line">    rf.votedFor = rf.me</span><br><span class="line">    rf.persist()</span><br><span class="line">    rf.resetElectionTimer()</span><br><span class="line">    term := rf.currentTerm</span><br><span class="line">    <span class="comment">// è·å¾—é€‰ç¥¨æ€»æ•°ï¼Œé¦–å…ˆæŠ•ç»™è‡ªå·±</span></span><br><span class="line">    voteCounter := <span class="number">1</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æœ€åä¸€æ¡ log</span></span><br><span class="line">    lastLog := rf.log.lastLog()</span><br><span class="line">    args := RequestVoteArgs&#123;</span><br><span class="line">        Term:         term,</span><br><span class="line">        CandidateId:  rf.me,</span><br><span class="line">        LastLogIndex: lastLog.Index,</span><br><span class="line">        LastLogTerm:  lastLog.Term,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> becomeLeader sync.Once</span><br><span class="line">    <span class="keyword">for</span> serverId, _ := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">        <span class="keyword">if</span> serverId != rf.me &#123;</span><br><span class="line">            <span class="comment">// å‘é€ RequestVote</span></span><br><span class="line">            <span class="keyword">go</span> rf.candidateRequestVote(serverId, &amp;args, &amp;voteCounter, &amp;becomeLeader)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘èµ·æŠ•ç¥¨åä¼šå‘ç”Ÿä¸‹åˆ—ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>è·å¾—äº†å¤šæ•°ç¥¨ï¼Œæˆä¸ºæ–°çš„ Leader</li>
<li>å…¶ä»–èŠ‚ç‚¹å·²ç»æˆä¸ºäº† Leaderï¼Œæ”¶åˆ°äº†æ–° Leader çš„å¿ƒè·³ä¿¡æ¯ï¼Œä¸” Term å¤§äºè‡ªå·±</li>
<li>é€‰ä¸¾å¤±è´¥ï¼Œç¥¨æ•°åˆ†æ•£ï¼Œæ²¡æœ‰ Leader äº§ç”Ÿ</li>
</ol>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> candidateRequestVote(serverId <span class="type">int</span>, args *RequestVoteArgs,    voteCounter *<span class="type">int</span>, becomeLeader *sync.Once) &#123;</span><br><span class="line">    reply := RequestVoteReply&#123;&#125;</span><br><span class="line">    <span class="comment">// å¹¶å‘çš„å‘èµ· rpc æŠ•ç¥¨è¯·æ±‚</span></span><br><span class="line">    ok := rf.sendRequestVote(serverId, args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒæ­¥çš„å¤„ç†æŠ•ç¥¨ç»“æœ</span></span><br><span class="line">    rf.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">    <span class="comment">// å­˜åœ¨æ›´æ–°çš„ Termï¼Œé€‰ä¸¾æ— æ•ˆï¼Œæ›´æ–° Termï¼Œè½¬æ¢ä¸º Follower</span></span><br><span class="line">    <span class="keyword">if</span> reply.Term &gt; args.Term &#123;</span><br><span class="line">        rf.setNewTerm(reply.Term)</span><br><span class="line">        rf.setState(Follower)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !reply.VoteGranted &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¶åˆ° Follower æŠ•ç¥¨</span></span><br><span class="line">    *voteCounter++</span><br><span class="line">    <span class="keyword">if</span> *voteCounter &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &amp;&amp;</span><br><span class="line">        rf.currentTerm == args.Term &amp;&amp;</span><br><span class="line">        rf.state == Candidate &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾—åŠæ•°ä»¥ä¸Šé€‰ç¥¨ï¼Œä¸”èŠ‚ç‚¹çŠ¶æ€æ²¡å˜ï¼Œè½¬æ¢ä¸º Leader</span></span><br><span class="line">        becomeLeader.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            rf.state = Leader</span><br><span class="line">            lastLogIndex := rf.log.lastLog().Index</span><br><span class="line">            <span class="keyword">for</span> i, _ := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">                rf.nextIndex[i] = lastLogIndex + <span class="number">1</span></span><br><span class="line">                rf.matchIndex[i] = <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">            rf.appendEntries(<span class="literal">true</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“èŠ‚ç‚¹æ”¶åˆ° RequestVote RPC åä¼šæ ¹æ® Term å’Œ Log è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¦æŠ•ç¥¨ã€‚</p>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªé€‰ä¸»çš„é™åˆ¶äº†ï¼ŒRaft ä¸­å¹¶éæ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½æˆä¸º Leaderã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼šAã€Bã€C ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœ A ä¸ºä¸»èŠ‚ç‚¹æœŸé—´ C æŒ‚äº†ï¼Œæ­¤æ—¶æ¶ˆæ¯è¢«å¤šæ•°èŠ‚ç‚¹ï¼ˆAï¼ŒBï¼‰æ¥æ”¶ï¼Œæ‰€ä»¥ A ä¼šæäº¤è¿™äº›æ—¥å¿—ã€‚æ­¤æ—¶è‹¥ A æŒ‚äº†ï¼Œè€Œ C æ¢å¤ä¸”è¢«é€‰ä¸ºä¸»èŠ‚ç‚¹ï¼Œåˆ™ A å·²ç»æäº¤çš„æ—¥å¿—ä¼šè¢« C çš„æ—¥å¿—è¦†ç›–ï¼Œä»è€Œå¯¼è‡´çŠ¶æ€æœºçš„çŠ¶æ€ä¸ä¸€è‡´ã€‚</p>
<p>æ‰€ä»¥åœ¨ Raft ä¸­é™åˆ¶äº†ï¼Œåªæœ‰åŒ…å«äº†<strong>æ‰€æœ‰å·²ç»æäº¤æ—¥å¿—</strong>çš„èŠ‚ç‚¹ï¼Œæ‰èƒ½æˆä¸º Leaderã€‚</p>
<p>å‰é¢æåˆ°äº†æ—¥å¿—è¦æäº¤ï¼Œé¦–å…ˆéœ€è¦è¢«å¤šæ•°èŠ‚ç‚¹æ‰€æ¥å—ï¼ŒåŒæ—¶è¦æˆä¸º Leader ä¹Ÿéœ€è¦è·å¾—å¤šæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œæ‰€ä»¥ä¸¤è€…ä¹‹é—´å¿…ç„¶ä¼šæœ‰é‡å çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æŠ•ç¥¨çš„å¤šæ•°èŠ‚ç‚¹ä¸­<strong>è‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹</strong>æ˜¯åŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—çš„ã€‚æ¥ç€æˆ‘ä»¬ä»è¿™åŠæ•°èŠ‚ç‚¹ä¸­é€‰å‡ºä¸€ä¸ªâ€œæœ€æ–°â€çš„èŠ‚ç‚¹å‡ºæ¥ä½œä¸º Leaderï¼Œå°±ä¸€å®šæ˜¯åŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—çš„èŠ‚ç‚¹ã€‚</p>
<p>è¿™é‡Œçš„â€æœ€æ–°â€œæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹æœ€åä¸€æ¡ log çš„ Termï¼Œå¦‚æœ Term ä¸€æ ·ï¼Œå°±çœ‹ Term å†…æœ€åä¸€æ¡ logï¼Œè°æ›´å¤§è°å°±æ›´â€œæ–°â€</p>
<p>TODO: ç”»ä¾‹å­</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) &#123;</span><br><span class="line">    rf.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å€™é€‰èŠ‚ç‚¹ä»»æœŸå¤§äºå½“å‰èŠ‚ç‚¹ï¼Œå˜ä¸º Follower</span></span><br><span class="line">    <span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;</span><br><span class="line">        rf.setNewTerm(args.Term)</span><br><span class="line">        rf.setState(Follower)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å€™é€‰èŠ‚ç‚¹ä»»æœŸæ¯”å½“å‰èŠ‚ç‚¹å°ï¼Œå¿½ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> args.Term &lt; rf.currentTerm &#123;</span><br><span class="line">        reply.Term = rf.currentTerm</span><br><span class="line">        reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    myLastLog := rf.log.lastLog()</span><br><span class="line">    <span class="comment">// å€™é€‰èŠ‚ç‚¹æœ€åä¸€æ¡ log ä»»æœŸæ¯”å½“å‰èŠ‚ç‚¹å¤§</span></span><br><span class="line">    <span class="comment">// æˆ–è€…ä»»æœŸç›¸åŒï¼Œä½†æ˜¯å€™é€‰èŠ‚ç‚¹æœ€åä¸€æ¡ logIndex æ¯”å½“å‰èŠ‚ç‚¹å¤§ï¼Œè¯´æ˜å€™é€‰èŠ‚ç‚¹æ¯”æœ¬èŠ‚ç‚¹æ—¥å¿—æ–°</span></span><br><span class="line">    upToDate := args.LastLogTerm &gt; myLastLog.Term ||</span><br><span class="line">        (args.LastLogTerm == myLastLog.Term &amp;&amp; args.LastLogIndex &gt;= myLastLog.Index)</span><br><span class="line">    <span class="comment">// æ¯ä¸ªèŠ‚ç‚¹æ¯ä¸€è½®é€‰ä¸¾åªèƒ½æŠ•ç»™ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (rf.votedFor == <span class="number">-1</span> || rf.votedFor == args.CandidateId) &amp;&amp; upToDate &#123;</span><br><span class="line">        reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">        rf.votedFor = args.CandidateId</span><br><span class="line">        rf.persist()</span><br><span class="line">        rf.resetElectionTimer()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    reply.Term = rf.currentTerm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Raft-æ—¥å¿—å¤åˆ¶"><a href="#Raft-æ—¥å¿—å¤åˆ¶" class="headerlink" title="Raft æ—¥å¿—å¤åˆ¶"></a>Raft æ—¥å¿—å¤åˆ¶</h2><p>å½“èŠ‚ç‚¹è¢«é€‰ä¸º Leader åå°±å¼€å§‹å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½åŒ…å«äº†ä¸€ä¸ª<strong>å¤åˆ¶çŠ¶æ€æœº</strong>éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚Leader å°†å‘½ä»¤ä½œä¸ºä¸€ä¸ªæ–°çš„æ¡ç›®é™„åŠ åˆ°å®ƒçš„ Logs é˜Ÿåˆ—ä¸­ï¼Œç„¶åå‘é€ Append Entries RPCs ç»™å…¶ä»–èŠ‚ç‚¹ã€‚å½“ log è¢«å¤§å¤šæ•°èŠ‚ç‚¹å¤åˆ¶åï¼ŒLeader ä¼šå°† log æäº¤åˆ°çŠ¶æ€æœºï¼ŒåŒæ—¶ä¹Ÿä¼šå°†ä¹‹å‰ Term çš„ Leader åˆ›å»ºçš„ log æ¡ç›®æäº¤ï¼Œå¹¶å°†æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<blockquote>
<p>å¦‚æœ Follower å´©æºƒæˆ–è¿è¡Œç¼“æ…¢ï¼Œæˆ–è€…ç½‘ç»œæ•°æ®åŒ…ä¸¢å¤±ï¼ŒLeader ä¼šä¸€ç›´é‡è¯• Append Entries RPCsï¼ˆç”šè‡³åœ¨å®ƒå“åº”äº†å®¢æˆ·ç«¯ä¹‹åï¼‰ï¼Œç›´åˆ°æ‰€æœ‰ Follower æœ€ç»ˆå­˜å‚¨æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ã€‚</p>
</blockquote>
<p>ä½†æ˜¯åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„æ—¥å¿—å¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œä¸‹é¢çš„æƒ…å†µéƒ½æœ‰å¯èƒ½å‘ç”Ÿï¼š</p>
<p><img src="https://static.imlgw.top/blog/20220603225731.png" alt="Raft"></p>
<p>è¦å¤„ç†ä¸ä¸€è‡´é¦–å…ˆè¦æ‰¾åˆ°ä¸ä¸€è‡´çš„ä½ç½®ï¼ŒLeader ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤äº†ä¸€ä¸ª <code>nextIndex[peer]</code>ï¼Œ è¡¨ç¤º Leader å°†ä»å“ªé‡Œå¼€å§‹å‘é€ log ç»™ peerã€‚å½“ Leader ä¸Šå°çš„æ—¶å€™å°±ä¼šå°†æ‰€æœ‰èŠ‚ç‚¹çš„ nextIndex è®¾ç½®ä¸ºè‡ªå·±çš„ <code>lastLog.Index + 1</code>ã€‚</p>
<p>å½“ Leader å‘é€ Append Entries RPCs ç»™ Follower åï¼ŒFollower ä¼šè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ <code>nextIndex[peer]</code> å‰ä¸€æ¡ log çš„ Term å’Œ Index æ˜¯å¦å’Œå½“å‰èŠ‚ç‚¹ peer ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±ä¼šæ‹’ç»è¯¥æ¶ˆæ¯ï¼Œä¸€è‡´å°±ä¼šæ·»åŠ æ–° log åˆ°èŠ‚ç‚¹çš„æ—¥å¿—é˜Ÿåˆ—ä¸­ï¼Œ<code>nextIndex[peer]+1</code>ã€‚</p>
<p>å¦‚æœ Leader çš„æ¶ˆæ¯è¢« peer æ‹’ç»ï¼ŒLeader ä¼šä½¿ <code>nextIndex[peer]</code> é€’å‡ï¼Œç„¶åå†æ¬¡å‘é€ Append Entries RPCsï¼Œç›´åˆ°æ‰¾åˆ°ä¸€è‡´çš„ä½ç½®ï¼Œç„¶åç”¨ Leader çš„ <code>log[nextIndex, lastLog.Index]</code>ï¼Œè¦†ç›– Follower çš„ <code>log[nextIndex...]</code></p>
<p>é€šè¿‡ä¸Šé¢çš„æœºåˆ¶ Raft å°±èƒ½ä¿è¯ï¼š</p>
<ul>
<li>å¦‚æœä¸¤ä¸ªæ—¥å¿—æ¡ç›®æœ‰ç›¸åŒçš„ log index å’Œ termï¼Œåˆ™å®ƒä»¬çš„å†…å®¹ä¸€å®šç›¸åŒã€‚</li>
<li>å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¸­çš„ä¸¤ä¸ªæ¡ç›®æœ‰ç›¸åŒçš„ log index å’Œ termï¼Œåˆ™å®ƒä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—ä¸€å®šç›¸åŒã€‚</li>
</ul>
<p>Leader å‘é€ Append Entries RPCs</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> appendEntries() &#123;</span><br><span class="line">    lastLog := rf.log.lastLog()</span><br><span class="line">    <span class="keyword">for</span> peer, _ := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">        <span class="keyword">if</span> peer == rf.me &#123;</span><br><span class="line">            rf.resetElectionTimer()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä» nextIndex å¼€å§‹å‘é€</span></span><br><span class="line">        nextIndex := rf.nextIndex[peer]</span><br><span class="line">        <span class="keyword">if</span> nextIndex &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            nextIndex = <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸Šå›¾ï¼ˆRaft è®ºæ–‡ Figure7ï¼‰ä¸­çš„æƒ…å†µ cdfï¼ŒåŒ…å«é¢å¤–çš„æœªæäº¤çš„æ¡ç›®</span></span><br><span class="line">        <span class="comment">// ç›´æ¥å›é€€åˆ° lastLog.Index</span></span><br><span class="line">        <span class="keyword">if</span> lastLog.Index+<span class="number">1</span> &lt; nextIndex &#123;</span><br><span class="line">            nextIndex = lastLog.Index</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‰ä¸€æ¡ log çš„ index å’Œ Termï¼Œç”¨äº Follower æ ¡éªŒæ—¥å¿—æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">        prevLog := rf.log.at(nextIndex - <span class="number">1</span>)</span><br><span class="line">        args := AppendEntriesArgs&#123;</span><br><span class="line">            Term:         rf.currentTerm,</span><br><span class="line">            LeaderId:     rf.me,</span><br><span class="line">            PrevLogIndex: prevLog.Index,</span><br><span class="line">            PrevLogTerm:  prevLog.Term,</span><br><span class="line">            Entries:      <span class="built_in">make</span>([]Entry, lastLog.Index-nextIndex+<span class="number">1</span>),</span><br><span class="line">            <span class="comment">// ç›®å‰ Leader æäº¤åˆ°çŠ¶æ€æœºçš„ logIndex</span></span><br><span class="line">            LeaderCommit: rf.commitIndex,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‘é€ [nextIndex, lastLog.Index]</span></span><br><span class="line">        <span class="built_in">copy</span>(args.Entries, rf.log.slice(nextIndex))</span><br><span class="line">        <span class="keyword">go</span> rf.leaderSendEntries(peer, &amp;args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¿«é€Ÿæ¢å¤ï¼ˆFast-Backupï¼‰"><a href="#å¿«é€Ÿæ¢å¤ï¼ˆFast-Backupï¼‰" class="headerlink" title="å¿«é€Ÿæ¢å¤ï¼ˆFast Backupï¼‰"></a>å¿«é€Ÿæ¢å¤ï¼ˆFast Backupï¼‰</h3><p>raft è®ºæ–‡ä¸­æ—¥å¿—å›é€€æ˜¯ä¸€æ¡ä¸€æ¡å›é€€çš„ï¼Œå¦‚æœ Follower æ‰çº¿æ—¶é—´è¿‡é•¿ï¼Œä¸€æ¡æ¡å›é€€ä¼šç‰¹åˆ«æ…¢ï¼ŒåŸæ–‡ä¸­æœ‰æåˆ°ä¼˜åŒ–æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰ç»†è¯´</p>
<blockquote>
<p>If desired, the protocol can be optimized to reduce the number of rejected AppendEntries RPCs. For example, when rejecting an AppendEntries request, the follower can include the term of the conflicting entry and the first index it stores for that term. With this information, the leader can decrement nextIndex to bypass all of the conflictingÂ entries in that term; one AppendEntries RPC will be required for each term with conflicting entries, rather than one RPC per entry. In practice, we doubt this optimizationÂ is necessary, since failures happen infrequently and it is unlikely that there will be many inconsistent entries.</p>
</blockquote>
<blockquote>
<p>å¦‚æœéœ€è¦ï¼Œè¯¥åè®®å¯ä»¥è¢«ä¼˜åŒ–ä»¥å‡å°‘è¢«æ‹’ç»çš„ AppendEntries RPC çš„æ•°é‡ã€‚ä¾‹å¦‚ï¼Œå½“æ‹’ç»ä¸€ä¸ª AppendEntries è¯·æ±‚æ—¶ï¼Œè·Ÿéšè€…å¯ä»¥åŒ…æ‹¬å†²çªæ¡ç›®çš„ä»»æœŸå’Œå®ƒä¸ºè¯¥ä»»æœŸå­˜å‚¨çš„ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œé¢†å¯¼è€…å¯ä»¥é€’å‡ nextIndex ä»¥ç»•è¿‡è¯¥ä»»æœŸä¸­çš„æ‰€æœ‰å†²çªæ¡ç›®ï¼›æ¯ä¸ªæœ‰å†²çªæ¡ç›®çš„ä»»æœŸå°†éœ€è¦ä¸€ä¸ª AppendEntries RPCï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ¡ç›®ä¸€ä¸ª RPCã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬æ€€ç–‘è¿™ç§ä¼˜åŒ–æ˜¯å¦æœ‰å¿…è¦ï¼Œå› ä¸ºæ•…éšœä¸å¸¸å‘ç”Ÿï¼Œè€Œä¸”ä¸å¤ªå¯èƒ½æœ‰å¾ˆå¤šä¸ä¸€è‡´çš„æ¡ç›®ã€‚</p>
</blockquote>
<p>mit6.824 ä¸­ Morris æåˆ°äº†ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼š</p>
<p>åœ¨ Follower å›å¤ Leader çš„ AppendEntriesReply ä¸­æ·»åŠ å‡ ä¸ªå­—æ®µ</p>
<ul>
<li><strong>XTerm</strong>: å†²çªçš„ Termï¼ŒFollower æ‹’ç» Leader åä¼šå°† XTerm è®¾ç½®ä¸ºè‡ªå·±çš„ Termï¼Œå¦‚æœ Follower æ—¥å¿—è¾ƒå°‘ï¼Œå¯¹åº”ä½ç½®æ²¡æœ‰ logï¼Œè®¾ç½® XTerm ä¸º -1</li>
<li><strong>XIndex</strong>: XTerm çš„ç¬¬ä¸€æ¡ log çš„ index</li>
<li><strong>XLen</strong>: Follower æ—¥å¿—è¾ƒå°‘ï¼ŒXTerm = -1 æ—¶ï¼Œlog æ—¥å¿—é•¿åº¦+1ï¼ŒLeader ä¸‹æ¬¡å°±ä» Xlen å¼€å§‹å‘</li>
</ul>
<p>Follower æ”¶åˆ°æ¶ˆæ¯åå¯¹åº”å¤„ç†</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) &#123;</span><br><span class="line">    rf.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">    reply.Success = <span class="literal">false</span></span><br><span class="line">    reply.Term = rf.currentTerm</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼ŒLeader çš„ Term æ¯”è‡ªå·±å°</span></span><br><span class="line">    <span class="keyword">if</span> args.Term &lt; rf.currentTerm &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯”è‡ªå·±ä»»æœŸå¤§ï¼Œæ›´æ–°ä»»æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;</span><br><span class="line">        rf.setNewTerm(args.Term)</span><br><span class="line">        rf.setState(Follower)</span><br><span class="line">        reply.Term = args.Term</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç½® Election å®šæ—¶å™¨</span></span><br><span class="line">    rf.resetElectionTimer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Candidate æ”¶åˆ°äº† AppendEntries è¯·æ±‚ï¼Œè½¬æ¢ä¸º Follower</span></span><br><span class="line">    <span class="keyword">if</span> rf.state == Candidate &#123;</span><br><span class="line">        rf.setState(Follower)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Follower æ—¥å¿—è¾ƒå°‘ï¼ŒPre å¤„æ²¡æœ‰ log</span></span><br><span class="line">    <span class="keyword">if</span> rf.log.lastLog().Index &lt; args.PrevLogIndex &#123;</span><br><span class="line">        reply.XTerm = <span class="number">-1</span></span><br><span class="line">        reply.XIndex = <span class="number">-1</span></span><br><span class="line">        reply.XLen = rf.log.<span class="built_in">len</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pre å¤„æœ‰ log ä½†æ˜¯ Term ä¸ä¸€æ ·</span></span><br><span class="line">    <span class="keyword">if</span> rf.log.at(args.PrevLogIndex).Term != args.PrevLogTerm &#123;</span><br><span class="line">        <span class="comment">// è·å– Follower å†²çªä½ç½®çš„ Term</span></span><br><span class="line">        xTerm := rf.log.at(args.PrevLogIndex).Term</span><br><span class="line">        <span class="keyword">for</span> xIndex := args.PrevLogIndex; xIndex &gt; <span class="number">0</span>; xIndex-- &#123;</span><br><span class="line">            <span class="comment">// XTerm ç¬¬ä¸€æ¡ log çš„ index</span></span><br><span class="line">            <span class="keyword">if</span> rf.log.at(xIndex<span class="number">-1</span>).Term != xTerm &#123;</span><br><span class="line">                reply.XIndex = xIndex</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        reply.XTerm = xTerm</span><br><span class="line">        reply.XLen = rf.log.<span class="built_in">len</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ¹é…ä¸Šäº†</span></span><br><span class="line">    <span class="keyword">for</span> idx, entry := <span class="keyword">range</span> args.Entries &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ entry.Index è‚¯å®šæ˜¯å¤§äº lastLog.Index çš„</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå°äºç­‰äºï¼Œä¸”ä»»æœŸä¸ä¸€è‡´ï¼Œè¯´æ˜ Follower æœ‰é¢å¤–çš„æœªæäº¤çš„æ—¥å¿—ï¼Œéœ€è¦è¦†ç›–æ‰</span></span><br><span class="line">        <span class="keyword">if</span> entry.Index &lt;= rf.log.lastLog().Index &amp;&amp; rf.log.at(entry.Index).Term != entry.Term &#123;</span><br><span class="line">            <span class="comment">// æˆªæ–­ Index åçš„æ—¥å¿—</span></span><br><span class="line">            rf.log.truncate(entry.Index)</span><br><span class="line">            rf.persist()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Follower å¤åˆ¶ log</span></span><br><span class="line">        <span class="keyword">if</span> entry.Index &gt; rf.log.lastLog().Index &#123;</span><br><span class="line">            rf.log.<span class="built_in">append</span>(args.Entries[idx:]...)</span><br><span class="line">            rf.persist()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰èŠ‚ç‚¹æäº¤è¿›åº¦</span></span><br><span class="line">    <span class="keyword">if</span> args.LeaderCommit &gt; rf.commitIndex &#123;</span><br><span class="line">        rf.commitIndex = min(args.LeaderCommit, rf.log.lastLog().Index)</span><br><span class="line">        <span class="comment">// åº”ç”¨åˆ°çŠ¶æ€æœº</span></span><br><span class="line">        rf.apply()</span><br><span class="line">    &#125;</span><br><span class="line">    reply.Success = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Leader æ”¶åˆ°å›å¤åå°±å¯ä»¥é’ˆå¯¹ä¸åŒæƒ…å†µï¼Œå¿«é€Ÿå›æ»š</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> leaderSendEntries(serverId <span class="type">int</span>, args *AppendEntriesArgs) &#123;</span><br><span class="line">    <span class="keyword">var</span> reply AppendEntriesReply</span><br><span class="line">    ok := rf.sendAppendEntries(serverId, args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”ï¼ŒåŒæ­¥å¤„ç†ç»“æœ</span></span><br><span class="line">    rf.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">    <span class="comment">// è¿”å›çš„ Term æ¯” Leader å¤§ï¼Œå½“å‰ Leader èŠ‚ç‚¹è¿‡æ—¶äº†</span></span><br><span class="line">    <span class="comment">// æ›´æ–° Term è½¬æ¢ä¸º Follower</span></span><br><span class="line">    <span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">        rf.setNewTerm(reply.Term)</span><br><span class="line">        rf.setState(Follower)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘é€åˆ°æ¥æ”¶éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œç¡®è®¤çŠ¶æ€ï¼Œç¡®è®¤è¿˜æ˜¯åœ¨è‡ªå·±çš„ä»»æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> args.Term == rf.currentTerm &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å†²çªï¼Œæ ¡éªŒæˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> reply.Success &#123;</span><br><span class="line">            <span class="comment">// å·²çŸ¥çš„ Follower å¤åˆ¶åˆ°çš„ä½ç½®</span></span><br><span class="line">            match := args.PrevLogIndex + <span class="built_in">len</span>(args.Entries)</span><br><span class="line">            next := match + <span class="number">1</span></span><br><span class="line">            rf.nextIndex[serverId] = max(rf.nextIndex[serverId], next)</span><br><span class="line">            rf.matchIndex[serverId] = max(rf.matchIndex[serverId], match)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> reply.XTerm == <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="comment">// æœ‰å†²çªï¼Œä¸” Follower æ—¥å¿—å°‘ï¼Œä¸‹ä¸€æ¬¡ä» XLen å¼€å§‹</span></span><br><span class="line">                <span class="comment">// i: 1    2    3   4   5</span></span><br><span class="line">                <span class="comment">//        XLen</span></span><br><span class="line">                <span class="comment">// F: 4  </span></span><br><span class="line">                <span class="comment">// L: 4    6    6   6</span></span><br><span class="line">                <span class="comment">//             Pre     Next</span></span><br><span class="line">                rf.nextIndex[serverId] = reply.XLen</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰¾åˆ° Leader ä¸­ XTerm ä¸­åä¸€æ¡æ—¥å¿—çš„ Indexï¼Œä»è¿™æ¡å†å¼€å§‹</span></span><br><span class="line">                lastLogInXTerm := rf.findNextLogInTerm(reply.XTerm)</span><br><span class="line">                <span class="keyword">if</span> lastLogInXTerm &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// i: 1    2    3    4    5</span></span><br><span class="line">                    <span class="comment">// F: 4    4    4</span></span><br><span class="line">                    <span class="comment">// L: 4    6    6    6</span></span><br><span class="line">                    <span class="comment">//       Last  Pre       Next</span></span><br><span class="line">                    rf.nextIndex[serverId] = lastLogInXTerm</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Leader æ²¡æœ‰ XTerm ç›´æ¥ä» XIndex å¼€å§‹</span></span><br><span class="line">                    <span class="comment">// i: 1    2    3    4    5</span></span><br><span class="line">                    <span class="comment">//      XIndex</span></span><br><span class="line">                    <span class="comment">// F: 4    5    5</span></span><br><span class="line">                    <span class="comment">// L: 4    6    6   6</span></span><br><span class="line">                    <span class="comment">//             Pre      Next</span></span><br><span class="line">                    rf.nextIndex[serverId] = reply.XIndex</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æäº¤ log</span></span><br><span class="line">        rf.leaderCommit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Leader æœ€ç»ˆæäº¤ log</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> leaderCommit() &#123;</span><br><span class="line">    <span class="comment">// ç¡®è®¤çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> rf.state != Leader &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»ä¸Šæ¬¡ commitIndex å¼€å§‹æäº¤</span></span><br><span class="line">    <span class="keyword">for</span> n := rf.commitIndex + <span class="number">1</span>; n &lt;= rf.log.lastLog().Index; n++ &#123;</span><br><span class="line">        <span class="comment">// åªå…³å¿ƒè‡ªå·±ä»»æœŸå†…çš„ log æ˜¯å¦å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// å½“å‰ä»»æœŸå†…æ—¥å¿—çš„æäº¤åï¼Œä¸Šä¸€ä»»çš„é—´æ¥çš„ä¹Ÿå°±æäº¤äº†</span></span><br><span class="line">        <span class="keyword">if</span> rf.log.at(n).Term != rf.currentTerm &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        counter := <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> serverId := <span class="number">0</span>; serverId &lt; <span class="built_in">len</span>(rf.peers); serverId++ &#123;</span><br><span class="line">            <span class="comment">// follower å·²ç»å¤åˆ¶çš„ Index &gt;= n</span></span><br><span class="line">            <span class="keyword">if</span> serverId != rf.me &amp;&amp; rf.matchIndex[serverId] &gt;= n &#123;</span><br><span class="line">                counter++</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¶…è¿‡åŠæ•°å·²ç»å¤åˆ¶äº† log[n]</span></span><br><span class="line">            <span class="keyword">if</span> counter &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">                <span class="comment">// æäº¤æ—¥å¿—ï¼Œå¹¶ä¸”åº”ç”¨åˆ°çŠ¶æ€æœº</span></span><br><span class="line">                rf.commitIndex = n</span><br><span class="line">                rf.apply()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Raft-å“åº”"><a href="#Raft-å“åº”" class="headerlink" title="Raft å“åº”"></a>Raft å“åº”</h2><p>Raft Startï¼Œåªèƒ½ç”± Leader å“åº”ï¼Œæ¥æ”¶ä¸€ä¸ª commandï¼Œæ·»åŠ åˆ° Leader æ—¥å¿—é˜Ÿåˆ—ä¸­ã€‚ç„¶åç­‰å¾…ä¸‹ä¸€æ¬¡ AppendEntries è¿›è€ŒåŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ Start åç›´æ¥å‘é€ AppendEntriesï¼Œä½†æ˜¯å¦‚æœ Start å¤ªé¢‘ç¹å¯èƒ½ä¼šé€ æˆ RPC é¢‘ç¹ï¼Œéœ€è¦æ ¹æ®ä¸åŒåœºæ™¯è¿›è¡Œè°ƒæ•´ï¼Œè®ºæ–‡ä¸­ä¹Ÿå¹¶æ²¡æœ‰æ˜ç¡®è¯´æ˜ã€‚</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> Start(command <span class="keyword">interface</span>&#123;&#125;) (<span class="type">int</span>, <span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line">    rf.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> rf.state != Leader &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>, rf.currentTerm, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    index := rf.log.lastLog().Index + <span class="number">1</span></span><br><span class="line">    term := rf.currentTerm</span><br><span class="line"></span><br><span class="line">    log := Entry&#123;</span><br><span class="line">        Command: command,</span><br><span class="line">        Index:   index,</span><br><span class="line">        Term:    term,</span><br><span class="line">    &#125;</span><br><span class="line">    rf.log.<span class="built_in">append</span>(log)</span><br><span class="line">    rf.persist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> index, term, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Raft-æŒä¹…åŒ–"><a href="#Raft-æŒä¹…åŒ–" class="headerlink" title="Raft æŒä¹…åŒ–"></a>Raft æŒä¹…åŒ–</h2><p>æŒä¹…åŒ–æ˜¯ä¸ºäº†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½“æœåŠ¡å™¨æ•…éšœé‡å¯æ—¶ï¼Œèƒ½ç»§ç»­ä¹‹å‰çš„çŠ¶æ€ï¼Œé¿å…ä¸¢å¤±æ•°æ®ã€‚</p>
<p>åœ¨ Raft è®ºæ–‡ä¸­ï¼Œæ ‡è¯†äº† currentTermã€voteForã€logs æ˜¯éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ã€‚</p>
<p>logs éœ€è¦è¢«æŒä¹…åŒ–å¾ˆå¥½ç†è§£ï¼Œè¿™æ˜¯å”¯ä¸€è®°å½•äº†åº”ç”¨ç¨‹åºçŠ¶æ€çš„åœ°æ–¹ï¼Œè€Œ voteFor å’Œ currentTerm éœ€è¦è¢«æŒä¹…åŒ–çš„åŸå› éƒ½æ˜¯ä¸ºäº†é¿å…ä¸€ä¸ª Term å‡ºç°ä¸¤ä¸ª Leaderã€‚å‡è®¾ä¸€ä¸ªèŠ‚ç‚¹åˆšç»™ä¸€ä¸ªå€™é€‰äººæŠ•äº†ç¥¨ï¼Œç»“æœè‡ªå·± down äº†ï¼Œç„¶åé‡å¯åå‘ç°è‡ªå·± voteFor æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±è¿˜å¯èƒ½ç»™å…¶ä»–å€™é€‰äººæŠ•ç¥¨ï¼Œå°±è¿èƒŒäº†ä¸€ä¸ªèŠ‚ç‚¹ä¸€ä¸ªä»»æœŸåªèƒ½æŠ•ä¸€å¼ ç¥¨çš„åŸåˆ™ã€‚currentTerm ä¹Ÿç±»ä¼¼ï¼Œå¦‚æœèŠ‚ç‚¹é‡å¯åä¸çŸ¥é“å½“å‰çš„ä»»æœŸï¼Œå°±å¯èƒ½ä»ä¸€ä¸ªå†å²çš„ä»»æœŸå¼€å§‹å·¥ä½œï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªä»»æœŸå¤šä¸ª Leaderã€‚</p>
<h2 id="Raft-æ—¥å¿—å¿«ç…§"><a href="#Raft-æ—¥å¿—å¿«ç…§" class="headerlink" title="Raft æ—¥å¿—å¿«ç…§"></a>Raft æ—¥å¿—å¿«ç…§</h2><h2 id="Raft-æˆå‘˜å˜æ›´"><a href="#Raft-æˆå‘˜å˜æ›´" class="headerlink" title="Raft æˆå‘˜å˜æ›´"></a>Raft æˆå‘˜å˜æ›´</h2>
        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">èµèµ</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/imlgw">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://imlgw.top">Tadow</a></span>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/publish/query/indexFirst.action">é„‚ICPå¤‡18011208å·</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
  data-repo="imlgw/imlgw.github.io"
  data-repo-id="MDEwOlJlcG9zaXRvcnkxMzMyMDY4NDg="
  data-category="Announcements"
  data-category-id="DIC_kwDOB_CTQM4CQ7v8"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>



</html>
